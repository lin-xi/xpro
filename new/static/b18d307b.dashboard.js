function getParam(){for(var a=window.location.search.substr(1),b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("=");c[e[0]]=e[1]}return c}function isSystemFields(a){for(var b=0;b<SYSTEM_FIELDS.length;b++)if(SYSTEM_FIELDS[b]==a)return!0;return!1}function isSystemClass(a){return $.inArray(a,["_File","_Installation","_Notification","_Role","_User"])}function convertToType(a,b){var c={};switch(b){case"Number":isNaN(a)||(c={type:"Number",val:Number(a)});break;case"Boolean":c={type:"Boolean",val:a&&"false"!=a?!0:!1};break;case"Date":a&&""!=a&&"null"!=a?moment(a).isValid()&&(c={type:"Date",val:moment.utc(a).toDate()}):c={type:"Date",val:null};break;case"Array":try{a&&""!=a&&"null"!=a?$.isArray(JSON.parse(a))&&(c={type:"Array",val:JSON.parse(a)}):c={type:"Array",val:null}}catch(d){c={}}break;case"Object":if(a&&""!=a&&"null"!=a)try{c={type:"Object",val:JSON.parse(a)}}catch(d){c={}}else c={type:"Object",val:null};break;case"ACL":if(a&&""!=a&&"null"!=a){if("string"!=typeof a)return c={type:"ACL",val:a};try{c={type:"ACL",val:new AV.ACL(JSON.parse(a))}}catch(d){c={}}}else c={type:"ACL",val:null};break;case"GeoPoint":var e=a.split(",");if(e[0]&&parseInt(e[0])<=180&&parseInt(e[0])>=-180){if(e[1]&&parseInt(e[1])<=90&&parseInt(e[1])>=-90){var f=new AV.GeoPoint({latitude:Number(e[1]),longitude:Number(e[0])});c={type:"GeoPoint",val:f}}}else{var f=new AV.GeoPoint({latitude:0,longitude:0});c={}}break;default:c={type:"String",val:a}}return c}function validateEmail(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}function showmsg(a,b){hidemsg();var c=5e3;b=b||"success",b&&"error"==b&&(c=2*c),a=a||"操作成功",$("#msg_tip_wrapper").removeClass("success"),$("#msg_tip_wrapper").removeClass("error"),$("#msg_tip_wrapper").addClass(b),$("#msg_tip").length?($("#msg_tip").html(a),$("#msg_tip_wrapper").slideDown(200),clearTimeout(showmsg.t),showmsg.t=setTimeout(function(){$("#msg_tip_wrapper").slideUp(200),$("#msg_tip").text()},c)):($("#msg_tip").text(a),$("#msg_tip_wrapper").slideDown(200),clearTimeout(showmsg.t),showmsg.t=setTimeout(function(){$("#msg_tip_wrapper").slideUp(200),$("#msg_tip").text()},c)),$("#msg_tip_wrapper").click(function(){hidemsg()})}function hidemsg(){showmsg.t&&clearTimeout(showmsg.t),$("#msg_tip_wrapper").slideUp(200),$("#msg_tip").text()}function getKeys(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function secondFormat(a){if(!a||0>=a)return"00:00:00";var b=parseInt(a/3600),c=parseInt((a-3600*b)/60),d=a%60;return 10>d&&(d="0"+d),10>b&&(b="0"+b),10>c&&(c="0"+c),b+":"+c+":"+d}function bytesToSize(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Byte";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]}function getDaysBetweenDate(a,b){var c=moment(b).valueOf()-moment(a).valueOf();return parseInt(c/864e5)}function htmlEntities(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function getApiRequestHeader(a,b){return{"X-AVOSCloud-Application-Id":a,"X-AVOSCloud-Application-Key":b}}function getChartOption(){var a={chart:{type:"areaspline"},title:{x:0},yAxis:{allowDecimals:!1,min:0,gridLineColor:"#f4f1f1",title:{text:""},labels:{overflow:"justify"}},xAxis:{labels:{overflow:"justify"},tickPixelInterval:200},tooltip:{},plotOptions:{areaspline:{fillOpacity:.4}},credits:{enabled:!1},series:[{data:[]}]};return a}function downloadURL(a){var b="hiddenDownloader",c=document.getElementById(b);null===c&&(c=document.createElement("iframe"),c.id=b,c.style.display="none",document.body.appendChild(c)),c.src=a}function syntaxHighlight(a){return"string"!=typeof a&&(a=JSON.stringify(a,void 0,2)),a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(a){var b="number";return/^"/.test(a)?b=/:$/.test(a)?"key":"string":/true|false/.test(a)?b="boolean":/null/.test(a)&&(b="null"),'<span class="'+b+'">'+a+"</span>"})}var ENV={WEBHOST:"@@webhost"};AVC={},AVC.Error="error",AVC.AuthDesc={stats:"分析",storage:"存储",message:"消息",component:"组件",setting:"设置"},AVC.AuthPages=["stat.html","data.html","messaging.html","cloud.html","apistat.html","devcomponent.html","app.html"],AVC.AuthMap={storage:["data.html","apistat.html","cloud.html","dataquery.html"],stats:"stat.html",setting:"app.html",message:"messaging.html",component:"devcomponent.html"};var purl="/1/",appurl=purl+"clients/self/apps/"+getParam().appid,cloudURL="/1/",rootpage="applist.html",SYSTEM_FIELDS=["objectId","updatedAt","createdAt"],CTYPES=["String","Number","Boolean","Date","File","Array","Object","GeoPoint","Pointer","Relation","Any"],QUERYS={String:["equals","does not equal","start with","exists","does not exist"],Number:["equals","does not equal","less than","greater than","less than or equal to","greater than or equal to","exists","does not exist"],Array:["contains string","does not contain string","contains number","does not contain number","exists","does not exist"],Boolean:["equals","exists","does not exist"],Date:["before","after","exists","does not exist"],Pointer:["equals","does not equal","exists","does not exist"]},PUSH_QUERYS={String:["equals","does not equal","start with","exists","does not exist"],Number:["equals","does not equal","less than","greater than","less than or equal to","greater than or equal to","exists","does not exist"],Array:["equals","does not    equal"],Boolean:["equals","exists","does not exist"],Date:["before","after","exists","does not exist"]},MANGOQUERY={exists:"$exists","does not exist":"$exists","less than":"$lt","less than or equal to":"$lte","greater than":"$gt","does not contain string":"$ne","does not contain number":"$ne",before:"$lt",after:"$gt","start with":"$regex"},MAPJSAPI={equals:"equalTo","does not equal":"notEqualTo",exists:"exists","does not exist":"doesNotExist","less than":"lessThan","less than or equal to":"lessThanOrEqualTo","greater than":"greaterThan","greater than or equal to":"greaterThanOrEqualTo","does not contain string":"notEqualTo","does not contain number":"notEqualTo","contains string":"equalTo","contains number":"equalTo",before:"lessThan",after:"greaterThan","start with":"startsWith","contains in":"containedIn","does not contain in":"notContainedIn"},QUERY_TYPES={"contains string":"String","does not contain string":"String","contains number":"Number","does not contain number":"Number"};$(function(){window.ZeroClipboard&&ZeroClipboard.setDefaults({moviePath:"scripts/lib/zeroclipboard/zeroclipboard.swf"})}),Mousetrap.bind(["1","g s"],function(){angular.element(".nav-key-1").trigger("click")}),Mousetrap.bind(["2","g e","g t"],function(){angular.element(".nav-key-2").trigger("click")}),Mousetrap.bind(["3","g a"],function(){angular.element(".nav-key-3").trigger("click")}),Mousetrap.bind(["4","g d","g m"],function(){angular.element(".nav-key-4").trigger("click")}),Mousetrap.bind(["5","g c"],function(){angular.element(".nav-key-5").trigger("click")}),Mousetrap.bind("6",function(){$(".nav-key-6").click()}),Mousetrap.bind("?",function(){$("#modal-shortcuts").modal("toggle")}),Mousetrap.bind("a",function(){$(".dropdown-toggle-app-name .dropdown-toggle").click()}),Mousetrap.bind(["`","g h"],function(){parent.window.location.href="/applist.html"}),Mousetrap.bind(["s","/"],function(){return $(".app-search input").focus(),!1}),function(){var a=angular.module("dashBoard.filters",[]);a.filter("pushFieldFilter",function(){return function(a){var b={};return angular.forEach(a,function(a,c){"ACL"!=c&&"Pointer"!=a.type&&"GeoPoint"!=a.type&"Relation"!=a.type&&"deviceType"!=c&&(b[c]=a)}),b}}),a.filter("range",function(){return function(a,b,c){b=parseInt(b),c=parseInt(c);for(var d=b;c>d;d++)a.push(d);return a}}),a.filter("to_trusted",["$sce",function(a){return function(b){return a.trustAsHtml(""+b)}}]);var b=angular.module("dashBoard.services",["ngResource"]);b.config(["$httpProvider",function(a){a.responseInterceptors.push("errorHttpInterceptor"),a.interceptors.push("beforeRequestInterceptor")}]),b.factory("apps",["$http","filterFilter",function(a){var b={};return b.all=[],b.loadall=function(){a.get(purl+"clients/self/apps").success(function(a){b.all=a}).error(function(){})},b.loadall(),b}]),b.factory("datas",["$http","$rootScope",function(a,b){var c={};return a.get(purl+"data/"+getParam().appid+"/classes").success(function(a){c.clas=a,b.$broadcast("datasready",a)}).error(function(){}),c}]),b.factory("App",["$http","$q","$routeParams",function(a,b){var c=b.defer();return getParam().appid?(a.get(purl+"clients/self/apps/"+getParam().appid).success(function(a){c.resolve(a)}).error(function(){window.location.href=rootpage}),c.promise):(c.resolve(),c.promise)}]),b.factory("AppModel",["$http","$q","$routeParams",function(a,b){var c={get:function(){var c=b.defer();return a.get(purl+"clients/self/apps/"+getParam().appid).success(function(a){c.resolve(a)}).error(function(){window.location.href=rootpage}),c.promise}};return c}]),b.factory("Team",["$resource","$q","$routeParams",function(a){return a(purl+"clients/self/teams/:id",{id:"@id"},{})}]),b.factory("TeamMember",["$resource","$q","$routeParams",function(a){return a(purl+"clients/self/teams/:teamid/members/:memberid",{teamid:"@teamid",memberid:"@memberid"},{})}]),b.factory("Cooperator",["$resource","$q","$routeParams",function(a){return a(purl+"clients/self/apps/:app_id/cooperators/:cooperatorid",{app_id:"@app_id",cooperatorid:"@cooperatorid"},{query:{method:"GET",isArray:!1},"delete":{method:"DELETE",params:{type:"@type"}},update:{method:"PUT",params:{type:"@type"}}})}]),b.factory("beforeRequestInterceptor",["$q","$rootScope",function(a){return{request:function(b){return b||a.when(b)}}}]),b.factory("errorHttpInterceptor",["$q","$location","$rootScope",function(a,b,c){return function(b){return b.then(function(a){return a},function(b){return 403===b.status?c.$broadcast("event:loginRequired"):b.status>=400&&b.status<=500&&404!=b.status?b.data&&b.data.error?showmsg(b.data.error,AVC.Error):showmsg("发生错误",AVC.Error):hidemsg(),a.reject(b)})}}]);var c=angular.module("dashBoard.directives",[]);c.directive("myAgBlur",function(){return function(a,b,c){b.bind("blur",function(){a.$apply(c.myAgBlur)})}}),c.directive("rangeDate",function(){return{template:'<i class="icon icon-calendar icon-large"></i> <span></span> <b class="caret"></b>',scope:{selectCallback:"&",startDate:"=",endDate:"=",maxDate:"="},link:function(a,b,c){var d={startDate:moment(a.startDate).format("YYYY/MM/DD"),endDate:moment(a.endDate).format("YYYY/MM/DD"),minDate:"2012/01/01",maxDate:"2020/12/31",dateLimit:{days:180},showDropdowns:!0,showWeekNumbers:!0,timePicker:!1,timePickerIncrement:1,timePicker12Hour:!0,ranges:{"今天":[moment().format("YYYY-MM-DD"),moment().format("YYYY-MM-DD")],"昨天":[moment().subtract("days",1).format("YYYY-MM-DD"),moment().subtract("days",1).format("YYYY-MM-DD")],"7天":[moment().subtract("days",6),moment()],"30天":[moment().subtract("days",29),moment()]},opens:"left",buttonClasses:["btn btn-default"],applyClass:"btn-small btn-primary",cancelClass:"btn-small",format:"YYYY-MM-DD",separator:" to ",locale:{applyLabel:"确定",cancelLabel:"取消",customRangeLabel:"自定义日期",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["1","2","3","4","5","6","7","8","9","10","11","12"],firstDay:1}};c.$observe("selectCallback",function(){a.maxDate&&(d.maxDate=moment(a.maxDate).format("YYYY/MM/DD")),b.daterangepicker(d,function(c,d){a.selectCallback({start:c,end:d}),b.find("span").html(c.format("YYYY-MM-DD")+" 至 "+d.format("YYYY-MM-DD"))})}),a.$watch("endDate",function(){b.find("span").html(moment(a.startDate).format("YYYY-MM-DD")+" 至 "+moment(a.endDate).format("YYYY-MM-DD"))})}}}),c.directive("acPagination",function(){return{templateUrl:"views/pagination.html",scope:{totalPage:"=",currentPage:"="},controller:["$scope",function(a){a.goPre=function(){a.currentPage>1&&a.currentPage--},a.goNext=function(){a.currentPage<a.totalPage&&a.currentPage++}}],link:function(){}}}),angular.module("IndexPage",["locales","dashBoard.services"]);var d=angular.module("dashBoard",["dashBoard.services","dashBoard.filters","dashBoard.directives","dashBoard.configSer","dashBoard.storageSer","locales","ngAnimate","mgcrea.ngStrap","ngUpload","ngRoute","ngLocale","ui.gravatar","infoCenterMod","account.accountSer"]);d.run(function(){}),d.controller("NavCtrl",["$scope","$http",function(a){a.nav2Testin=function(a){$.ajax({method:"get",url:purl+"oauth2/testin/token",async:!1}).success(function(b){$(a.target).attr("href","http://sso.testin.cn/connect/avos/?authtoken="+b.token)}).error(function(){})}}]),d.controller("RootCtrl",["$scope","$http","Team","TeamMember","apps","$location","$rootScope","$window","infoCenterSer","storageSer","accountSer",function(a,b,c,d,e,f,g,h,i,j,k){a.currentHtmlPage=location.pathname.split("/").pop(),a.env=ENV,a.XSRF_TOKEN=$.cookie("XSRF-TOKEN"),a.moment=moment,a.apps=e,a.rootState={pendingRequest:0},a.getClass=function(a,b){return b?f.path()==a?"active":"":f.path().substr(0,a.length)==a?"active":""},a.signout=function(){k.signout().then(function(){window.location.href="login.html"})},i.getNotification().then(function(b){var c=Number(j.item("notification-count"));c<b.length?(a.hasnewnotify=!0,j.item("notification-count",b.length)):a.hasnewnotify=!1}),a.readNotification=function(){a.hasnewnotify=!1,h.location.href="/info-center.html"},a.loaduser=function(){b.get(purl+"clients/self").success(function(b){g.user=b;var c=moment().toDate().getTime()-moment(a.user.created).toDate().getTime();48>c/36e4&&(a.user.isNew=!0),a.user.flags&&a.user.flags.indexOf("client-email-verified")>-1&&(a.user.flags.emailVerified=!0)}).error(function(){window.location.href="login.html"})},a.$on("$routeChangeSuccess",function(){}),a.$on("$viewContentLoaded",function(){}),a.hasPendingRequest=function(){return b.pendingRequests.length>0||a.rootState.pendingRequest>0},a.gotoApp=function(b){var c=AVC.AuthPages,d=c.indexOf(a.currentHtmlPage)>-1?a.currentHtmlPage:"data.html";if(c.indexOf(d)>-1)if(a.hasPermission(d,b))h.location.href=d+"?appid="+b;else for(var e=0;e<c.length;e++)a.hasPermission(c[e],b)&&(h.location.href=c[e]+"?appid="+b)},a.hasPermission=function(b,c){var d;if(c&&angular.forEach(a.apps.all,function(a){a.app_id==c&&(d=a)}),d=d||a.currentApp,!d||!c)return!1;var e=AVC.AuthMap;if("cooperator"==d.app_relation&&1!=d.permission_modules["*"]){var f=!1;return angular.forEach(d.permission_modules,function(a,c){if($.isArray(e[c])){for(var d=0;d<e[c].length;d++)if(a&&e[c][d]==b){f=!0;break}}else a&&e[c]==b&&(f=!0)}),f}return!0},a.gotoPageWithId=function(b,c,d){c=c||a.currentApp.app_id,c&&a.hasPermission(b,c)&&(h.location.href=d?b+"?appid="+c+d:b+"?appid="+c)},a.loaduser()}]),d.controller("UserCtrl",["$scope","$http","$location","storageSer","accountSer",function(a,b,c,d,e){a.env=ENV,a.location=c,a.rootState={pendingRequest:0},a.activeClass=c.path().substring(1),a.loaduser=function(){b.get(purl+"clients/self").success(function(b){a.user=b,a.user.flags&&a.user.flags.indexOf("client-email-verified")>-1&&(a.user.flags.emailVerified=!0)}).error(function(){/login.html#\/signup/.test(window.location.href)&&window.ga&&ga("send","event","Login","VsiteRegistryWithoutSession")})},a.signout=function(){e.signout().then(function(){window.location.href="login.html"})},a.hasPendingRequest=function(){return b.pendingRequests.length>0||a.rootState.pendingRequest>0},a.loaduser()}]),angular.module("ui.gravatar").config(["gravatarServiceProvider",function(a){a.defaults={size:100,"default":"https://leancloud.cn/images/static/default-avatar.png"},a.secure=!0}])}();var lang_zh_cn={DASHBOARD:"控制台",APP_ALL:"所有应用",APP_SET:"应用设置",APP_KEY_SET:"应用 key",APP_PUSH:"推送设置",APP_EMAIL:"邮件设置",APP_INFO:"应用信息",APP_NAME:"应用名称",APP_DESC:"应用描述",APP_DELETE:"删除应用",USER_PASS_MODIFY:"修改密码",USER_PASS_PRE:"原密码",USER_PASS_NEW:"新密码",USER_PASS_CONFIRM:"新密码确认",DATA_CLASSES:"所有 class",DATA_CLASS_ADDNEW:"创建 Class",DATA_CLASS_ADD_TIP:"Class 名称只能包含字母、数字、下划线，必须以字母开头",DATA_RESIZE:"隐藏侧栏",DATA_ADD_ROW:"添加行",DATA_REDUCE_ROW:"删除行",DATA_ADD_COLUMN:"添加列",DATA_ADD_COLUMN_TITLE:"添加列",DATA_ADD_COLUMN_TIP:"只能包含字母、数字、下划线，必须以字母或数字开头",DATA_QUERY:"查询",DATA_QUERY_CON:"查询条件",DATA_RELOAD:"刷新",DATA_OTHERS:"其他",DATA_DELETE_COLUMN:"删除列",DATA_DELETE_ALLROWS:"删除所有数据",DATA_DROP_CLASS:"删除 Class",DATA_INDEX:"索引",DATA_PERMISSIN:"权限设置",DATA_INDEX_LIST:"索引列表",DATA_INDEX_NAME:"索引名称",DATA_INDEX_KEY:"索引键值",DATA_INDEX_OPTION:"索引选项",DATA_INDEX_DELETE:"删除",DATA_INDEX_NEW:"新建索引",DATA_INDEX_TYPE:"选择索引类型",DATA_INDEX_TYPE_NORMAL:"普通",DATA_INDEX_TYPE_UNIQUE:"唯一",DATA_INDEX_TYPE_SPARSE:"稀疏",DATA_INDEX_COLUMN:"选择索引字段",DATA_INDEX_COLUMN_1:"正序","DATA_INDEX_COLUMN_-1":"倒序",DATA_INDEX_COLUMN_2d:"2dsphere",DATA_INDEX_COLUMN_hash:"哈希",DATA_PERMISSION_TITLE:"设置 {{name}}",DATA_PERMISSIN_FIELD_TITLE:" {{claName}} -- {{fieldName}} 权限设置 ",DATA_PERMISSIN_FIELD_TIP:"设置用户在 {{claName}} 的 {{fieldName}} 字段可以执行的权限。",DATA_PERMISSION_TIP_ALL:"所有用户都有此权限",DATA_PERMISSION_TIP:"为 {{name}}class 选择你的客户端应用的权限操作类型。",DATA_CLASS_DROP_TIP:"确定删除这个 class 并删除里面所有的数据？此操作不可恢复。",DATA_DELETE_ALL_ROWS_TIP:"确定删除这个 class 的所有数据？此操作不可恢复。",PUSH_SENDTO:"推送目标",PUSH_DEVICE:"终端类别",PUSH_NO_ACT:"未活跃天数",PUSH_SEND_TIME:"推送时间",PUSH_EXP_TIME:"推送过期时间",PUSH_MSG:"推送内容",PUSH_ALL:"所有",PUSH_PART:"限定推送条件",PUSH_NOW:"现在",PUSH_SPECIFIC:"指定时间",PUSH_NEVER:"从不",PUSH_INTERVAL:"过期间隔时间",PUSH_CON:"指定条件",PUSH_CON_ADD:"添加条件",PUSH_iOS_UPLOAD_TIP:'iOS 需要先 <a href="app.html?appid={{app.app_id}}#/push">上传</a> Apple SSL Certificate 文件 ',PUSH_DEVICE_IOS:"iOS 设备",PUSH_DEVICE_ANDROID:"Android 设备",PUSH_MORETHAN:"超过",PUSH_DAY:"天",CLOUD_REPOSITORY:"代码库",CLOUD_DEPLOY:"部署",CLOUD_LOG:"日志",CLOUD_REPOSITORY_HOST:"代码库地址",CLOUD_REPOSITORY_CREATE:"创建代码库",CLOUD_DOWNLOAD:"下载项目框架",CLOUD_DEPLOY_DEV:"部署到开发环境",CLOUD_DEV_VERSION:"开发环境版本号",CLOUD_DEPLOY_PROD:"部署到生产环境",CLOUD_PROD_VERSION:"生产环境版本号",CLOUD_REVISION:"版本或分支号",CLOUD_ACTION_DEPLOY:"部署",APP_ID:"应用 ID",APP_KEY:"应用 key",APP_PUSH_CERT:"Apple 推送认证",APP_PUSH_UPLOADED:"已上传文件",APP_PUSH_UPLOAD:"上传文件",APP_EMAIL_TEMPLATES:"邮件模板",APP_EMAIL_VERIFY_TMPL:"邮件认证模板",APP_EMAIL_SUBJECT:"主题",APP_EMAIL_CONTENT:"内容",APP_EMAIL_PASS_TMPL:"密码重置模板",NAV_ANALYTIC:"统计分析",NAV_DATA:"数据管理",NAV_PUSH:"消息推送",NAV_CLOUD:"云代码",NAV_SET:"应用设置",NAV_DOC:"文档",NAV_SDK:"SDK下载",NAV_FORUM:"论坛",NAV_INDEX_SOCIAL:"社交组件",NAV_INDEX_DATA:"数据存储",NAV_INDEX_PUSH:"消息推送",NAV_INDEX_CLOUD:"云代码",NAV_DATA_DESC:"通过 SDK 和 Rest API，提供服务端数据解决方案。",NAV_PUSH_DESC:"提供 iOS 和 Android 的数据推送服务。",NAV_SOCIAL_DESC:"提供方便的社交分享组件，如 QQ 和微博分享。",NAV_CLOUD_DESC:"通过编写 Node.js，自定义服务端逻辑。",NAV_SUPPORT:"我们目前支持的开发平台",ACTION_SAVE:"保存",ACTION_DELETE:"删除",ACTION_COPY:"复制",ACTION_UPLOAD:"上传",ACTION_CREATE:"创建",ACTION_CREATE_APP:"创建应用",ACTION_LOGOUT:"退出",ACTION_LOGIN:"登录",ACTION_APPLY_ACCOUNT:"申请账号",ACTION_CANCEL:"关闭",ACTION_QUERY:"查询",ACTION_APPLY:"申请",OPERATE_TIP:"操作提示",TIP_PUSH:"上传后缀名为 .p12 的 Apple SSL Certificate 文件，导出 .p12 文件时不要加密码保护。",TIP_VIEW_PUSH:"查看推送文档",TIP_FUNCTION:"功能说明",TIP_CLOUD_DEPLOY:"可以根据 <b>分支</b> 或 <b>版本号</b> 发布特定版本到测试或生产环境中。",TIP_FUNCTION_CLOUD_DEPLOY:' 点击 <b>部署</b>，会发布相应的 <b>分支</b> 或 <b>版本号</b> 到测试或生产环境中，<a href="docs/cloud_code_guide.html" >相关文档</a>。 ',TIP_FUNCTION_REPOSITORY:'云代码可以放在如 <a href="https://github.com/" target="_blank">GitHub</a>、<a href="https://bitbucket.org/" target="_blank">Bitbucket</a> 和 <a href="https://code.csdn.net/" target="_blank">CSDNCode</a> 的代码库。部署的时候提供分支号或版本号，就可以从代码库上发布到开发或生产环境中。',TIP_OPERATE_REPOSITORY:" 点击 <b>保存</b>，会保存您输入的代码库地址。",FORM_EMAIL:"邮箱",FORM_PASS:"密码",FORM_FORGOTPASS:"忘记密码",FORM_REGISTRY:"注册",FORM_USER_NAME:"用户名",FORM_CAPTCHA:"验证码",FORM_CAPTCHA_CHANGE:"换一个",FORM_COMPANY:"公司",FORM_POSITION:"职位",FORM_PROJECT:"项目信息",FORM_FIND_PASS:"找回密码",STAT_BAR:"柱状图",STAT_LINE:"线性图",PAGE_PRE:"&larr; 前一页",PAGE_NEXT:"后一页 &rarr;"};angular.module("ngLocale",[],["$provide",function(a){var b={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};a.value("$locale",{DATETIME_FORMATS:{AMPMS:["上午","下午"],DAY:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],MONTH:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],SHORTDAY:["周日","周一","周二","周三","周四","周五","周六"],SHORTMONTH:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],fullDate:"y年M月d日EEEE",longDate:"y年M月d日",medium:"yyyy-M-d ah:mm:ss",mediumDate:"yyyy-M-d",mediumTime:"ah:mm:ss","short":"yy-M-d ah:mm",shortDate:"yy-M-d",shortTime:"ah:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"¥",DECIMAL_SEP:".",GROUP_SEP:",",PATTERNS:[{gSize:3,lgSize:3,macFrac:0,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,macFrac:0,maxFrac:2,minFrac:2,minInt:1,negPre:"(¤",negSuf:")",posPre:"¤",posSuf:""}]},id:"zh-cn",pluralCat:function(){return b.OTHER}})}]),angular.module("locales",["pascalprecht.translate"],["$translateProvider",function(a){a.translations("zh_CN",lang_zh_cn),a.preferredLanguage("zh_CN")}]),angular.module("dashBoard.storageSer",[]).factory("storageSer",["$window",function(a){function b(b){var c=a.localStorage.getItem(b);return/^\{/.test(c)&&/\}$/.test(c)&&(c=JSON.parse(c)),c}function c(b,c){return"object"==typeof c&&(c=JSON.stringify(c)),a.localStorage.setItem(b,c)}function d(b){a.localStorage.removeItem(b)}return{item:function(a,d){switch(arguments.length){case 1:return b(a);case 2:return c(a,d)}},remove:function(a){d(a)},removeAll:function(){var a=["notification-count"];$.each(a,function(a,b){d(b)})}}}]),angular.module("dashBoard.configSer",[]).factory("configSer",["$rootScope","$location",function(){return{apiUrl:"/1",httpTimeout:1e4}}]);var appMod=angular.module("appMod",["dashBoard","dataMod.service"]),appSetMod=angular.module("appSetMod",["appMod"]);appSetMod.config(["$routeProvider",function(a){a.when("/general",{templateUrl:"views/setting/general-set.html"}).when("/key",{templateUrl:"views/app-key-set.html"}).when("/email",{templateUrl:"views/app-email-set.html",controller:"AppEmailCtrl"}).when("/export",{templateUrl:"views/app-export-data.html",controller:"ExportDataCtrl"}).when("/team",{templateUrl:"views/app-team-set.html",controller:"CooperatorCtrl"}).when("/permission",{templateUrl:"views/app-permission-set.html",controller:"AppGeneralConfigCtrl"}).when("/sms",{templateUrl:"views/app-sms-set.html",controller:"SmsCtrl"}).otherwise({redirectTo:"/general"})}]),appMod.controller("AppCtrl",["$scope","$http","$location","filterFilter","apps","App","AppModel","$rootScope","Cooperator","$timeout","$window",function(a,b,c,d,e,f,g,h){function i(b){a.openappfile="/node/apps/"+a.app.app_id,a.appopen.name||(a.appopen.name=a.app.app_name),a.appopen.description||(a.appopen.description=a.app.description),b.api_white_domains&&(a.app.whiteDomains=b.api_white_domains.join("\n"))}getParam().appid&&(a.apps=e,a.appopen={},a.location=c,a.uploadCertDisable=!0,f.then(function(b){h.currentApp=b,a.hasPermission(a.currentHtmlPage,a.currentApp.app_id)||(location.href="401.html");var c=b;window.AV&&(AV._initialize(c.app_id,c.app_key,c.master_key),AV._useMasterKey=!0)}),f.then(function(a){h.app=a,i(a)},function(){window.location.href=rootpage}),a.pushaction=purl+"clients/self/apps/"+getParam().appid,a.isNotCurrentApp=function(b){return a.currentApp.app_name!=b.app_name},a.deleteapp=function(){function c(){b.delete(purl+"clients/self/apps/"+a.app.app_id,{params:{password:$("#user_password").val()}}).success(function(){window.location.href=rootpage})}var d=window.confirm("确定删除此应用?点击取消可以撤销删除该操作");d&&c()},a.updatehost=function(){b.put(purl+"clients/self/apps/"+a.app.app_id,{app_domain:a.app.app_domain}).success(function(){showmsg("操作成功")})},a.updateapp=function(){b.put(purl+"clients/self/apps/"+a.app.app_id,{name:a.app.app_name,description:a.app.description}).success(function(){showmsg("操作成功")})},a.updateWhiteDomains=function(){var c=a.app.whiteDomains.replace(/\n/g,",");b.put(purl+"clients/self/apps/"+a.app.app_id,{api_white_domains:c}).success(function(){showmsg("操作成功")})},$(document).on("change","[name='cert_file']",function(){a.$apply(".p12"==$(this).val().substring($(this).val().length-4)?function(){a.uploadCertDisable=!1}:function(){a.uploadCertDisable=!0})}),a.$on("$viewContentLoaded",function(){if($("#app_id_copy").length){var a=new ZeroClipboard;a.glue($(".copybtn")),a.on("mousedown",function(){a.setText($(this).parents(".form-group").find("input:text").val())}),a.on("complete",function(){showmsg("复制成功",3e3)}),a.on("noflash",function(){$(".copybtn").parent().addClass("no-flash").parent().addClass("no-flash"),$(".copybtn").hide()})}}),a.loadApp=function(){g.get().then(function(b){a.currentApp=a.app=b})})}]),appMod.controller("TransferAppCtrl",["$http","$scope","$timeout","$window",function(a,b,c,d){b.queryCooperatorsTip=function(c,d){return c&&"object"!=typeof c&&c&&""!=c.trim()?a.get(purl+"clients/find/like",{params:{type:d,name:c}}).then(function(a){return b.tipCooperators=a.data.results,a.data.results}):void 0},b.transferApp=function(){var e;angular.forEach(b.tipCooperators,function(a){a.name===b.acceptAppUserName&&(e=a.id)}),e&&a.post(purl+"clients/self/apps/"+getParam().appid+"/transfer/"+e,{password:b.userPasswordTransfer}).success(function(){showmsg("应用转让成功，将自动跳转到应用列表页"),c(function(){d.location.href=rootpage},3e3)})}}]),appMod.controller("AppPublishCtrl",["$http","$scope",function(a,b){a.get("/node/apps/"+getParam().appid).success(function(a){$.extend(b.appopen,a)}),b.publishapp=function(){a.post("/node/apps/"+b.app.app_id,{name:b.appopen.name,description:b.appopen.description,show:b.appopen.show,iconImage:b.appopen.iconImage,url:b.appopen.url}).success(function(a){a.error?showmsg(a.error,AVC.Error):showmsg("操作成功")}).error(function(){})},b.uploadIconresults=function(a,c){if(c&&a.length>0)try{b.appopen.icon=JSON.parse(a).icon,showmsg("上传成功")}catch(d){showmsg("上传失败",AVC.Error)}},b.isValidIcon=function(a){return/\.(jpg|jpeg|png|JPG|PNG)$/.test(a)?!0:(showmsg("仅支持PNG或JPG类型的图片",AVC.Error),!1)}}]),appMod.controller("AppGeneralConfigCtrl",["$scope","$http","App",function(a,b,c){c.then(function(){a.testPhone=a.currentApp.test_mobile_phones}),a.appflags={},a.updateAppFlag=function(c){var d={flag:c};a.appflags[c]?b.put(purl+"clients/self/apps/"+getParam().appid+"/enable-flag",d).success(function(){showmsg("保存成功")}):b.put(purl+"clients/self/apps/"+getParam().appid+"/disable-flag",d).success(function(){showmsg("保存成功")})},b.get(purl+"clients/self/apps/"+getParam().appid+"/flags").success(function(b){angular.forEach(b,function(b){a.appflags[b]=!0})}).error(function(){}),a.setTestPhone=function(){b.put(purl+"clients/self/apps/"+getParam().appid,{test_mobile_phones:a.testPhone})}}]),appMod.controller("CooperatorCtrl",["$scope","$http","Cooperator",function(a,b,c){a.loadCooperator=function(){c.query({app_id:getParam().appid},function(b){var c=b.results;angular.forEach(c,function(a){if("admin"==a.role)a.roleDesc="所有权限";else{var b=[];angular.forEach(a.modules,function(a,c){b.push(AVC.AuthDesc[c])}),a.roleDesc=b.join(" ")}}),a.cooperators=c})},a.setCurrent=function(b){angular.forEach(a.cooperators,function(c){c.cooperator_id==b&&(a.currentCooperator=c,a.currentCooperator.noLimit="admin"==a.currentCooperator.role?!0:!1)})},a.setCooperatorPermission=function(){var b=new c;b.cooperatorid=a.currentCooperator.cooperator_id;var d={};a.currentCooperator.noLimit?b.role="admin":(b.role="normal",angular.forEach(a.currentCooperator.modules,function(a,b){a&&(d[b]=!0)}),b.modules=d,delete b.modules.setting),b.$update({app_id:getParam().appid,type:a.currentCooperator.cooperator_type}).then(function(){a.loadCooperator()})},a.getCooperatorByName=function(b,c){var d;return angular.forEach(a.tipCooperators,function(a){a.type==b&&a.name==c&&(d=a)}),d},a.queryCooperatorsTip=function(c,d){return c&&"object"!=typeof c&&c&&""!=c.trim()?b.get(purl+"clients/find/like",{params:{type:d,name:c}}).then(function(b){return a.tipCooperators=b.data.results,b.data.results}):void 0},a.getOperatorType=function(b){return 0==a.tipCooperators[b].type?"个人":"团队"},a.removeCooperator=function(b,d){var e=new c;e.$delete({app_id:getParam().appid,cooperatorid:b,type:d},function(){for(var c=0;c<a.cooperators.length;c++)if(a.cooperators[c].cooperator_id==b){a.cooperators.splice(c,1);break}})},a.loadCooperator()}]),appMod.controller("CooperatorEditCtrl",["$scope","$http","Cooperator",function(a,b,c){a.currentCooperator={modules:{}},a.currentCooperator.noLimit=!0,a.addCooperator=function(b,d){if(0==b&&d==a.user.username)return void showmsg("不能给当前登录用户本身设置权限",AVC.Error);if(a.toAddCooperator=null,angular.forEach(a.tipCooperators,function(c){return c.type==b&&c.name==d?void(a.toAddCooperator=c):void 0}),!a.toAddCooperator)return void showmsg("输入的用户名不存在",AVC.Error);var e=new c,b=1;e.app_id=getParam().appid,e.client_id=a.toAddCooperator.client_id,e.cooperator_id=a.toAddCooperator.id,e.cooperator_type=a.toAddCooperator.type,e.name=a.toAddCooperator.name;var f=(JSON.parse(JSON.stringify(e)),{});a.currentCooperator.noLimit?e.role="admin":(e.role="normal",angular.forEach(a.currentCooperator.modules,function(a,b){a&&(f[b]=!0)}),e.modules=f),e.$save(function(){a.cooperatorName="",a.cooperatorNameOrg="",a.loadCooperator()})}}]),appMod.controller("AppEmailCtrl",["$scope","$http",function(a,b){function c(a){var b=[];return b[0]=a.match(/<!-- (.*)-->/)[1],b[1]=a.substring(a.match(/<!-- (.*)-->/)[0].length),b}b.get(purl+"clients/self/apps/"+getParam().appid+"/emailTemplates").success(function(b){var d=c(b.verify_email_tpl);a.verify_email_tpl_subject=d[0],a.verify_email_tpl_body=d[1];var d=c(b.reset_password_tpl);a.reset_password_tpl_subject=d[0],a.reset_password_tpl_body=d[1],a.verify_email_url=b.verify_email_url,a.reset_password_url=b.reset_password_url,a.send_email_url=b.app_email}).error(function(){}),a.setEmailVerify=function(){a.emailVerifyEmabled?b.put(purl+"clients/self/apps/"+getParam().appid+"/enable-flag",{flag:"verify-user-emails"}).success(function(){a.emailVerifyEmabled=!0}):b.put(purl+"clients/self/apps/"+getParam().appid+"/disable-flag",{flag:"verify-user-emails"}).success(function(){a.emailVerifyEmabled=!1})},a.updateTpl=function(){b.put(purl+"clients/self/apps/"+getParam().appid+"/emailTemplates",{templates:{app_email:a.send_email_url,verify_email_tpl:"<!-- "+a.verify_email_tpl_subject+" -->"+a.verify_email_tpl_body,reset_password_tpl:"<!-- "+a.reset_password_tpl_subject+" -->"+a.reset_password_tpl_body}}).success(function(){showmsg("操作成功")}).error(function(){})},a.updateVeriyURL=function(){b.put(purl+"clients/self/apps/"+getParam().appid+"/emailTemplates",{templates:{verify_email_url:a.verify_email_url}}).success(function(){showmsg("操作成功")}).error(function(){})},a.updatePasswordURL=function(){b.put(purl+"clients/self/apps/"+getParam().appid+"/emailTemplates",{templates:{reset_password_url:a.reset_password_url}}).success(function(){showmsg("操作成功")}).error(function(){})}}]),appMod.factory("Sms",["$resource",function(a){var b=purl+"clients/self/apps/:app_id/smsTemplates/:id";return a(b,{app_id:getParam().appid,id:"@id"},{update:{method:"PUT"}})}]),appMod.controller("SmsCtrl",["$scope","$http","Sms",function(a,b,c){a.list=function(){c.query().$promise.then(function(b){a.smsTpls=b})},a.setCurrent=function(b){a.currentSmsId=b},a.delete=function(b){var d=window.confirm("确定删除该短信模板？");d&&c.delete({id:b},function(){a.list()})},a.list()}]),appMod.controller("SmsEditCtrl",["$scope","$http","Sms",function(a,b,c){a.sms={},angular.forEach(a.smsTpls,function(b){b.id==a.currentSmsId&&(a.sms=b)}),a.save=function(){var b=new c(a.sms);a.sms.id?b.$update(function(){a.list()}):b.$save(function(){a.list()})}}]),appMod.controller("ExportDataCtrl",["$scope","$http","SchemaLoader",function(a,b,c){c.fetch().then(function(b){a.clas=b}),a.export={limit:!0,start:moment().subtract("days",1).format("YYYY-MM-DD"),end:moment().format("YYYY-MM-DD"),limitClass:!1,classes:[]},a.exportData=function(){var c={};a.export.limit&&(c={from_date:moment(a.export.start).format("YYYY-MM-DD"),to_date:moment(a.export.end).add("days",1).format("YYYY-MM-DD")}),a.export.limitClass&&(c.classes=a.export.classes.join(",")),b.get(purl+"clients/self/apps/"+getParam().appid+"/export",{params:c}).success(function(){showmsg("数据导出成功")
}).error(function(a){showmsg(a.error,AVC.Error)})},a.toggleClass=function(b){var c=a.export.classes.indexOf(b);c>-1?a.export.classes.splice(c,1):a.export.classes.push(b)}}]),angular.module("wallMod",["dashBoard"]),angular.module("wallMod").controller("WallCtrl",["$scope","$http",function(a,b){a.wall_current=0,a.wall_perpage=10,a.wall_next=!0,a.prewallDisabled=function(){return a.wall_current<=0},a.preWall=function(){0!=a.wall_current&&(a.wall_current--,a.loadOpenApps())},a.nextWall=function(){a.wall_current++,a.loadOpenApps()},a.loadOpenApps=function(c){c=c||a.wall_current*a.wall_perpage,b.get("/node/apps",{params:{skip:c}}).success(function(b){a.openapps=b.results,a.openapps.length<a.wall_perpage&&(a.wall_next=!1)})},a.loadOpenApps()}]),angular.module("searchMod",["dashBoard"]),angular.module("searchMod").controller("SearchCtrl",["$scope","$http",function(a,b){a.searcht={},getParam().q&&(a.searcht.keyword=decodeURIComponent(getParam().q).replace(/\+/g," "));var c="/search/select/?hl=true&fl=url,title&hl.fl=title,content&start=0&limit=50&wt=json&hl.alternateField=content&hl.maxAlternateFieldLength=250";$(".search-query").keyup(function(b){13==b.keyCode&&a.pageReload()}),a.pageReload=function(){window.location.href="search.html?q="+a.searcht.keyword},a.search=function(){b.get(c,{params:{q:a.searcht.keyword}}).success(function(b){a.searchResults=b.response.docs;var c=b.highlighting;a.searchResults.forEach(function(a){a.content=c[a.url].content[0]}),$.isEmptyObject(a.searchResults)&&(a.nosearch=!0)})},a.searcht.keyword&&a.search()}]),angular.module("featureMod",["dashBoard"]),angular.module("featureMod").config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/features/storage.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-storage.html"}).when("/features/push.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-push.html"}).when("/features/message.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-message.html"}).when("/features/analytics.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-analytic.html"}).when("/features/modules.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-modules.html"}).when("/features/social.html",{controller:"FeaturesCtrl",templateUrl:"/views/feature-social.html"}).otherwise({redirectTo:"/features/storage.html"})}]).run(["$rootScope","$location",function(a,b){a.$on("$routeChangeStart",function(){a.ngViewClass=""}),a.$on("$routeChangeSuccess",function(){var c=b.path().replace(/\//gi,"-").replace(".html","").replace("-","");a.bodyClass="body-"+c,a.backgroundClass=c,a.ngViewClass="feature-active"})}]),angular.module("featureMod").controller("FeaturePageCtrl",["$scope","$location",function(a,b){a.changePath=function(a){b.path(a)},a.location=b}]),angular.module("featureMod").controller("FeaturesCtrl",["$scope","$route","$location","$rootScope",function(a){!function(){$("pre").addClass("prettyprint"),prettyPrint()}(),a.ngViewActive=".feature-active",$(function(){$(".tab-container").easytabs({animate:!0,animationSpeed:160,panelActiveClass:"active-content-div",tabActiveClass:"active",tabs:".feature-section-control-nav > li",updateHash:!0}).bind("easytabs:after",function(){$(window).resize()})})}]);var appListMod=angular.module("appListMod",["appMod"]);appListMod.config(["$routeProvider",function(a){a.when("/newapp",{templateUrl:"/newapp.html",controller:"MainCtrl"}).when("/apps",{templateUrl:"views/apps.html",controller:"MainCtrl"}).otherwise({redirectTo:"/apps"})}]),appListMod.controller("MainCtrl",["$http","$scope","$location","apps",function(a,b,c,d){b.createDisabled=!1,b.apps=d,b.newapp=function(){b.createDisabled=!0;var e={name:b.appname};b.createByExist&&b.byAppId&&(e.src_app_id=b.byAppId),a.post(purl+"clients/self/apps",e).success(function(){d.loadall(),c.path("/apps")}).error(function(){b.createDisabled=!1})},b.getAppNumStr=function(a){return a>=1e9?(a/1e9).toFixed(1).replace(/\.0$/,"")+"b":a>=1e6?(a/1e6).toFixed(1).replace(/\.0$/,"")+"m":a>=1e3?(a/1e3).toFixed(1).replace(/\.0$/,"")+"k":a};var e=[];b.$watch("appSearch",function(a){if(e.length||$.each(d.all,function(a,b){e.push(b)}),a){var c=[];$.each(e,function(b,d){d.app_name.indexOf(a)>-1&&c.push(d)}),b.apps.all=c}else b.apps.all=e})}]),$(function(){$(".create-app-btn").tooltip()});var cloudMod=angular.module("cloudMod",["appMod","dataMod.service"]);cloudMod.config(["$routeProvider",function(a){a.when("/conf",{templateUrl:"views/cloud-conf.html"}).when("/deploy",{templateUrl:"views/app-cloud-deploy.html",controller:"DeployCtrl"}).when("/task",{templateUrl:"views/app-cloud-task.html",controller:"CloudTaskCtrl"}).when("/log",{templateUrl:"views/app-cloud-log.html",controller:"LogCtrl"}).when("/console",{templateUrl:"views/cloud-console.html",controller:"ConsoleCtrl"}).when("/online",{templateUrl:"views/cloud-online.html",controller:"CloudOnlineCtrl"}).when("/stat",{templateUrl:"views/cloud-stat.html",controller:"CloudStatCtrl"}).otherwise({redirectTo:"/online"})}]),cloudMod.controller("CloudCtrl",["$scope","$http","$location","filterFilter","apps","App",function(a,b,c,d,e){a.apps=e,a.deleteCloud=function(){b.delete(purl+"clients/self/apps/"+a.app.app_id+"/cloudProject").success(function(){})}}]),cloudMod.controller("RepositoryCtrl",["$scope","$http","App",function(a,b,c){if($("#deploy_key_copy").length){var d=new ZeroClipboard;d.glue(document.getElementById("deploy_key_copy")),d.on("mousedown",function(){d.setText($("#deploy_key").val())}),d.on("complete",function(){showmsg("复制成功",3e3)}),d.on("noflash",function(){$(".copybtn").parent().addClass("no-flash"),$(".copybtn").hide()})}c.then(function(c){a.projectURL=purl+"functions/skeleton?appId="+a.currentApp.app_id+"&appKey="+a.currentApp.master_key,a.projectWeb=a.projectURL+"&webHosting=true",a.btnname=a.currentApp.cloud_project_remote?"update":"create",a.cloud_project_remote=a.currentApp.cloud_project_remote,a.cloud_project_ssh_key=a.currentApp.cloud_project_ssh_key,b.get(purl+"functions/deployKey?appId="+c.app_id+"&appKey="+a.currentApp.master_key).success(function(b){b.deployKey=$.trim(b.deployKey),/cloud code deploy key\s*$/.test(b.deployKey)&&b.deployKey.length>76&&(b.deployKey=b.deployKey.substring(0,b.deployKey.length-76)),a.deployKey=b.deployKey})}),a.updateCloud=function(){a.cloud_project_ssh_key="",b.put(purl+"clients/self/apps/"+a.app.app_id,{cloud_project_remote:a.cloud_project_remote,cloud_project_ssh_key:a.cloud_project_ssh_key}).success(function(){showmsg("操作成功"),a.loadApp()})},a.createGitlab=function(){b.post(purl+"clients/self/apps/"+a.app.app_id+"/cloudProject").success(function(b){a.cloud_project_remote=b.cloud_project_remote,a.currentApp.cloud_project_remote=b.cloud_project_remote})}}]),cloudMod.controller("DeployCtrl",["$scope","$http","App","AppModel",function(a,b,c,d){function e(){b({method:"get",url:cloudURL+"functions/status",headers:{"x-uluru-application-id":a.currentApp.app_id,"x-uluru-application-key":a.currentApp.master_key}}).success(function(b){a.devVersion=b.dev,a.prodVersion=b.prod,a.devCommitLog=b.devLog,a.prodCommitLog=b.prodLog})}a.upgradeCloud=function(){b({method:"put",url:cloudURL+"functions/upgrade",headers:{"x-uluru-application-id":a.currentApp.app_id,"x-uluru-application-key":a.currentApp.master_key}}).success(function(b){a.devVersion=b.dev,a.prodVersion=b.prod,a.devCommitLog=b.devLog,a.prodCommitLog=b.prodLog,d.get().then(function(b){a.currentApp=b}),showmsg("升级云代码成功")})},a.deploy=function(){b({method:"put",url:cloudURL+"functions/publishFunctions",headers:{"x-uluru-application-id":a.currentApp.app_id,"x-uluru-application-key":a.currentApp.master_key}}).success(function(b){a.devVersion=b.dev,a.prodVersion=b.prod,a.devCommitLog=b.devLog,a.prodCommitLog=b.prodLog,showmsg("部署成功")})},a.deployDev=function(){var c=a.currentApp.cloud_project_remote,d="master";$.trim(a.publishV)&&(d=a.publishV),b({method:"post",url:cloudURL+"functions",headers:{"x-uluru-application-id":a.currentApp.app_id,"x-uluru-application-key":a.currentApp.master_key},data:{repository:{url:c},after:d}}).success(function(b){a.devVersion=b.dev,a.prodVersion=b.prod,a.devCommitLog=b.devLog,a.prodCommitLog=b.prodLog,showmsg("部署成功")})},a.undeploy=function(){b({method:"post",url:cloudURL+"functions/undeploy/repo",headers:{"x-uluru-application-id":a.currentApp.app_id,"x-uluru-application-key":a.currentApp.master_key}}).success(function(){a.devVersion="undeployed",a.prodVersion="undeployed",showmsg("清除部署成功")})},c.then(function(){e()})}]),cloudMod.controller("LogCtrl",["$scope","$http","filterFilter","App",function(a,b,c,d){a.logcond={level:"all",prod:"all"},a.flog={info:!0,error:!0,prod:!0,dev:!0},a.currentPage=1,a.log=function(){var c={};"all"!=a.logcond.level&&(c.level=a.logcond.level),"all"!=a.logcond.prod&&(c.production=parseInt(a.logcond.prod));var d={method:"POST",url:purl+"classes/_CloudLog",headers:{"Content-Type":"text/plain"},data:{_method:"GET",_ApplicationId:getParam().appid,_ApplicationKey:a.currentApp.app_key,limit:20,skip:20*(a.currentPage-1),order:"-updatedAt",where:c}};b(d).success(function(b){angular.forEach(b.results,function(a){a.content=a.content.replace(/\\n/g,"\n"),a.updatedAt=moment.utc(a.updatedAt).format("YYYY-MM-DD HH:mm:ss")}),a.logs=b.results});var e=angular.copy(d);e.data.count=1,e.data.limit=0,b(e).success(function(b){a.totalLogCount=Math.floor(b.count/20)+1})},a.filterLog=function(b){return a.flog.prod&&a.flog.dev&&("info"==b.level&&a.flog.info||"error"==b.level&&a.flog.error)?!0:a.flog.prod&&1==b.production&&("info"==b.level&&a.flog.info||"error"==b.level&&a.flog.error)?!0:a.flog.dev&&0==b.production&&("info"==b.level&&a.flog.info||"error"==b.level&&a.flog.error)?!0:!1},d.then(function(){a.$watch("logcond",function(){a.currentPage=1},!0),a.$watch("[logcond,currentPage]",function(){a.log()},!0)})}]),cloudMod.controller("CloudTaskCtrl",["$http","$scope",function(a,b){var c=purl+"clients/self/apps/"+getParam().appid+"/timers";b.task={prod:1,crontype:1},b.create=function(){b.task={prod:1,crontype:1}},b.save=function(){b.task.prod=parseInt(b.task.prod),2==b.task.crontype&&(b.task.cron="interval:"+b.task.interval),b.task.id?a.put(c+"/"+b.task.id,b.task).success(function(){$("#cloud-task-create").modal("hide"),b.list()}):a.post(c,b.task).success(function(){$("#cloud-task-create").modal("hide"),b.task={prod:1,crontype:1},b.list()})},b.loadFunctions=function(){a.get(appurl+"/cloudFunctions",{params:{prod:b.task.prod}}).success(function(a){b.cloudFunctions=a.results})},b.list=function(){a.get(c).success(function(a){b.tasks=a.results})},b.updateState=function(d,e){a.post(c+"/"+d+"/"+e),b.list()},b.delete=function(d){a.delete(c+"/"+d).success(function(){b.list()})},b.setCurrentTask=function(a){b.task=a,/^interval:\d+$/.test(b.task.cron)?(b.task.crontype=2,b.task.interval=parseInt(b.task.cron.split(":")[1]),b.task.cron=null):b.task.crontype=1},b.list(),b.loadFunctions(),b.$watch("task.prod",b.loadFunctions)}]),cloudMod.controller("ConsoleCtrl",["$http","$scope",function(a,b){var c=ace.edit("form-console-content");c.setTheme("ace/theme/textmate"),c.getSession().setMode("ace/mode/javascript"),b.codeResult={value:null,error:null,valueType:""};var d="CLOUD-RECENT-CODE";if(b.recentCodes=[],localStorage[d])try{b.recentCodes=JSON.parse(localStorage[d])}catch(e){b.recentCodes=[]}b.codeRun=function(){a({url:purl+"functions/script",method:"post",headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.app_key),data:{script:c.getValue()}}).success(function(a){if(a.error||-1!=b.recentCodes.indexOf(c.getValue())||(b.recentCodes.unshift(c.getValue()),b.recentCodes.length>5&&b.recentCodes.splice(5),localStorage[d]=JSON.stringify(b.recentCodes)),b.codeResult={value:null,error:null,valueType:""},a.error)b.codeResult.error=a.error;else{var e=a.result;"undefined"==typeof e?(b.codeResult.value="undefined",b.codeResult.valueType="undefined"):"string"==typeof e?(b.codeResult.value='"'+e+'"',b.codeResult.valueType="string"):b.codeResult.value="array"==typeof e||"object"==typeof e?JSON.stringify(e):e}})},b.codeReset=function(){a({url:"https://cn-stg1.leancloud.cn/1/functions/context/reset",method:"post",headers:{"X-AVOSCloud-Application-Id":"cqvid84b63ncn7tdwkcn2x4a15ij9j11v25vqn88tnxzdjt8","X-AVOSCloud-Application-Key":"6b7fgzd92ljo6wgmxtmbc9ya292vuueufnt1xzy8c7nueiok"}}).success(function(){b.codeResult.value="重置云代码环境成功，所有在控制台执行的代码都会被移除"})},b.removeRecentCode=function(a){b.recentCodes.splice(b.recentCodes.indexOf(a),1),localStorage[d]=JSON.stringify(b.recentCodes)},b.setEditorContent=function(a){c.setValue(a)}}]),cloudMod.controller("CloudStatCtrl",["$http","$scope","App",function(a,b,c){function d(a){var c={url:purl+"functions/stats/"+a,method:"get",headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key)};return c}function e(c,e){var f=getChartOption();if(f.chart.type="area",f.plotOptions={series:{animation:{duration:1500},showInLegend:!0}},f.tooltip.formatter=function(){return this.x+" : "+Math.floor(100*this.y)+"%"},b.statItem){var g=b.statItem;f.tooltip.formatter=function(){return"memoryRss"==g?this.x+" : "+Math.floor(this.y/1024)+" MB":"cpu"==g?this.x+" : "+Math.floor(this.y)+"%":this.x+" : "+this.y};var h=d(b.statItem);h.params={},c&&(h.params.start_date=moment(c).format("YYYY-MM-DD")),e&&(h.params.end_date=moment(e).format("YYYY-MM-DD")),a(h).success(function(a){f.xAxis.categories=a.dates,f.xAxis.tickInterval=Math.round(f.xAxis.categories.length/6),f.series=a.stats,"memoryRss"==g&&(f.yAxis.labels={formatter:function(){return Math.floor(this.value/1014)+" MB"}}),window.chart=$("#chart-container").highcharts(f)})}}b.cloudStatCondition="hour",b.startDate=moment().toDate(),b.endDate=moment().toDate(),b.statItem="functionsPv",b.loadByDate=function(a,c){b.startDate=a,b.endDate=c,b.cloudStatCondition="day",e(a,c)},b.loadRecent=function(){b.cloudStatCondition="hour",e()},b.loadCurrent=function(){"day"==b.cloudStatCondition?b.loadByDate(b.startDate,b.endDate):b.loadRecent()},c.then(function(){b.$watch("statItem",function(){b.loadCurrent()})})}]),cloudMod.controller("CloudOnlineCtrl",["$http","$scope","App","SchemaLoader","$modal",function(a,b,c,d,e){var f="/1.1/functions/_CloudCodeSnippets";b.funcDef={type:"func"},b.hookTypes=["beforeSave","afterSave","afterUpdate","beforeDelete","afterDelete","onVerified","onLogin"],b.list=function(){a.get(f,{headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key)}).success(function(a){angular.forEach(a,function(a){a.typeDisplay=a.type,"func"==a.type&&(a.typeDisplay="function"),"global"==a.type&&(a.name="Global Context"),angular.forEach(a.current,function(b){0==b.prod&&$.extend(a,b)})}),b.funcs=a})},b.save=function(){b.saveDisabled=!0;var c=f,d={context:g.getValue(),comment:b.funcDef.comment,type:b.funcDef.type};d.name=b.funcDef.name,"hook"==b.funcDef.type&&(d.action=b.funcDef.action);var e="post";b.funcDef.id&&(e="put",c+="/"+b.funcDef.id),a({url:c,method:e,headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key),data:d}).success(function(a){a.id&&(b.funcDef.id=a.id),showmsg("已更新到测试环境中"),b.list()}).finally(function(){b.saveDisabled=!1})},b.setCurrent=function(a){b.funcDef=a};var g;b.edit=function(a){b.setCurrent(a),b.saveDisabled=!1;var c=e({scope:b,template:"views/modal/cloud-online-modal.html",show:!0,backdrop:"static"});c.$scope.$on("modal.show",function(){function a(a,b,c,d){b=b||0,c=c||0,d=d||1/0,a.each(function(){function a(){setTimeout(function(){g.html(e.val().replace(/ /g,"&nbsp"));var a=Math.min(d,g.width()+b);d>a&&e.scrollLeft(0),e.val()?$(e).css("min-width",""):$(e).css("min-width",c+"px"),e.width(a)},0)}var e=$(this),f=btoa(Math.floor(Math.random()*Math.pow(2,64))),g=$('<span id="'+f+'">'+e.val()+"</span>").css({display:"none","font-family":e.css("font-family"),"font-size":"96%"}).appendTo("body");a(),e.keydown(a)})}g=ace.edit("form-console-content"),g.setTheme("ace/theme/textmate"),g.getSession().setMode("ace/mode/javascript"),a($(".cc-func-input"),0,66,500)})},b.create=function(){b.edit({type:"func"})},b.publish=function(){b.saveDisabled=!0,a({url:f+"/"+b.funcDef.id+"/publish",method:"post",headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key)}).success(function(){showmsg("已发布到生产环境中"),b.list()}).finally(function(){b.saveDisabled=!1})},b.getProd=function(a){b.setCurrent(a);var c={};a.current.length>1&&($.extend(c,a),angular.forEach(c.current,function(a){1==a.prod&&(c.contexts=[a],c.contexts[0].createdAt=moment(c.contexts[0].createdAt).format("YYYY-MM-DD HH:MM:SS"))})),b.funcHistory=c,e({template:"views/modal/cloud-function-history-modal.html",show:!0,scope:b})},b.getHistory=function(c){b.setCurrent(c),a.get(f+"/"+c.id+"/history",{headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key)}).success(function(a){a.typeDisplay=a.type,"func"==a.type&&(a.typeDisplay="function"),"global"==a.type&&(a.name="Global Context"),angular.forEach(a.contexts,function(a){a.createdAt=moment(a.createdAt).format("YYYY-MM-DD HH:MM:SS")}),b.funcHistory=a,e({template:"views/modal/cloud-function-history-modal.html",show:!0,scope:b})})},b.delete=function(c){b.setCurrent(c);var d=c.action||"";d&&(d=" "+d);var e=window.confirm("将在测试和生产环境下都删除函数 "+c.name+d+"，确认？");e&&a({url:f+"/"+b.funcDef.id,method:"delete",headers:getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key)}).success(function(){b.list()})},b.editRun=function(a){b.saveDisabled=!1,b.cloudRun={body:"{}",env:0},b.setCurrent(a);var c=e({scope:b,template:"views/modal/cloud-online-run.html",show:!0,backdrop:"static"});c.$scope.$on("modal.show",function(){g=ace.edit("form-console-content"),g.setTheme("ace/theme/textmate"),g.getSession().setMode("ace/mode/json")})},b.run=function(){b.saveDisabled=!0;var c=getApiRequestHeader(b.currentApp.app_id,b.currentApp.master_key);c["X-AVOSCloud-Application-Production"]=Number(b.cloudRun.env),a({url:"/1.1/functions/"+b.funcDef.name,method:"post",headers:c,data:g.getValue()}).success(function(a){b.cloudRun.result=a}).finally(function(){b.saveDisabled=!1})},c.then(function(){b.list(),d.get().then(function(a){b.classes=a})})}]),function(){"use strict";angular.module("messageMod",["appMod"]),angular.module("messageMod").config(["$routeProvider",function(a){a.when("/message/realtime/stat",{templateUrl:"views/messaging/realtime-stat.html",controller:"MessageCtrl"}).when("/message/realtime/tool",{templateUrl:"views/messaging/realtime-tool.html",controller:"RealtimeToolCtrl"}).when("/message/push/create",{templateUrl:"views/messaging/push-create.html",controller:"PushCtrl"}).when("/message/push/conf",{templateUrl:"views/messaging/app-push-set.html",controller:"PushConfigCtrl"}).when("/message/push/tool",{templateUrl:"views/messaging/push-tool.html",controller:"PushToolCtrl"}).when("/message/realtime/conf",{templateUrl:"views/messaging/realtime-config.html",controller:"RealtimeConfigCtrl"}).otherwise({redirectTo:"/message/realtime/stat"})}])}(),angular.module("messageMod").controller("PushCtrl",["$scope","$http","$location","filterFilter","apps","datas",function(a,b,c,d,e,f){function g(){angular.forEach(a.datas.clas,function(b){return"_Installation"==b.name?void(a.currentCla=b):void 0})}var h=$(".datetimepicker").datetimepicker();h.show();var i=ace.edit("form-push-content");i.setTheme("ace/theme/github"),a.deviceType="all",$(function(){$("#form-push-file").change(function(){a.uploadPushFile()})}),a.msgtype="text",a.$watch("msgtype",function(){i.getSession().setMode("json"==a.msgtype?"ace/mode/json":"ace/mode/text")}),a.certType="prod",a.datas=f,a.pushconditions=[{field:"",condition:"",value:""}],a.querys=PUSH_QUERYS,a.$watch("datas.clas",function(){a.datas.clas&&g()}),a.pushTime=moment().format("YYYY-MM-DD HH:mm:ss"),a.expireTime=moment().format("YYYY-MM-DD HH:mm:ss"),a.addCondition=function(){var b={field:"",condition:"",value:""};a.pushconditions.push(b)},a.uploadPushFile=function(){var b=$("#form-push-file")[0];if(b.files.length>0){var c=b.files[0],d=c.name,e=new AV.File(d,c);e.save().then(function(b){showmsg("文件上传成功"),a.pushFileUrl=b._url})}},a.pushmsg=function(){"ios"!=a.deviceType&&"all"!=a.deviceType||a.app.cert_file_path||showmsg("ios需要先上传 apple SSL certificate 文件 ",AVC.Error);var b,c=new AV.Query(AV.Installation);if(a.msg=$.trim(i.getValue()),""!=a.msg){if("json"==a.msgtype)try{b=JSON.parse(a.msg)}catch(d){return void showmsg("JSON 数据格式错误",AVC.Error)}else b={alert:a.msg};"all"!=a.deviceType&&c.equalTo("deviceType",a.deviceType),"ios"==a.deviceType&&(a.iosbadge&&(b.badge="Increment"),a.iossound&&(b.sound=a.iossound)),"all"!=a.pushTarget&&angular.forEach(a.pushconditions,function(b){var d=b.value;"Date"==a.currentCla.schema[b.field].type&&(d=convertToType(b.value,a.currentCla.schema[b.field].type).val),c[MAPJSAPI[b.condition]](b.field,d)}),a.noactivecheck&&c.lessThan("updatedAt",new Date(moment().add("day",-a.noactivedays).toJSON())),a.pushFileUrl&&(b.file_url=a.pushFileUrl);var e={data:b,where:c};if("ios"==a.deviceType&&(e.prod=a.certType),1==a.pushTimeSelect&&(e.push_time=moment.utc(moment($("#push-time").data("DateTimePicker").getDate()).add("hours",8))),1==a.expireIntervalSelect&&(e.expiration_time=moment.utc(moment($("#expire-time").data("DateTimePicker").getDate()).add("hours",8))),2==a.expireIntervalSelect){var f=1==a.expireUnit?60*a.expireNum*60:60*a.expireNum*60*24;e.expiration_interval=f}AV.Push.send(e,{success:function(){showmsg("发送成功，请注意查看推送结果")},error:function(a){showmsg(a.message,AVC.Error)}})}},a.removeCondition=function(b){a.pushconditions.splice(b,1)}}]),function(){"use strict";function a(a,b){a.queryStatus=function(){b.get(purl+"data/rtm/"+getParam().appid+"/device",{params:{iid:a.userID}}).success(function(b){a.realStatus=b})}}angular.module("messageMod").controller("PushToolCtrl",["$scope","$http",a])}(),function(){"use strict";function a(a,b,c,d){a.$watch("apps.all",function(){angular.forEach(c.all,function(b){return b.app_id==getParam().appid&&b.cert_file_path?(a.cert_file_path=b.cert_file_path.prod,void(a.cert_file_path_test=b.cert_file_path.dev)):void 0})}),a.uploadresults=function(b,c){if(c&&b.length>0)try{b=JSON.parse(b),b.error?showmsg(b.error,AVC.Error):(d.get().then(function(b){a.currentApp=b}),a.cert_file_path=b.cert_file_path.prod,showmsg("上传成功"))}catch(e){showmsg("上传失败",AVC.Error)}},a.uploadresultstest=function(c,d){if(d&&c.length>0)try{c=JSON.parse(c),c.error?showmsg(c.error,AVC.Error):b(function(){a.$apply(function(){a.cert_file_path_test=c.cert_file_path.dev,showmsg("上传成功")})},100)}catch(e){showmsg("上传失败",AVC.Error)}}}angular.module("messageMod").controller("PushConfigCtrl",["$scope","$timeout","apps","AppModel",a])}(),angular.module("messageMod").controller("MessageCtrl",["$scope","$http","$timeout",function(a,b,c){function d(){return{chart:{type:"areaspline"},title:{x:0},yAxis:{allowDecimals:!1,min:0,gridLineColor:"#f4f1f1",title:{text:""},labels:{overflow:"justify"}},xAxis:{labels:{overflow:"justify"},minTickInterval:864e5},tooltip:{},plotOptions:{areaspline:{fillOpacity:.4}},credits:{enabled:!1},series:[{data:[]}]}}function e(a,b){return"undefined"==typeof b?"data-new":b>a?"data-smaller":a>b?"data-bigger":void 0}a.statItem="push_session",a.dataTrend={s:1};var f,g=0,h=d();$.extend(h.xAxis,{type:"datetime",labels:{formatter:function(){return moment(this.value).format("YYYY-MM-DD")},overflow:"justify",maxStaggerLines:1}}),$.extend(h.tooltip,{formatter:function(){var a=this.x,b=this.y;a=moment(this.x).format("YYYY-MM-DD");var c=a+": "+b;return c}}),a.startTime=moment().subtract("days",7).toDate(),a.endTime=moment().subtract("days",1).toDate(),a.getRealtimeData=function(){function d(){a.dataTrend={},g++,b.get(h).success(function(b){1==g&&(new Odometer({el:$(".transition-number.logins")[0],value:b.logins-Math.floor(Math.random()*b.logins*.001)+1,format:"(,ddd).dd"}),new Odometer({el:$(".transition-number.sessions")[0],value:b.sessions-Math.floor(Math.random()*b.sessions*.001)+1,format:"(,ddd).dd"}),new Odometer({el:$(".transition-number.udirect-sessions")[0],value:b["udirect-sessions"]-Math.floor(Math.random()*b["udirect-sessions"]*.001)+1,format:"(,ddd).dd"}),new Odometer({el:$(".transition-number.directs")[0],value:b.directs-Math.floor(Math.random()*b.directs*.001)+1,format:"(,ddd).dd"})),$("#message-numbers .logins").text(b.logins),$("#message-numbers .sessions").text(b.sessions),$("#message-numbers .directs").text(b.directs),$("#message-numbers .udirect-sessions").text(b["udirect-sessions"]),a.dataTrend.logins=e(b.logins,i.logins),a.dataTrend.sessions=e(b.sessions,i.sessions),a.dataTrend.directs=e(b.directs,i.directs),a.dataTrend["udirect-sessions"]=e(b["udirect-sessions"],i["udirect-sessions"]),i=b,f=c(d,1e4)})}var h=purl+"data/rtm/"+getParam().appid+"/stats",i={};d(),a.$on("$destroy",function(){c.cancel(f)})},a.getStatData=function(c){c=c||a.statItem;var d=remoteURL+"load_stats_data",e={appid:getParam().appid,start_date:moment(a.startTime).format("YYYYMMDD"),end_date:moment(a.endTime).format("YYYYMMDD"),stats:c};b.get(d,{params:e}).success(function(b){h.series=b.stats,h.series&&h.series[0]&&1==h.series.length&&(h.series[0].name=moment(a.startTime).format("YYYY-MM-DD")+"至"+moment(a.endTime).format("YYYY-MM-DD")),h.series&&h.series[0]&&(h.yAxis.labels.step=Math.round(h.series[0].data.length/10),angular.forEach(h.series,function(b){b.pointStart=moment.utc(moment(a.startTime).format("YYYY-MM-DD"),"YYYY-MM-DD").valueOf(),b.pointInterval=864e5}),h.series[0].data.length>30&&(h.plotOptions.areaspline.marker={enabled:!1})),$("#chart-container").highcharts(h)})},a.loadByDate=function(b,c){a.$apply(function(){a.startTime=b,a.endTime=c,a.getStatData()})},a.getRealtimeData(),a.$watch("statItem",function(){a.getStatData()})}]),function(){"use strict";function a(a,b){a.queryStatus=function(){b.get(purl+"data/rtm/"+getParam().appid+"/device",{params:{iid:a.userID,session:1}}).success(function(b){a.realStatus=b})}}angular.module("messageMod").controller("RealtimeToolCtrl",["$scope","$http",a])}(),function(){"use strict";function a(a,b){a.saveOfflinePushMessage=function(){b.put(purl+"clients/self/apps/"+getParam().appid+"/update-chat-push",{msg:a.app.chat_push_msg}).success(function(){showmsg("保存成功")})}}angular.module("messageMod").controller("RealtimeConfigCtrl",["$scope","$http",a])}(),angular.module("dataQueryMod",["appMod","dataMod.service"]),angular.module("dataQueryMod").config(["$routeProvider",function(a){a.when("/:claid",{templateUrl:"views/cla-query.html",controller:"SingleBigDataQueryCtrl"}).otherwise({redirectTo:"/_User"})}]),angular.module("dataQueryMod").controller("BigDataQueryCtrl",["$http","$scope","SchemaLoader","$routeParams","claQueryService","$location","$timeout","BigqueryService",function(a,b,c,d,e,f,g,h){var i;b.$on("$viewContentLoaded",function(){i=ace.edit("form-console-content"),i.setTheme("ace/theme/textmate"),i.getSession().setMode("ace/mode/sql"),b.claQueryService.editor=i;var a=f.path().substring(1);0===a.indexOf("_")&&(a="`"+a+"`"),i.setValue("select * from "+a,1),b.currentPage=1,b.queryDatas=[]}),b.claQueryService=e,b.usedQuery=localStorage["bigquery-sql"]&&JSON.parse(localStorage["bigquery-sql"])||[],b.loadSchema=function(){b.datas={},b.currentPage=1,c.get().then(function(a){a&&0!=a.length||showmsg("应用正在创建中,请稍后刷新"),b.datas.clas=a})},b.claOrder=function(a){return a.name.toLowerCase()};var j="/1.1/bigquery/job";b.useQuery=function(a){i.setValue(a,1),$("#used-query").collapse("hide"),$("#create-query").collapse("show")},b.query=function(c){function d(){b.queryDisabled&&(b.queryEclipased=(Date.now()-b.queryStart)/1e3,g(d,100))}b.currentJobId=-1,"undefined"!=typeof c&&(b.currentPage=c),b.queryDisabled=!0,b.queryEclipased=0,b.queryStart=Date.now(),d(),b.error=null,b.queryDatas=null,a.post(j,{appId:getParam().appid,jobConfig:{sql:i.getValue().trim()}}).success(function(a){-1==$.inArray(i.getValue().trim(),b.usedQuery)&&(b.usedQuery.length>4&&b.usedQuery.shift(),b.usedQuery.push(i.getValue().trim()),localStorage["bigquery-sql"]=JSON.stringify(b.usedQuery)),b.getJob(a.id)})},b.getJob=function(c){function d(){a.get(j+"/"+c,{params:{limit:20,anchor:20*(b.currentPage-1)}}).success(function(a){"RUNNING"==a.status?g(d,1e3):"ERROR"==a.status?(b.queryDisabled=!1,b.error=a.error):(b.queryDisabled=!1,b.currentJobId=a.id,b.totalPage=Math.ceil(a.previewCount/20),b.totalCount=a.totalCount,b.previewCount=a.previewCount,b.queryDatas=a.result)}).error(function(){b.queryDisabled=!1})}d()},b.addField=function(a){var b=i.getValue();i.insert(/^select \S{1,} from/.test(b)?","+a:a)},b.saveResult=function(){h.saveResultAsCla(b.currentJobId,b.saveClaName).then(function(){b.error="",showmsg("保存为 Class 成功")},function(a){b.error=a}),$("#dataquery-save-result").modal("hide")},b.export=function(){a.post(purl+"bigquery/job/"+b.currentJobId+"/export").success(function(a){downloadURL(a.path)})},b.loadSchema(),b.$watch("currentPage",function(){b.currentJobId&&-1!=b.currentJobId&&b.getJob(b.currentJobId)})}]),angular.module("dataQueryMod").controller("SingleBigDataQueryCtrl",["$http","$scope","$routeParams","SchemaLoader","claQueryService",function(a,b,c,d,e){d.get().then(function(a){angular.forEach(a,function(a){a.name==c.claid&&(e.currentQueryCla=a)})})}]),angular.module("dataQueryMod").factory("claQueryService",[function(){return{currentQueryCla:{}}}]),angular.module("dataMod",["appMod","dataMod.service","dataMod.singleClassMod","dataMod.column","dataMod.import"]),angular.module("dataMod").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/cla-nodata.html"}).when("/:claid",{templateUrl:"views/cla.html",controller:"SingleClassCtrl"}).when("/:claid/:parentCla/:objid",{templateUrl:"views/cla.html",controller:"SingleClassCtrl"}).when("/:claid/:parentCla/:objid/:column",{templateUrl:"views/cla.html",controller:"SingleClassCtrl"}).when("/:claid/:parentCla/:objid/:column/addexist",{templateUrl:"views/cla.html",controller:"SingleClassCtrl"})}]),angular.module("dataMod").controller("DataBrowserCtrl",["$scope","$http","$routeParams","$route","Schema","SchemaLoader","$translate","$location",function(a,b,c,d,e,f,g,h){function i(b){for(var c=0;c<a.datas.clas.length;c++)if(a.datas.clas[c].name==b)return void a.datas.clas.splice(c,1)}a.datas={},a.relcla={},a.fieldTypes=CTYPES,a.claModalTpl="views/cla-modal.html",a.setModalTpl=function(b){a.claModalTpl="views/"+b},a.$on("$routeChangeSuccess",function(){var b=d.current.params;b.parentCla?a.relcla[b.parentCla]={name:b.claid}:a.relcla={}}),a.loadSchema=function(){a.schemaLoader=f,a.schemaLoader.fetch().then(function(b){b&&0!=b.length||showmsg("应用正在创建中,请稍后刷新"),a.datas.clas=b})},a.loadSchema(),a.location=h,a.claOrder=function(a){return a.name.toLowerCase()},a.dropClass=function(){var b=window.confirm(g("DATA_CLASS_DROP_TIP"));if(b){var d=new e;d.id=c.claid,d.$delete(function(){i(c.claid),a.$broadcast("dropClass")})}},a.createClass=function(){var b=$("#createClass input:text");if(!/^[a-zA-Z][\w]*$/.test(b.val()))return!1;var c=new e;c.class_name=b.val(),c.class_type=a.classType?"log":"normal",c.$save(function(b){b.rows_count=0,a.datas.clas.push(b)}),b.val(""),$("#createClass").modal("hide")},a.getClassMeta=function(){},a.$on("loadschema",a.loadSchema),a.getClaNumStr=function(a){return a>=1e9?(a/1e9).toFixed(1).replace(/\.0$/,"")+"b":a>=1e6?(a/1e6).toFixed(1).replace(/\.0$/,"")+"m":a>=1e3?(a/1e3).toFixed(1).replace(/\.0$/,"")+"k":a}}]);var grid;angular.module("dataMod.singleClassMod",["dataMod.service"]),angular.module("dataMod.singleClassMod").controller("SingleClassCtrl",["$scope","$http","$location","$routeParams","filterFilter","$translate","$compile","App","$q","$modal","$timeout","$window",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){{var c=grid.getActiveCell(),d=c.cell,e=c.row,f=grid.getColumns()[d];a.cladatas[e][f.field]}a.acl.value=b.toJSON(),a.cladatas[e].ACL=b.toJSON(),a.saveRow(e,d,b.toJSON(),f,a.cladatas[e])}function n(){var b=grid.getActiveCell(),c=b.cell,d=b.row,e=grid.getColumns()[c],f=a.cladatas[d][e.field];return f}function o(){if(a.schemaBak={},angular.copy(a.currentCla.schema,a.schemaBak),a.state.hiddenColumns=[],angular.forEach(a.schemaBak,function(a){a.columnView=!0
}),localStorage["columns-view-"+getParam().appid+"-"+a.currentCla.name]){try{a.state.hiddenColumns=JSON.parse(localStorage["columns-view-"+getParam().appid+"-"+a.currentCla.name])}catch(b){}angular.forEach(a.schemaBak,function(b,c){a.state.hiddenColumns.indexOf(c)>-1&&(b.columnView=!1)})}}function p(b){b=angular.copy(b,[]);for(var c=b.length-1;c>=0;c--)if(b[c]){var d=b[c],e=c;a.state.hiddenColumns.indexOf(d.field)>-1&&b.splice(e,1)}return b}function q(){function b(a,b){return a+"<span class=data-type>"+b+"</span>"}function c(a,c){if(e[a]){var c=c||{id:a,field:a,name:b(a,e[a].type),width:k,sortable:!0};c.toolTip=e[a].comment,g&&-1!==g.indexOf(a)?d[g.indexOf(a)]=c:d.push(c)}}var d=[];if(a.currentCla&&a.currentCla.schema||(a.columnDefs=d),a.currentCla&&a.currentCla.schema){var e=a.currentCla.schema,f=0;angular.forEach(e,function(){f++});var g;g=localStorage["columns-"+getParam().appid+"-"+a.currentCla.name];try{g=g&&JSON.parse(g)}catch(h){}if(window.localStorage&&g){for(var i=0;i<g.length;i++)e[g[i]]||(g.splice(i,1),localStorage["columns-"+getParam().appid+"-"+a.currentCla.name]=JSON.stringify(g));angular.forEach(e,function(b,c){g.indexOf(c)<0&&(g.push(c),localStorage["columns-"+getParam().appid+"-"+a.currentCla.name]=JSON.stringify(g))})}var j=$("#clas").width()-25,k=parseInt(j/f);k=Math.max(200,k),c("objectId",{id:"objectId",field:"objectId",name:b("objectId","String"),width:k}),angular.forEach(e,function(d,e){-1===["createdAt","updatedAt","objectId"].indexOf(e)&&("_File"==a.currentCla.name?c(e,{id:e,field:e,name:b(e,d.type),width:k}):"Boolean"==d.type?c(e,{id:e,field:e,name:b(e,d.type),width:k,editor:Slick.Editors.YesNoSelect,sortable:!0}):"Relation"==d.type?c(e,{id:e,field:e,name:b(e,d.type),width:k}):"Pointer"==d.type?c(e,{id:e,field:e,name:b(e,d.type),width:k,editor:Slick.Editors.Text}):"File"==d.type?c(e,{id:e,field:e,name:b(e,d.type),width:k}):"ACL"==d.type?c(e,{id:e,field:e,name:b(e,d.type),width:k,editor:Slick.Editors.Text}):c(e,{id:e,field:e,name:b(e,d.type),width:k,editor:Slick.Editors.Text,sortable:!0}))}),c("createdAt"),c("updatedAt"),d.forEach(function(b){b.sortable=!1;var c="log"===a.currentCla["class-type"]?!0:!1;b.header={menu:{items:[{title:"升序",command:"sort-asc"},{title:"降序",command:"sort-desc"},{title:"编辑",command:"edit"},{title:"重命名",command:"rename",disabled:c},{title:"删除",command:"delete"}]}}}),o(),a.columnDefs=p(d)}}function r(){a.$watch("currentCla.schema",q,!0)}function s(){function c(b,c,d){$(b.target).parents(".file-td-wrapper").find('input[type="file"]').off("change"),$(b.target).parents(".file-td-wrapper").find('input[type="file"]').change(function(){if($(this).val()&&$(this)[0].files.length>0){var b=$(this)[0].files[0],e=new AV.File(b.name,b);e.save().then(function(b){if("_File"==a.currentCla.name&&"url"==grid.getColumns()[d].field)x();else{var e=b,f=new AV.File(e._name);f.id=e.id,f._url=e._url,f.__type="File",a.saveRow(c,d,f,grid.getColumns()[d],a.cladatas[c])}},function(a){a&&showmsg(a.message,AVC.Error)})}})}function d(b,c){a.deleteCellFile(b,c)}function e(c){b({method:"post",url:purl+"requestEmailVerify",headers:{"X-AVOSCloud-Application-Id":a.app.app_id,"X-AVOSCloud-Application-Key":a.app.app_key,_MasterKey:a.app.master_key},data:{email:c}}).success(function(){showmsg("发送验证邮件成功")})}if(a.cladatas){var f={editable:!0,enableAddRow:!1,enableCellNavigation:!0,asyncEditorLoading:!1,autoHeight:!0,autoEdit:!1,enableTextSelectionOnCells:!0,defaultFormatter:a.getDisplay,defaultEditFormatter:a.getEditDisplay,defaultValidator:convertToType,currentScope:a},g=new Slick.CheckboxSelectColumn({cssClass:"slick-cell-checkboxsel"});a.columnDefs.unshift(g.getColumnDefinition()),grid=new Slick.Grid("#myGrid",a.cladatas,a.columnDefs,f),grid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow:!1})),grid.registerPlugin(g),grid.onCellChange.subscribe(function(b,c){var d=c.grid.getColumns()[c.cell].field;a.saveRow(c.row,c.cell,a.cladatas[c.row][d],c.grid.getColumns()[c.cell],c.item)}),grid.onColumnsReordered.subscribe(function(b,c){for(var d=[],e=c.grid.getColumns(),f=1;f<e.length;f++)d.push(e[f].field);a.currentCla&&d.length&&localStorage&&(localStorage["columns-"+getParam().appid+"-"+a.currentCla.name]=JSON.stringify(d)),q()}),grid.onBeforeEditCell.subscribe(function(b,c){var d=a.currentCla.name,e=c.grid.getColumns()[c.cell].field,f=c.item;return"_Role"==d&&"name"==e&&f.objectId?!1:"log"===a.currentCla["class-type"]&&f.objectId?!1:void 0});var h=new Slick.Plugins.HeaderMenu,i=j({scope:a,template:"views/modal/cla-column-delete-modal.html",show:!1}),k=j({scope:a,template:"views/modal/cla-column-rename-modal.html",show:!1}),m=j({scope:a,template:"views/modal/cla-column-edit-modal.html",show:!1});h.onCommand.subscribe(function(b,c){a.currentColumn=c.column.id;var d=c.command;"delete"==d?i.show():"sort-asc"==d?(a.sortInfo={directions:["asc"],fields:[a.currentColumn]},x()):"sort-desc"==d?(a.sortInfo={directions:["desc"],fields:[a.currentColumn]},x()):"rename"==d?k.show():"edit"==d&&m.show()}),grid.registerPlugin(h),grid.onClick.subscribe(function(b,f){var g=f.row,h=f.cell,i=f.grid.getColumns()[f.cell].field;if(a.currentCla.schema[i]){{a.currentCla.schema[i].type}if($(b.target).hasClass("file-upload"))c(b,g,h);else if($(b.target).hasClass("file-delete")){var k=a.cladatas[g].objectId;d(k,i)}else if($(b.target).hasClass("cell-reset-password"))a.requestPasswordReset(a.cladatas[g].email);else if($(b.target).hasClass("cell-verify-email"))e(a.cladatas[g].email);else if($(b.target).hasClass("cell-acl-edit")){a.acl={userRead:!0,userWrite:!0,roleRead:!0,roleWrite:!0,allWrite:!0,allRead:!0,value:a.cladatas[g][i]};var l=j({scope:a.$new(),template:"views/modal/cla-acl-modal.html",show:!0,container:"#cla_data",prefixEvent:"aclModal"});a.aclEditModal=l}else $(b.target).hasClass("show-row-detail")&&a.showRowDetail(g,h)}}),grid.onKeyDown.subscribe(function(b,c){var d=c.row,e=c.cell,f=c.grid.getColumns()[c.cell].field;if(13==b.which){if(!f||!a.currentCla.schema[f])return;var g=a.currentCla.schema[f].type,h=grid.getCellNode(d,e);f=f.toLowerCase(),g=g.toLowerCase(),"objectid"==f&&(a.showRowDetail(d,e),$("#one-row-detail-modal").modal("show")),"pointer"==g||"relation"==g?$(h).find("a").click():"file"==g&&l.open($(h).find("a").attr("href"))}})}}function t(){grid.setData(a.cladatas),grid.setColumns(a.columnDefs),grid.updateRowCount(),grid.render()}function u(b,c,d){var e=a.currentCla.schema[c].type;if(d=convertToType(d,e).val,"Pointer"==e){var f=a.currentCla.schema[c].className,g=AV.Object.extend(f),h=new g;h.id=d,b.set(c,h),d&&""!=d.trim()||b.set(c,null)}else"ACL"!=c&&b.set(c,d);"ACL"==c&&b.setACL(d)}function v(b,c,e,f,g){if("_User"!=a.currentCla.name||"password"!=f.field||e&&""!=$.trim(e)){var h=!0,i=g.objectId,j=f.field,l=(a.currentCla.schema[f.field].type,a.cladatas[b]),m=AV.Object.extend(a.currentCla.name),n=new m;i&&""!=$.trim(i)&&(h=!1,n.set("objectId",i)),e&&"File"==e.__type?u(n,j,e):h?angular.forEach(g,function(a,b){u(n,b,a)}):u(n,j,e),n.save(null,{success:function(c){k(function(){$.extend(l,c.toJSON())}),h&&n.fetch({success:function(c){k(function(){$.extend(a.cladatas[b],c.toJSON())})}});var f={};if(f[j]=e,h&&d.parentCla&&d.column){var g=AV.Object.extend(d.parentCla),i=new AV.Query(g);i.get(d.objid,{success:function(a){var b=a.relation(d.column);b.add(n),a.save()},error:function(a){showmsg(a.message,AVC.Error)}})}k(function(){h&&(a.currentCla.rows_count+=1)})},error:function(a,b){showmsg(b.message,AVC.Error)}})}}function w(){function b(){a.schemaarr=[],a.currentCla&&angular.forEach(a.currentCla.schema,function(b,c){var d={};d.columnname=c,d.columntype=b.type,d.order="objectId"==c?0:isSystemFields(c)?2:1,b.className&&(d.classname=b.className),a.schemaarr.push(d)})}a.querys=QUERYS,a.predicate="-updatedAt",a.$watch("currentCla.schema",b,!0),a.currentPage=0,a.pernum=$.cookie("pernum")||20,a.allSelected=!1,a.schemaLoader.get().then(function(){x(),b()}),a.$on("dropClass",function(){a.cladatas=[],a.currentCla.schema=null,a.schemaarr=[]}),a.getClaMeta=function(){a.schemaLoader.fetch().then(function(c){a.datas.clas=c,x(),b()})},a.$on("getClaMeta",a.getClaMeta)}function x(){angular.forEach(a.datas.clas,function(b){return b.name==d.claid?(a.currentCla=b,d.parentCla&&d.objid&&d.column&&(a.parentCla=d.parentCla,a.parentColumn=d.column,/\/addexist$/.test(c.path())?a.addExistToRelation=!0:a.addNewToRelation=!0),a.relationURL="#/"+d.claid+"/"+d.parentCla+"/"+d.objid+"/"+d.column,void(d.parentCla?y(d.parentCla,d.objid,d.column):d.objid?y(-1,d.objid,null):y())):void 0})}function y(b,c,d){var e,f,g=a.currentPage*a.pernum,h=a.pernum;b&&c&&d&&!a.addExistToRelation?(e=AV.Object.extend(b),f=new AV.Query(e),f.get(c,{success:function(c){var e=c.relation(d);f=e.query(),B(f),a.sortInfo?"asc"==a.sortInfo.directions[0]?f.ascending(a.sortInfo.fields[0]):f.descending(a.sortInfo.fields[0]):f.descending("updatedAt"),f.skip(g),f.limit(h),f.descending("updatedAt"),f.find({success:function(b){a.$apply(function(){a.cladatas=JSON.parse(JSON.stringify(b))})}}),f.count({success:function(c){a.$apply(function(){a.relcla[b].count=c})},error:function(a){showmsg(a.message,AVC.Error)}})}})):(e=AV.Object.extend(a.currentCla.name),f=new AV.Query(e),c&&!a.addExistToRelation&&f.equalTo("objectId",c),B(f),a.sortInfo?"asc"==a.sortInfo.directions[0]?f.ascending(a.sortInfo.fields[0]):f.descending(a.sortInfo.fields[0]):f.descending("updatedAt"),f.skip(g),f.limit(h),f.find({success:function(b){a.$apply(function(){var c=JSON.parse(JSON.stringify(b));a.cladatas=c})},error:function(a){showmsg(a.message,AVC.Error)}}),f.count({success:function(b){a.$apply(function(){a.currentCla.rows_count=b})},error:function(a){showmsg(a.message,AVC.Error)}}))}function z(a,b,c,d,e){{var f=c||"",g=c||"",h=e.objectId;d.field}if(h)return'<a class="file-link" target="_blank" href="'+f+'" >'+g+"</a>";var i='<div class="file-td-wrapper"    ><a class="file-link" target="_blank" href="'+f+'" >'+g+'</a><span class="cell-form"><input type="file" name="file" class="file-input" > <button class="btn btn-default btn-xs cell-btn file-upload fake-uploader">上传</span></button>';return f&&(i+='<button class="btn btn-default btn-xs cell-btn file-delete " ><span class="glyphicon glyphicon-remove file-delete"></span></button>'),i+="<span> </div>"}function A(b){for(var c=0;c<a.cladatas.length;c++)if(a.cladatas[c].objectId==b)return void a.cladatas.splice(c,1)}function B(b){for(var c=0;c<a.conditions.length;c++){var d=a.conditions[c].field;if(""==d.trim())return;var e=a.conditions[c].condition,f=a.conditions[c].value;if(QUERY_TYPES[e])f="Number"==QUERY_TYPES[e]?Number(f):String(f);else if(a.currentCla.schema[d].type&&"Pointer"==a.currentCla.schema[d].type){var g=AV.Object.extend(a.currentCla.schema[d].className),h=new g;h.set("objectId",f),f=h}else f=convertToType(f,a.currentCla.schema[d].type).val;b[MAPJSAPI[e]]&&b[MAPJSAPI[e]](d,f)}}function C(){$.cookie("pernum",a.pernum),d.parentCla&&d.objid&&d.column?y(d.parentCla,d.objid,d.column):a.conditions.length&&""!=$.trim(a.conditions[0].value)?a.query():y()}$("#one-row-detail-modal").on("hidden.bs.modal",function(){grid.focus()}),grid=null,a.$compile=g,a.state={},a.queryUsersByName=function(b){if(b){var c=i.defer(),d=new AV.Query("User");d.contains("username",b);var e=new AV.Query("User");return e.equalTo("objectId",b),AV.Query.or(d,e).find({success:function(b){a.$apply(function(){var d=JSON.parse(JSON.stringify(b));a.aclTipUser=d,c.resolve(d)})}}),c.promise}},a.queryRolesByName=function(b){if(b){var c=i.defer(),d=new AV.Query("_Role");return d.contains("name",b),d.find({success:function(b){a.$apply(function(){var d=JSON.parse(JSON.stringify(b));a.aclTipRole=d,c.resolve(d)})}}),c.promise}},a.setUserACL=function(){var b;if(angular.forEach(a.aclTipUser,function(c){(c.username==a.acl.username||c.objectId==a.acl.username)&&(b=c)}),b){var c=new AV.ACL(n());c.setReadAccess(b.objectId,a.acl.userRead),c.setWriteAccess(b.objectId,a.acl.userWrite),m(c)}},a.setRoleACL=function(){var b;if(angular.forEach(a.aclTipRole,function(c){(c.name==a.acl.rolename||c.objectId==a.acl.username)&&(b=c)}),b){var c=new AV.ACL(n());c.setRoleReadAccess(b.name,a.acl.roleRead),c.setRoleWriteAccess(b.name,a.acl.roleWrite),m(c)}},a.setAllACL=function(){var b=new AV.ACL;b.setPublicReadAccess(a.acl.allRead),b.setPublicWriteAccess(a.acl.allWrite),m(b)},r();d.claid;a.$watch("[cladatas,columnDefs]",function(){"undefined"!=typeof a.cladatas&&(a.cladatas&&0==a.cladatas.length&&a.cladatas.push({}),a.columnDefs&&(grid?t():s()))},!0),a.$on("aclModal.hide",function(){a.aclEditModal&&a.aclEditModal.destroy()}),a.saveRow=v,h.then(function(){w()}),a.beforeFileUpload=function(b){a.$$phase?a.rootState.pendingRequest++:a.$apply(function(){a.rootState.pendingRequest++});var c=$(b.target).parents("form").find(":file").val().split("\\").pop();$(b.target).parents("form").attr("action","/1/files/"+c)},a.uploadCellResults=function(b,c,d,e){if(c&&b.length>0)try{var f=(grid.getCellFromEvent(e).row,grid.getCellFromEvent(e).cell);a.$$phase?a.rootState.pendingRequest--:a.$apply(function(){a.rootState.pendingRequest--});var g=JSON.parse(b),h=new AV.File(g.name);h.id=g.objectId,h._url=g.url,h.__type="File","_File"==a.currentCla.name&&"url"==grid.getColumns()[f].field&&x()}catch(e){}},a.deleteCellFile=function(b,c){var d=AV.Object.extend(a.currentCla.name),e=new d;e.set(c,null),e.set("objectId",b),e.save(null,{success:function(b){a.$apply(function(){for(var d=0;d<a.cladatas.length;d++)if(a.cladatas[d].objectId==b.id){var f=new AV.File;f.id=a.cladatas[d][c].id,f.destroy(),$.extend(a.cladatas[d],e.toJSON());break}})},error:function(a){a&&showmsg(a.message,AVC.Error)}})},a.getDisplay=function(b,c,d,e,f){var g=e.field,h=d;if("objectId"===g&&d)return'<a data-toggle="modal" data-target="#one-row-detail-modal" data-keyboard="true"  class="show-row-detail">'+d+"</a>";if(f.objectId&&"_User"==a.currentCla.name&&"password"==g)return f.email?'<span class="cell-has-btn">(hidden)</span> <button class="btn btn-default btn-xs cell-btn cell-btn-right cell-reset-password">请求重置</button> ':"(hidden) ";if(f.objectId&&"_User"==a.currentCla.name&&"email"==g&&f.email)return'<span class="cell-has-btn">'+f.email+'</span><button class="btn btn-default btn-xs cell-btn cell-btn-right cell-verify-email">请求验证</button> ';if("_File"==a.currentCla.name&&("url"==g||"File"==a.currentCla.schema[g].type))return z(b,c,d,e,f);if(!a.currentCla.schema[g])return h;switch(a.currentCla.schema[g].type){case"String":return h&&""!=$.trim(h)?(h+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";case"Number":return"undefined"==typeof h||""==$.trim(h)?"":h;case"Boolean":return"undefined"==typeof h||""==$.trim(h)?"":h;case"Date":return h&&""!=$.trim(h)?h.__type&&"Date"==h.__type?moment.utc(h.iso).format("YYYY-MM-DD HH:mm:ss"):moment.utc(h).format("YYYY-MM-DD HH:mm:ss"):"";case"Pointer":if(!f.objectId)return"";if("string"==typeof a.cladatas[b][g])return"";if(a.cladatas[b][g]){var i=a.cladatas[b][g].className,j=a.cladatas[b][g].objectId,k="#"+i+"/"+a.currentCla.name+"/"+j;return'<a href="'+k+'"    >'+j+" </a>"}return"";case"Relation":if(!f.objectId)return"";var i=a.cladatas[b][g]?a.cladatas[b][g].className:"",j=(a.currentCla.name,a.cladatas[b].objectId),k="#"+i+"/"+a.currentCla.name+"/"+j+"/"+g;return'<a href="'+k+'" >    Relations </a>';case"File":var l=a.cladatas[b][g]?a.cladatas[b][g].url:"",m=a.cladatas[b][g]?a.cladatas[b][g].name:"",j=a.cladatas[b].objectId;"function"==typeof m&&(m="");var n='<div class="file-td-wrapper"    ><a class="file-link" target="_blank" href="'+l+'" >'+m+'</a><span class="cell-form"><input type="file" name="file" class="file-input" > <button class="btn btn-default btn-xs cell-btn file-upload fake-uploader">上传</button>';return l&&(n+='<button class="btn btn-default btn-xs file-delete " ><span class="glyphicon glyphicon-remove file-delete"></span></button>'),n+="<span> </div>";case"GeoPoint":return"string"==typeof h?h:h?h.longitude+","+h.latitude:"";case"ACL":var o,n=' <button class="btn btn-default btn-xs cell-btn cell-acl-edit" >编辑</button> ';return o=h?"object"==typeof h?JSON.stringify(h):h+n:"",'<span class="acl-cell-text">'+o+"</span>"+n;case"Array":case"Object":return h?"object"==typeof h?JSON.stringify(h).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";default:return h}},a.getEditDisplay=function(b,c,d,e){var f=e.field,g=d;return"_User"==a.currentCla.name&&"password"==f?"":a.currentCla.schema[f]?"Date"==a.currentCla.schema[f].type?g&&""!=$.trim(g)?g.__type&&"Date"==g.__type?moment.utc(g.iso).format("YYYY-MM-DD HH:mm:ss"):moment.utc(g).format("YYYY-MM-DD HH:mm:ss"):moment().format("YYYY-MM-DD HH:mm:ss"):"Pointer"==a.currentCla.schema[f].type?g.objectId:"GeoPoint"==a.currentCla.schema[f].type?g?g.longitude+","+g.latitude:"0,0":"ACL"==a.currentCla.schema[f].type||"Object"==a.currentCla.schema[f].type||"Array"==a.currentCla.schema[f].type?g?JSON.stringify(g):"":g:g},a.showRelation=function(a,b,d,e){c.path(a+"/"+b+"/"+d+"/"+e)},a.showPointer=function(b,d){c.path(b+"/"+a.currentCla.name+"/"+d)},a.toggleSelectAll=function(){a.allSelected=!a.allSelected,$("#datas :checkbox:visible").prop("checked",a.allSelected)},a.emptyRows=[],a.requestPasswordReset=function(a){AV.Object.extend("_User").requestPasswordReset(a,{success:function(){showmsg("发送密码重置邮件成功")},error:function(a){showmsg(a.message,AVC.Error)}})},a.addRow=function(){a.cladatas.unshift({})},a.deleteRow=function(){var c=[];if(angular.forEach(grid.getSelectedRows(),function(b){a.cladatas[b]&&a.cladatas[b].objectId&&c.push(a.cladatas[b].objectId)}),0!=c.length){var e=window.confirm("确认删除所有选中的数据?");e&&b.delete(purl+"data/"+getParam().appid+"/classes/"+d.claid+"/rows/"+c.join(",")).success(function(){a.currentCla.rows_count-=c.length;for(var b=0;b<c.length;b++)A(c[b]);grid.setSelectedRows([])}).error(function(a){showmsg(a.error,AVC.Error)})}},a.deleteAllRows=function(){var c=window.confirm(f("DATA_DELETE_ALL_ROWS_TIP"));c&&b.delete(purl+"data/"+getParam().appid+"/classes/"+d.claid+"/rows").success(function(){a.cladatas=[],a.currentCla.rows_count=0})},a.showRowDetail=function(b){k(function(){a.currentRowData=syntaxHighlight(a.cladatas[b])})},a.updateExistObjectToRelation=function(b){var c=AV.Object.extend(d.parentCla),e=new c;e.id=d.objid;var f=AV.Object.extend(d.claid),g=e.relation(d.column),h=[];angular.forEach(grid.getSelectedRows(),function(b){if(a.cladatas[b]&&a.cladatas[b].objectId){var c=new f;c.id=a.cladatas[b].objectId,h.push(c)}}),g[b](h),0!=h.length&&e.save(null,{success:function(){"add"==b?location.hash=a.relationURL:"remove"==b&&x()}})},a.conditions=[{field:"",condition:"",value:""}],a.addCondition=function(){var b={field:"",condition:"",value:""};a.conditions.push(b)},a.reloadData=function(){window.location.reload()},a.query=function(b){"undefined"!=typeof b&&(a.currentPage=b),y(d.parentCla,d.objid,d.column)},a.removeCondition=function(b){a.conditions.splice(b,1)},a.hasNext=function(){if(a.currentCla&&a.currentCla.rows_count<=0)return!1;if(a.currentCla&&a.currentCla.rows_count>0){if(a.currentCla.rows_count<a.pernum)return!1;if(a.currentPage>=a.currentCla.rows_count/a.pernum-1)return!1}return!0},a.hasPrevious=function(){return a.currentPage<=0?!1:!0},a.loadpage=C,a.showNext=function(){a.currentPage++,C()},a.showPrevious=function(){a.currentPage--,C()},a.hasOpPermision=function(){return a.currentCla&&"normal"===a.currentCla["class-type"]},a.$on("loaddata",x)}]),function(){"use strict";function a(a,b){b.allVisible=!0,b.changeAllColumnVisible=function(){angular.forEach(b.schemaBak,function(a){a.columnView=!b.allVisible})},b.setColumnView=function(){b.currentCla.name,getParam().appid;b.state.hiddenColumns=[],angular.forEach(b.schemaBak,function(a,c){a.columnView||b.state.hiddenColumns.push(c)}),localStorage["columns-view-"+getParam().appid+"-"+b.currentCla.name]=JSON.stringify(b.state.hiddenColumns),window.location.reload()}}angular.module("dataMod").controller("ColumnVisibleCtrl",["$http","$scope",a])}(),$(function(){$(document).on("click",".fake-uploader",function(){$(this).parents(".file-td-wrapper").find('input[type="file"]').click()})}),angular.module("dataMod.import",[]).controller("DataImportCtrl",["$scope","$http","$timeout","$route",function(a,b,c){function d(e){b.get(purl+"importer/"+e).success(function(b){b.status&&"done"==b.status?(a.importError="",showmsg("导入完成，注意查看邮件通知"),$("#screen-tip").modal("hide"),setTimeout(function(){window.location.reload()},2e3)):b.status.indexOf("error")>-1?a.importError=b.status.split(":")[1]:(b.status.indexOf("importing")>-1||"ready"==b.status)&&(b.status.indexOf("importing")>-1&&(a.importPercent=b.status.split(":")[1]),c(function(){d(e)},1e3))}).error(function(){$("#screen-tip").modal("hide")})}a.import={},a.classFileChanged=function(){var b=$("#data-import-file")[0].files[0];c(function(){var c,d;b&&(d=b.name.substring(0,b.name.indexOf(".")),/^[a-zA-Z][\w]*$/.test(d)&&(c=d)),a.import.importClass=c})},a.createClass=function(){a.$broadcast("createclass")},a.appid=getParam().appid,a.importClassData=function(){if($("#import_class_data").hasClass("active")){if(!a.import.importClass)return showmsg("Class 名称不能为空",AVC.Error),!1;$("#import-submit").click()}else $("#import-relation-submit").click();$("#importData").modal("hide"),a.importError="",$("#screen-tip").modal({show:!0})},a.importUploaded=function(b,c){c&&b.length>0&&(b=JSON.parse(b),b.id&&d(b.id),b.error&&(a.importError=b.error))}}]),function(){var a=angular.module("dataMod.service",[]);a.filter("fieldFilter",function(){return function(a){var b={};return angular.forEach(a,function(a,c){["ACL","GeoPoint","Relation","File","Object"].indexOf(a.type)<0&&(b[c]=a)}),b}}),a.factory("Schema",["$resource","$q","$routeParams",function(a){return a(purl+"data/"+getParam().appid+"/classes/:id",{id:"@id"},{})}]),a.factory("SchemaLoader",["Schema","$q",function(a,b){var c;return{get:function(){if(c)return c;var d=b.defer();return a.query(function(a){localDatas=a,d.resolve(a)},function(){d.reject("Unable to fetch recipes")}),c=d.promise,d.promise},fetch:function(){var c=b.defer();return a.query(function(a){localDatas=a,c.resolve(a)},function(){c.reject("Unable to fetch recipes")}),c.promise}}}]),a.factory("AppSchema",["$resource","$q","$routeParams",function(a){return a(purl+"data/:id/classes",{id:"@id"},{})}]),a.factory("Column",["$resource","$q","$routeParams",function(a){return a(purl+"data/"+getParam().appid+"/classes/:claid/columns/:id",{id:"@id",claid:"@claid"},{rename:{method:"PUT"},update:{method:"PUT"}})}]),a.factory("Row",["$resource","$q","$routeParams",function(a){return a(purl+"data/"+getParam().appid+"/classes/:claid/rows/:id",{id:"@id",claid:"@claid"},{})}]),a.factory("indices",["$resource","$q","$routeParams",function(a){return a(purl+"data/"+getParam().appid+"/classes/:claid/indices/:id",{id:"@id",claid:"@claid"},{query:{method:"GET",isArray:!1}})}]),a.factory("BigqueryService",["$http","$q","$timeout",function(a,b,c){function d(b,e){a.get(purl+"importer/"+b).success(function(a){a.status&&"done"==a.status?e.resolve():a.status.indexOf("error")>-1?e.reject(a.status.split(":")[1]):(a.status.indexOf("importing")>-1||"ready"==a.status)&&c(function(){d(b,e)},1e3)})}var e={};return e.saveResultAsCla=function(c,e){var f=b.defer();return a.post(purl+"bigquery/job/"+c+"/import/"+e).success(function(a){a.id&&d(a.id,f),a.error&&f.reject(a.error)}),f.promise},e}])}(),function(){var a=angular.module("dataMod.column",["dataMod.service"]);a.controller("ColumnCtrl",["$scope","$rootScope","$http","$routeParams","Column","indices",function(a,b,c,d,e){a.delColumnName=a.currentColumn,a.preColumnName=a.currentColumn,a.prop={},a.addColumn=function(){var b=$("#createColumn input:text");if(!/^[a-zA-Z][\w]*$/.test(b.val()))return!1;var c=new e;c.claid=d.claid;var f=a.newColumnName,g=a.newColumnType;c.column=a.newColumnName,c.type=a.newColumnType,"number"==g.toLowerCase()&&(c.auto_increment=a.columnIncrement),a.newColumnRelCla&&(c.class_name=a.newColumnRelCla),c.required=a.columnRequired,c.comment=a.columnComment,c.default=a.columnDefault,c.hidden=a.columnHidden,c.read_only=a.read_only,"_User"==a.currentCla.name&&(c.user_private=a.user_private),c.$save(function(){a.currentCla.schema[f]={type:g},a.$emit("getClaMeta"),$("#createColumn").modal("hide"),$("#createColumn .text-error").text("")},function(a){$("#createColumn .text-error").text(a.error)}),b.val("")},a.renameColumn=function(){e.rename({claid:d.claid,column:a.preColumnName,new_column:a.newColumnReName},function(){a.$emit("getClaMeta")})},a.deleteColumn=function(){var b=a.delColumnName;if(deleteColumn){var c=new e;c.id=b,c.claid=d.claid,c.$delete(function(){var c;if(window.localStorage){c=localStorage["columns-"+getParam().appid+"-"+a.currentCla.name];try{c=c&&JSON.parse(c)}catch(d){}c&&c.indexOf(b)&&(c.splice(c.indexOf(b),1),localStorage["columns-"+getParam().appid+"-"+a.currentCla.name]=JSON.stringify(c))}delete a.currentCla.schema[b],$("#deleteColumn").modal("hide"),a.$emit("getClaMeta")})}}}]),a.controller("ColumnEditCtrl",["$http","$scope","Column",function(a,b,c){var d=b.currentCla.schema[b.currentColumn];b.editColumnName=b.currentColumn,$.extend(b.prop,d),b.editColumn=function(){var a=new c;a.claid=b.currentCla.name;a.id=b.editColumnName;a.required=b.prop.required,a.comment=b.prop.comment,a.default=""==b.prop.default?null:b.prop.default,a.hidden=b.prop.hidden,a.read_only=b.prop.read_only,"_User"==b.currentCla.name&&(a.user_private=b.prop.user_private),"Number"==b.currentCla.schema[b.editColumnName].type&&(a.auto_increment=b.prop.auto_increment),a.$update().then(function(){b.$emit("getClaMeta")})}}]),a.controller("DataIndexCtrl",["$scope","$rootScope","$http","$routeParams","Column","indices",function(a,b,c,d,e,f){a.newIndex=function(){var b={},c=new f;c.claid=d.claid;for(var e={},g=0;g<a.schemaarr.length;g++)if(a.schemaarr[g].selected){var h=a.schemaarr[g].columnindex;("1"==h||"-1"==h)&&(h=parseInt(h)),b[a.schemaarr[g].columnname]=h}c.columns=b,c.options=e,"unique"==a.indextype?c.options.unique=!0:"sparse"==a.indextype&&(c.options.sparse=!0),c.$save(function(){for(var b=0;b<a.schemaarr.length;b++)a.schemaarr[b].selected=!1;a.loadIndex()})},a.loadIndex=function(){var a=new f;a.claid=d.claid,a.$query(function(a){for(var c=[],d=0;d<a.results.length;d++){var e={};"_id_"!=a.results[d].name&&(e.key=a.results[d].key,e.name=a.results[d].name,delete a.results[d].ns,delete a.results[d].key,delete a.results[d].name,e.option={},angular.forEach(a.results[d],function(a,b){e.option[b]=a}),c.push(e))}b.indexes=c})},a.deleteIndex=function(a,c){var e=new f;e.claid=d.claid,e.id=c,e.$delete(function(){b.indexes.splice(a,1)})},a.loadIndex()}]),a.controller("ClaPermissionCtrl",["$scope","$http","$routeParams",function(a){a.getPermissionDisplay=function(a){var b,c=0,d=0;return a["*"]===!0?b="Public":a.onlySignInUsers===!0?"SessionUsers":(c="string"==typeof a.roles&&""!=a.roles.trim()?a.roles.split(",").length:a.roles?a.roles.length:0,d="string"==typeof a.users&&""!=a.users.trim()?a.users.split(",").length:a.users?a.users.length:0,b=c+" Roles, "+d+" Users")},a.getPermissionClass=function(a){var b;return b=a["*"]?"field-public":a.onlySignInUsers?"field-restricted":"field-private"},a.setPermission=function(b,c){a.permission={prop:b},a.permission.value=c,c.roles?"string"==typeof c.roles&&(a.permission.value.roles=c.roles.split(",")):a.permission.value.roles=[],c.users?"string"==typeof c.users&&(a.permission.value.users=c.users.split(",")):a.permission.value.users=[]}}]),a.controller("ClaPermissionUpdateCtrl",["$scope","$http","$routeParams",function(a,b,c){a.$watch("permission.prop",function(){a.permission&&(a.permissionType=a.permission.value["*"]?"*":a.permission.value.onlySignInUsers?"onlySignInUsers":"specified")}),a.addUser=function(){delete a.permission.value["*"];var b;angular.forEach(a.aclTipUser,function(c){(c.username==a.userId||c.objectId==a.userId)&&(b=c)}),b&&-1===a.permission.value.users.indexOf(b.objectId)&&(a.permission.value.users.push(b.objectId),a.updatePermission({users:a.permission.value.users.join(","),roles:a.permission.value.roles.join(",")}))},a.removeUser=function(b){a.permission.value.users.splice(a.permission.value.users.indexOf(b),1),a.updatePermission({users:a.permission.value.users.join(","),roles:a.permission.value.roles.join(",")})},a.addRole=function(){delete a.permission.value["*"];var b;angular.forEach(a.aclTipRole,function(c){(c.name==a.roleId||c.objectId==a.roleId)&&(b=c)}),b&&-1===a.permission.value.roles.indexOf(b.name)&&(a.permission.value.roles.push(b.name),a.updatePermission({users:a.permission.value.users.join(","),roles:a.permission.value.roles.join(",")}))},a.removeRole=function(b){a.permission.value.roles.splice(a.permission.value.roles.indexOf(b),1),a.updatePermission({users:a.permission.value.users.join(","),roles:a.permission.value.roles.join(",")})},a.updatePermission=function(d){var e={permissions:{}};e.permissions[a.permission.prop]=d,b.put(purl+"data/"+getParam().appid+"/classes/"+c.claid+"/permissions",e).success(function(){$("#permissionedit").modal("hide"),a.$emit("getClaMeta"),a.userId="",a.roleId=""}).error(function(a){showmsg(a.error,AVC.Error)})},a.$watch("permissionType",function(){if(a.permission){var b={};"*"==a.permissionType||"onlySignInUsers"==a.permissionType?(b[a.permissionType]=!0,b.users=[],b.roles=[]):b={users:a.permission.value.users&&a.permission.value.users.join(","),roles:a.permission.value.roles&&a.permission.value.roles.join(",")},a.updatePermission(b)}})}]),a.controller("ClaShareCtrl",["$scope","$http","AppSchema","$routeParams",function(a,b,c,d){function e(b){c.query({id:b},function(b){a.claSchema=b})}function f(){b.get(purl+"data/"+getParam().appid+"/classes/"+d.claid+"/bind").then(function(b){a.currentSharedCla=b.data,a.apps.all.forEach(function(b){b.app_id==a.currentSharedCla.app_id&&(a.currentSharedCla.app_name=b.app_name,a.targetShareApp=b)}),a.targetShareCla=a.currentSharedCla["class"]})}a.targetSharePermission={read:!1,write:!1,"delete":!1},a.$watch("targetShareApp",function(){a.targetShareApp&&e(a.targetShareApp.app_id)}),a.$watch("targetShareCla",function(){return a.currentSharedCla&&a.targetShareApp.app_id==a.currentSharedCla.app_id&&a.currentSharedCla["class"]==a.targetShareCla?(a.targetSharePermission.read=a.currentSharedCla.read,a.targetSharePermission.write=a.currentSharedCla.write,void(a.targetSharePermission.delete=a.currentSharedCla.delete)):void(a.targetSharePermission={read:!1,write:!1,"delete":!1})}),f(),a.hasShared=function(){return a.currentSharedCla&&a.currentSharedCla.app_name?!0:!1},a.shareCla=function(){b.post(purl+"data/"+getParam().appid+"/classes/"+d.claid+"/bind",{app_id:a.targetShareApp.app_id,"class":a.targetShareCla,read:a.targetSharePermission.read,write:a.targetSharePermission.write,"delete":a.targetSharePermission.delete}).then(function(){delete localStorage["columns-"+getParam().appid+"-"+a.currentCla.name],delete localStorage["columns-view-"+getParam().appid+"-"+a.currentCla.name],showmsg("Class 绑定操作成功"),setTimeout(function(){window.location.reload()},500)})},a.deleteShareCla=function(){b.delete(purl+"data/"+getParam().appid+"/classes/"+d.claid+"/bind").then(function(){delete localStorage["columns-"+getParam().appid+"-"+a.currentCla.name],delete localStorage["columns-view-"+getParam().appid+"-"+a.currentCla.name],showmsg("解除绑定操作成功"),setTimeout(function(){window.location.reload()},500)})},a.appNotCurrent=function(){return function(b){return b.app_name!==a.currentApp.app_name}}}]),a.controller("AppSearchCtrl",["$scope","$http","App","SchemaLoader",function(a,b,c){a.appSearch={uri_host:"avoscloud"},a.searchColumnMap={},a.appSearchConfig={fields:[]},c.then(function(b){a.appSearch.app_name=b.app_name});var d=(purl+"data/apps/"+getParam().appid+"/deeplink",purl+"data/apps/"+getParam().appid);a.loadClaOptions=function(){b.get(d+"/"+a.currentCla.name+"/search").success(function(b){$.extend(a.appSearchConfig,b),angular.forEach(a.appSearchConfig.fields,function(b){a.searchColumnMap[b]=!0
})})},a.saveSearchClaConfig=function(){a.appSearchConfig.fields=[],angular.forEach(a.searchColumnMap,function(b,c){b&&a.appSearchConfig.fields.push(c)}),b.post(d+"/"+a.currentCla.name+"/search",a.appSearchConfig).success(function(){})},a.forceRebuildIndex=function(){b.post(d+"/"+a.currentCla.name+"/searchIndexBuild").success(function(){showmsg("重建完成后将会收到邮件通知")})},a.loadClaOptions()}]),a.filter("searchColumnFilter",function(){return function(a){var b={};return angular.forEach(a,function(a,c){return["objectId","ACL","createdAt","updatedAt"].indexOf(c)<0?b[c]=a:void 0}),b}})}();var STAT_TIPS={items:{new_user:"第一次使用应用的用户，以设备为判断标准，一个设备对应一个用户",active_user:"在一定时间段内使用过应用的用户，启动应用一次即视为活跃用户，包括新增用户和老用户。",accumulate_user:"应用从开始收集统计数据到现在的全部用户总数（去重）",session:"启动应用的总次数（应用切换至后台一段时间，再切换至前台算一次新的启动）",dau:"一日活跃用户去重后的总数",wau:"一周活跃用户去重后的总数",mau:"一个月活跃用户去重后的总数",avg_user_time:"平均每个用户一天使用应用的总时长（多次启动累计）",avg_session_time:"平均用户每次使用的时长",page_visit_rank:"用户访问次数从高到低的页面排名",page_duration_rank:"用户停留总时间从长到短的的页面排名",avg_page_count:"平均每个用户访问的页面总数（反复访问例如：A -> B -> A 算 3 个页面）",avg_page_duration:"平均每个用户在所有页面停留的总时长",event_pv:"事件发生的总数",event_uv:"有多少用户触发了此事件（相同用户多次触发算一个用户数）",event_du:"事件的累积时长",push_login:"当日安卓推送客户端活跃数",push_ack:"当日安卓推送到达用户数",push_session:"当日聊天登录数",push_direct:"当日聊天消息数",lost_user_7:"从上次活跃到本日已经有 7 天未使用应用的用户数量",lost_user_rate_7:"流失用户数比活跃用户数，当日的流失用户数占 7 天前的活跃用户总数的比例",lost_user_14:"从上次活跃到本日已经有 14 天未使用应用的用户数量",lost_user_rate_14:"流失用户数比活跃用户数，当日的流失用户数占 14 天前的活跃用户总数的比例"},page:{usefrequence:"按每天使用次数划分，各使用频率的用户数占比",userstay:"用户 n 日存留率，表示某日产生的新用户中，在 n 天后当天还有使用应用的用户数的百分比。例如，10 月 1 日新产生用户 100 人，10 月 2 日还有 30 人使用，则次日存留率 30%。7 天后，10 月 8 号这 100 人中有 10 人启动过应用，则 7 日存留率 10%","customevent-eventid":"事件触发/启动次数，表示平均一次启动发生多少次事件，用户参与度表示，活跃用户中有多少比例的用户触发了此事件。",usepath:"一个节点上的次数和百分比，表示从起点通过蓝色路径访问到当前页面的次数总数和它占全部路径的百分比",channelpromotion:"在 <a href='#/statconfig/channels'>推广营销设置</a> 中 ，设置应用下载链接并创建推广渠道链接。可以跟踪各个推广链接的点击数和由相应推广链接所产生的实际安装激活数",appuse:"需要在 SDK 中进行相应的调用才可以触发此部分统计。 参考    <a href='/docs/push_guide.html'>相关文档 </a> ",statrealtime:"活跃用户指最近五分钟内活跃的用户"},usetip:{chatpush:"<p>通过我们的实时通信服务您可以开发实时的用户间聊天、游戏对战等互动功能</p> <p><a class='btn btn-default' href='/docs/realtime.html'>查看「实时通信」相关文档</a></p>",usepath:"<p>统计数据请开启页面路径统计功能</p> <p><a class='btn btn-default' href='/docs/android_statistics.html#%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2%E8%B7%AF%E5%BE%84'>查看「统计页面路径」相关文档</a></p>",pagevisit:"<p>统计数据请开启页面路径统计功能</p> <p><a class='btn btn-default' href='/docs/android_statistics.html#%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2%E8%B7%AF%E5%BE%84'>查看「统计页面路径」相关文档</a></p>",appuse:"<p>跟踪推送打开和应用打开的相关数据</p> <p><a class='btn btn-default' href='/docs/push_guide.html#%E8%B7%9F%E8%B8%AA-android-%E6%8E%A8%E9%80%81%E5%92%8C-app-%E7%9A%84%E6%89%93%E5%BC%80%E6%83%85%E5%86%B5'>查看「App 使用」相关文档</a></p>"}},statConfig={summary:{chart:[{name:"new_user",displayName:"新增用户"},{name:"active_user",displayName:"活跃用户"},{name:"accumulate_user",displayName:"累计用户"}],table:[{name:"type",displayName:"类型"},{name:"new_user",displayName:"新增用户"},{name:"active_user",displayName:"活跃用户"},{name:"accumulate_user",displayName:"累计用户"}],tableDisplayFunc:function(a,b){if(b||(b="0"),"total"==b)return"总计";if("type"==a){var c=b.toLowerCase();return"<a href='stat.html?appid="+getParam().appid+"&os="+c+"#/stat/keydata'>"+b+"</a>"}return b}},keydata:{chart:[{name:"new_user",displayName:"新增用户",tableEvent:"keydata"},{name:"active_user",displayName:"活跃用户"},{name:"session",displayName:"启动次数"},{name:"accumulate_user",displayName:"累计用户"}],table:[{name:"date",displayName:"日期"},{name:"new_user",displayName:"新增用户"},{name:"active_user",displayName:"活跃用户"},{name:"session",displayName:"启动次数"},{name:"accumulate_user",displayName:"累计用户"}]},versiondata:{chart:[{name:"new_user",displayName:"新增用户",tableEvent:"versiondata"},{name:"active_user",displayName:"活跃用户"},{name:"session",displayName:"启动次数"},{name:"accumulate_user",displayName:"累计用户"},{name:"upgrade_user",displayName:"升级用户"}],table:[{name:"version",displayName:"版本名称"},{name:"accumulate_user",displayName:"累计用户"},{name:"new_user",displayName:"新增用户"},{name:"new_user_rate",displayName:"占比"},{name:"active_user",displayName:"活跃用户"},{name:"active_user_rate",displayName:"占比"},{name:"session",displayName:"启动次数"},{name:"upgrade_user",displayName:"升级用户"}]},channeldata:{chart:[{name:"new_user",displayName:"新增用户",tableEvent:"channeldata"},{name:"active_user",displayName:"活跃用户"},{name:"session",displayName:"启动次数"},{name:"accumulate_user",displayName:"累计用户"}],table:[{name:"version",displayName:"渠道名称"},{name:"accumulate_user",displayName:"累计用户"},{name:"new_user",displayName:"新增用户"},{name:"new_user_rate",displayName:"占比"},{name:"active_user",displayName:"活跃用户"},{name:"active_user_rate",displayName:"占比"},{name:"session",displayName:"启动次数"}]},audata:{chart:[{name:"dau",displayName:"日活跃",tableEvent:"audata"},{name:"wau",displayName:"周活跃"},{name:"dau-wau",displayName:"日活跃/周活跃"},{name:"mau",displayName:"月活跃"},{name:"dau-mau",displayName:"日活跃/月活跃"}],table:[{name:"date",displayName:"日期"},{name:"dau",displayName:"日活跃"},{name:"wau",displayName:"周活跃"},{name:"dau-wau",displayName:"日活跃/周活跃"},{name:"mau",displayName:"月活跃"},{name:"dau-mau",displayName:"日活跃/月活跃"}]},appuse:{chart:[{name:"!AV!AppOpen",displayName:"App 打开"},{name:"!AV!PushOpen",displayName:"Push 打开"}],table:[]},chatpush:{chart:[{name:"push_login",displayName:"Push 用户数"},{name:"push_ack",displayName:"Push 到达数"}],table:[]},usepath:{chart:[],table:[]},usetime:{chart:[{name:"avg_user_time",displayName:"人均使用时长",displayTitle:"人均使用时长(时:分:秒)",tableEvent:"user_time_histo"},{name:"avg_session_time",displayName:"次均使用时长",displayTitle:"次均使用时长(时:分:秒)",tableEvent:"session_time_histo"}],table_user_time_histo:[{name:"name",displayName:"使用时长"},{name:"active_user",displayName:"活跃用户数"},{name:"active_user_rate",displayName:"活跃用户数占比"},{name:"new_user",displayName:"安装用户数"},{name:"new_user_rate",displayName:"安装用户数占比"}],table_session_time_histo:[{name:"name",displayName:"使用时长"},{name:"session",displayName:"启动次数"},{name:"session_rate",displayName:"占比"}]},usefrequence:{chart:[],table:[{name:"name",displayName:"使用频率"},{name:"active_user",displayName:"活跃用户数"},{name:"active_user_rate",displayName:"占比"},{name:"new_user",displayName:"安装数"},{name:"new_user_rate",displayName:"占比"}]},pagevisit:{chart:[{name:"page_visit_rank",displayName:"页面访问排名",tableEvent:"avg_visit"},{name:"avg_page_count",displayName:"人均页面访问数"},{name:"page_duration_rank",displayName:"页面停留时长",displayTitle:"页面停留时长(时:分:秒)"},{name:"page_avg_duration",displayName:"页面平均访问时长",displayTitle:"页面平均访问时长(时:分:秒)"},{name:"page_exit_rate",displayName:"页面跳出率"}],table:[{name:"date",displayName:"日期"},{name:"count",displayName:"人均页面访问数"},{name:"duration",displayName:"人均访问时长(时:分:秒)"}]},userstay:{chart:[{name:"lost_user_7",displayName:"7 天流失"},{name:"lost_user_rate_7",displayName:"7 天流失率"},{name:"lost_user_14",displayName:"14 天流失"},{name:"lost_user_rate_14",displayName:"14 天流失率"}],table:[{name:"date",displayName:"首次启动日"},{name:"new_user",displayName:"新增用户"},{name:"s1",displayName:"次日"},{name:"s2",displayName:"2天后"},{name:"s3",displayName:"3天后"},{name:"s4",displayName:"4天后"},{name:"s5",displayName:"5天后"},{name:"s6",displayName:"6天后"},{name:"s7",displayName:"7天后"},{name:"s14",displayName:"14天后"},{name:"s30",displayName:"30天后"}]},userclient:{chart:[{name:"os_version",displayName:"操作系统版本"},{name:"device_model",displayName:"设备型号"},{name:"access",displayName:"网络环境"},{name:"carrier",displayName:"运营商"},{name:"resolution",displayName:"分辨率"}]},userlocation:{chart:[{name:"location",displayName:"用户地理位置分布"},{name:"location_new_user",displayName:"新增用户地理位置分布"}]},customevent:{chart:[],table:[{name:"event",displayName:"事件ID"},{name:"total-pv",displayName:"事件总数"},{name:"today-pv",displayName:"今日"}],tableDisplayFunc:function(a,b){return b||(b="0"),"event"==a?"<a href='#/stat/custom/"+b+"'>"+b+"</a>":b}},custom:{chart:[{name:"event_pv",displayName:"事件触发数"},{name:"event_uv",displayName:"独立用户数"},{name:"event_du",displayName:"事件时长",displayTitle:"事件时长(时:分:秒)"},{name:"event_new_user",displayName:"当日新用户"},{name:"event_accumulate_user",displayName:"累计用户数"}],table:[{name:"date",displayName:"日期"},{name:"pv",displayName:"事件触发数"},{name:"event_session",displayName:"事件触发数/启动次数"},{name:"uv",displayName:"独立用户数"},{name:"uv_au",displayName:"用户参与度"},{name:"du",displayName:"事件时长(时:分:秒)"}]},channelpromotion:{chart:[{name:"channel_pv",displayName:"总点击",tableEvent:"channel_total"},{name:"channel_m_pv",displayName:"移动端点击"},{name:"channel_install",displayName:"激活"},{name:"channel_active_rate",displayName:"激活率"}],table:[{name:"name",displayName:"渠道名称"},{name:"pv",displayName:"总点击"},{name:"m_pv",displayName:"移动端点击"},{name:"install",displayName:"激活"},{name:"active_rate",displayName:"激活率"}]},crashreport:{chart:[{name:"crash",displayName:"错误数",tableEvent:"crash"},{name:"crash_session",displayName:"错误数/启动数"}],table:[{name:"reason",displayName:"错误摘要"},{name:"version",displayName:"版本"},{name:"count",displayName:"错误数"},{name:"time",displayName:"时间"}],tableDisplayFunc:function(a,b){return"reason"==a?'<a ng-click="setCurrentCrashDetail($parent.data)" >'+htmlEntities(b)+"</a>":b}},eventfunnel:{chart:[{name:"funnel",displayName:"分步转化",tableEvent:"funnel"},{name:"funnel_rate_trend",displayName:"转化趋势(按比例)",tableEvent:"funnel_rate"}],table_funnel:[{name:"name",displayName:"事件"},{name:"count",displayName:"用户数"},{name:"prev_rate",displayName:"上一步转化率"},{name:"total_rate",displayName:"总体转化率"}]},funnel_config:{table:[{name:"name",displayName:"名称"},{name:"steps",displayName:"事件步骤"}],tableDisplayFunc:function(a,b,c){return"name"==a?'<a href="#stat/eventfunnel/'+c.id+'">'+b+"</a>":b}}},statConfigModule=angular.module("statconfig",[]);statConfigModule.directive("statTdCell",["$compile",function(a){return{link:function(b,c){var d=b.label,e=b.data;c.html(b.tableDisplayFunc(d.name,e[d.name],e,b.$parent.data)),a(c.contents())(b)}}}]),statConfigModule.directive("statTraceDetail",["$compile",function(a){return{link:function(b,c){b.errorTraceToggle=!1;var d='<pre style="display:none"><code> dwarfdump --arch=armv7 `mdfind "com_apple_xcode_dsym_uuids == {uuid}"` --lookup {memory} | grep "Line\\ table"</code></pre>';b.errorTraceVisible=[],b.setCurrentTrace=function(a){angular.element(a.target).parent("div").find("pre").toggle()},b.$watch("statCurrentError",function(){var e=b.statCurrentError;if(e&&e.trace){for(var f=e.bid,g=e.display_name,h=/\b0x\w*\b/,i=e.trace,j=[],k=0;k<i.length;k++){var l=i[k];if(l=htmlEntities(l),f&&""!=f.trim())if(l.indexOf(g)>-1){var m=l.match(h),n=l.split(h);j.push("<div>"),j.push(n[0]+"<a ng-click='setCurrentTrace($event)'>"+m+"</a>"+n[1]),j.push(d.replace("{uuid}",f).replace("{memory}",m)),j.push("</div>")}else j.push("<div >"),j.push(l),j.push("</div>");else j.push("<div>"),j.push(l),j.push("</div>")}c.html(j.join("")),a(c.contents())(b)}})}}}]),statConfigModule.directive("myInputEdit",["$compile",function(a){return{restrict:"A",link:function(b,c,d){c.on("dblclick",function(){var e,f,g=d.prop;"id"==g?(e=b.key,f='<input type="text"    value="'+e+'" >'):(e=b.value[g],f='<input type="text" ng-model="value'+g+'" value="'+e+'" >'),compiled=a(f)(b),c.html(compiled),c.find("input").on("blur",function(){c.text($(this).val()),b.updateStatCustomParam(b.key,g,$(this).val())})})}}}]),angular.module("statMod",["appMod","statconfig","ngTable","statMod.other","statConfigMod"]);var remoteURL="/1/stats/";angular.module("statMod").config(["$routeProvider",function(a){a.when("/stat/:statpageid",{templateUrl:"views/app-stat.html",controller:"StatQueryCtrl"}).when("/statrealtime",{templateUrl:"views/stat-realtime.html",controller:"StatRealtimeCtrl"}).when("/stat/:statpageid/:eventid",{templateUrl:"views/app-stat.html",controller:"StatQueryCtrl"}).when("/selfconfig/funnel_config",{templateUrl:"views/app-stat-event-funnel.html",controller:"EventFunnelCtrl"}).when("/selfconfig/usergroup",{templateUrl:"views/stat-user-group-list.html",controller:"UserGroupCtrl"}).when("/selfconfig/usergroup/:groupid",{templateUrl:"views/stat-user-config.html",controller:"UserGroupCreateCtrl"}).when("/statconfig/trans_strategoy",{templateUrl:"views/app-stat-tranconfig.html",controller:"analyticsDataSetting"}).otherwise({redirectTo:"/statrealtime"})}]),angular.module("statMod").value("$strapConfig",{datepicker:{language:"zh-CN"}}),angular.module("statMod").controller("StatCtrl",["$scope","$http","$location","filterFilter","apps","$routeParams","$rootScope","$location",function(a,b,c,d,e,f,g,c){a.$on("$routeChangeSuccess",function(){a.isStatConfig=/^\/statconfig\//.test(c.path()),a.noCondition=/\/chatpush/.test(c.path())}),a.apps=e,a.pagestat=statConfig,a.appid=getParam().appid,a.startTime=moment().subtract("days",6).toDate(),a.endTime=moment().toDate(),a.rangeDateSelector=!0,g.statPlat="all",g.statSelected=$.cookie("stat-last-selected"),a.hasStatPlatAll=!0,a.loadPlats=function(){var c={column:"platform",appid:a.appid};b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.availablePlats=b})},a.platMap={ios:"iOS",android:"Android",osx:"OSX",unity:"Unity",windows:"Windows"},a.loadPlats(),a.statpageid=f.statpageid,a.hasStatPlatAll=["usepath","crashreport","versiondata","channeldata"].indexOf(a.statpageid)>-1?!1:!0,g.statPlat=g.statSelected?a.hasStatPlatAll||"all"!=g.statSelected?g.statSelected:"ios":a.hasStatPlatAll?"all":"ios",a.getChartOption=function(){return{chart:{type:"areaspline"},title:{x:0},yAxis:{allowDecimals:!1,min:0,gridLineColor:"#f4f1f1",title:{text:""},labels:{overflow:"justify"}},xAxis:{labels:{overflow:"justify"},tickPixelInterval:200},tooltip:{},plotOptions:{areaspline:{fillOpacity:.4}},credits:{enabled:!1},series:[{data:[]}]}},a.setPageTip=function(b){var b=b||f.statpageid,c=a.pagestat[b]&&a.pagestat[b].chart,d=[];if(c)for(var e=0;e<c.length;e++)STAT_TIPS.items[c[e].name]&&d.push({desc:STAT_TIPS.items[c[e].name],name:c[e].displayName});a.tipitems=d,a.tippage=STAT_TIPS.page[b],a.hastip=a.tipitems.length||a.tippage,a.tipuse=STAT_TIPS.usetip[b]}}]),angular.module("statMod").controller("StatRealtimeCtrl",["$http","$scope","$timeout","$rootScope","$location",function(a,b,c,d,e){function f(a,b){return"undefined"==typeof b?"data-new":b>a?"data-smaller":a>b?"data-bigger":void 0}function g(){b.loadData(),j=c(function(){g()},15e3)}e.path();b.setPageTip("statrealtime"),b.realTime={},b.statAnimation={page_visit:[],events:[],location:[]};var h=(new Odometer({el:$(".transition-number")[0],value:0,format:""}),b.getChartOption());h.xAxis.categories=[],h.xAxis.tickInterval=5;for(var i=30;i>0;i--)h.xAxis.categories.push("-"+i+" 分钟");h.plotOptions.series={animation:!1};var j;b.loadData=function(){a.get(remoteURL+"realtime",{params:{appid:getParam().appid,os:b.statPlat}}).success(function(a){if(e.path()&&"/statrealtime"!=e.path())return void(j&&c.cancel(j));b.statAnimation={page_visit:[],events:[],location:[]},b.statAnimation.current_active=f(a.current_active,b.realTime.current_active),$(".transition-number").text(a.current_active);var d=!0;angular.forEach(a.page_visit,function(a,c){if(d=!0,b.realTime.page_visit)for(var e=0;e<b.realTime.page_visit.length;e++)if(a.name==b.realTime.page_visit[e].name){b.statAnimation.page_visit[c]=f(a.count,b.realTime.page_visit[e].count),d=!1;break}d&&(b.statAnimation.page_visit[c]=f(a.count))}),angular.forEach(a.events,function(a,c){if(d=!0,b.realTime.events)for(var e=0;e<b.realTime.events.length;e++)if(a.name==b.realTime.events[e].name){b.statAnimation.events[c]=f(a.count,b.realTime.events[e].count),d=!1;break}d&&(b.statAnimation.events[c]=f(a.count))}),angular.forEach(a.location,function(a,c){if(d=!0,b.realTime.location)for(var e=0;e<b.realTime.location.length;e++)if(a.location==b.realTime.location[e].location){b.statAnimation.location[c]=f(a.count,b.realTime.location[e].count),d=!1;break}d&&(b.statAnimation.location[c]=f(a.count))}),b.realTime=a,h.yAxis.min=Math.min.apply(null,a.active_30min),h.yAxis.startOnTick=!1,h.yAxis.showFirstLabel=!0,h.series[0].name="活跃用户",h.series[0].data=a.active_30min.reverse(),h.series[0].showInLegend=!1,$("#chart-container").highcharts(h)})},b.platSelect=function(a){d.statSelected=a,$.cookie("stat-last-selected",a),d.statPlat=a,j&&c.cancel(j),g()},g()}]),angular.module("statMod").controller("StatQueryCtrl",["$scope","$http","$routeParams","$timeout","$rootScope","$location","$timeout","$compile","ngTableParams",function(a,b,c,d,e,f,d,g,h){function i(){a.startTime=moment().subtract("days",7),a.endTime=moment().subtract("days",1),a.maxTime=a.endTime,a.maxContrastTime=moment(a.maxTime).format("YYYY-MM-DD")}function j(){a.tableEvent="event_summary",a.isCustomEvent=!0,a.selectedErrors={checked:!1,items:{}},a.$watch("selectedErrors.checked",function(b){angular.forEach(a.statErrors,function(c){angular.isDefined(c.event)&&(a.selectedErrors.items[c.event]=b)})}),a.$watch("selectedErrors.items",function(){if(a.statErrors){var b=0,c=0,d=a.statErrors.length;angular.forEach(a.statErrors,function(d){b+=a.selectedErrors.items[d.event]||0,c+=!a.selectedErrors.items[d.event]||0}),(0==c||0==b)&&(a.selectedErrors.checked=b==d)}},!0),a.updateCustomState=function(){var c=window.confirm("禁用选中事件后，将不再对禁用的事件进行统计");if(c){var d=[];angular.forEach(a.selectedErrors.items,function(a,b){a&&d.push(b)}),b.post(remoteURL+"apps/"+getParam().appid+"/event",{os:a.statPlat,events:d.join(",")}).success(function(){a.tableParams.reload(),a.selectedErrors.items={}})}}}function k(){function b(){q(function(b){a.tableEventDatas=b.stats},"event_attributes_pv")}a.customEventId=c.eventid,a.tableEvent="event",a.currentEventParam=a.customEventId,a.tableDisplayFunc=function(a,b){return b||(b="0"),"du"==a?b=secondFormat(b):"date"==a&&(b=moment(b,"YYYYMMDD").format("YYYY-MM-DD")),b},a.$watch("startTime && endTime",b),a.loadEventParams(),a.$watch("startTime && endTime",a.loadEventParams),a.$watch("statchannels",a.loadEventParams),a.$watch("statversions",a.loadEventParams),a.$watch("statchannels",b),a.$watch("statversions",b),a.tableEventLabels=[{name:"name",displayName:"参数值"},{name:"value",displayName:"事件触发数"},{name:"rate",displayName:"占比"}],a.setCurrentEventParam=function(b){a.currentEventParam=b},a.$watch("currentEventParam",b)}function l(){function b(){a.$watch("eventname",function(){angular.forEach(a.pagestat[c.statpageid].chart,function(b){b.name==a.eventname&&(a.tableEvent=b.tableEvent,a.tableLabels=a.pagestat[c.statpageid]["table_"+a.tableEvent])}),a.queryTable()})}a.contrastDate=moment(a.endTime).subtract("months",1).format("YYYY-MM-DD"),a.$watch("contrastDate",function(){return a.contrastClicked?a.contrastDate?void(moment(a.contrastDate).format("YYYY-MM-DD")!=moment(a.endTime).subtract("days",6).format("YYYY-MM-DD")&&s()):void(a.contrastDate=moment(a.endTime).subtract("days",6).toDate()):void 0});var d=c.statpageid;a.rangeDateSelector=!0,a.loadByDate=m,a.charType="areaspline",a.versionSelector=["versionSelector","channelpromotion"].indexOf(d)>-1?!1:!0,a.channelSelector=["channelpromotion","channeldata"].indexOf(d)>-1?!1:!0;var f,g,h=function(b){a.tableDatas=b.stats};if(a.pagestat[c.statpageid]){if(a.setPageTip(),a.tableDisplayFunc=a.pagestat[c.statpageid].tableDisplayFunc||function(a,b){return b||(b="0"),b},a.pagestat[c.statpageid].chart&&a.pagestat[c.statpageid].chart[0]&&(a.eventname=a.pagestat[c.statpageid].chart[0].name,a.tableEvent=a.pagestat[c.statpageid].chart[0].tableEvent),a.pagestat[c.statpageid]&&(a.chartLabels=a.pagestat[c.statpageid].chart,a.tableLabels=a.pagestat[c.statpageid].table),a.maxTime=moment(),a.maxContrastTime=moment(a.maxTime).format("YYYY-MM-DD"),["versiondata","channeldata","usetime"].indexOf(d)>-1&&a.$watch("endTime",function(){a.tableTitle=a.hasSelectDate?"- "+moment(a.endTime).format("YYYY-MM-DD"):"- "+moment(a.endTime).subtract("days",1).format("YYYY-MM-DD"),a.tableStartDate=a.tableEndDate=moment(a.endTime).format("YYYYMMDD")}),a.isChannelPage="channeldata"==d,a.isVersionPage="versiondata"==d,["usepath","usetime","usefrequence","pagevisit","userstay","userclient","userlocation","audata"].indexOf(d)>-1&&i(),["usepath","usefrequence","customevent"].indexOf(d)>-1&&(a.chartHide=!0),"usetime"==d&&(a.tableStartDate=a.tableEndDate=moment().subtract("days",1).format("YYYYMMDD"),b()),"usepath"==d&&a.loadVisitPath(),"usefrequence"==c.statpageid)a.tableTime=moment().subtract("days",1).format("YYYY-MM-DD"),a.maxTableTime=moment(a.tableTime).format("YYYY-MM-DD"),a.$watch("tableTime",function(){a.loadChannels(),a.loadVersions(),a.tableStartDate=a.tableEndDate=moment(a.tableTime).format("YYYYMMDD"),a.queryTable()}),a.eventname="active_user_freq",a.tableEvent="active_user_freq",a.tableDateSelector=!0,a.rangeDateSelector=!1;else if("pagevisit"==c.statpageid)h=function(b){angular.forEach(b.stats,function(a){a.duration=secondFormat(a.duration)}),a.tableDatas=b.stats};else if("userstay"==c.statpageid)a.tableTitle="（用户留存）",a.tableEvent="user_survive";else if("customevent"==c.statpageid)j();else if("eventfunnel"==c.statpageid)a.funnelId=c.eventid,angular.forEach(e.funnels,function(b){b.id==a.funnelId&&(a.currentFunnel=b)}),h=function(b){"funnel_rate"==a.tableEvent&&b.stats&&b.stats[0]?(a.tableDatas=b.stats,a.tableLabels=[{name:"date",displayName:"日期"}],angular.forEach(b.stats[0],function(b,c){"date"!=c&&"rate"!=c&&a.tableLabels.push({name:c,displayName:c})}),a.tableLabels.push({name:"rate",displayName:"转化率"})):a.tableDatas=b.stats},b(h);else if("custom"==c.statpageid)k();else if("audata"==c.statpageid){var l=moment().subtract("days",1).format("YYYYMMDD");f=g=l,h=function(b){a.yesterdayActiveData=b.stats[0]}}else"channelpromotion"==c.statpageid?a.noPlat=!0:"crashreport"==c.statpageid&&(a.tableHasCheckbox=!0,a.errorConditionSelector=!0,a.statErrorCondition=!1,a.crashDetailConditions=[{name:"trace",displayName:"Stack Trace"},{name:"device",displayName:"设备类型分布"},{name:"os",displayName:"操作系统分布"}]);a.isVersionPage||a.isChannelPage||(t(),a.queryTable(h))}}function m(b,d){a.$apply(function(){a.hasSelectDate=!0,a.startTime=b,a.endTime=d,"usepath"==c.statpageid&&a.loadVisitPath(),"usetime"==c.statpageid&&(a.tableStartDate=a.tableEndDate=moment(a.endTime).format("YYYYMMDD")),a.isVersionPage||a.isChannelPage||(t(),a.queryTable()),a.loadChannels(),a.loadVersions()})}function n(){a.queryStat(),a.queryTable(),"usepath"==c.statpageid&&a.loadVisitPath()}function o(b){a.tableParams?a.tableParams.reload():(a.tableParams=new h({page:1,count:10},{total:1,getData:function(c,d){var e,f=(d.page()-1)*d.count(),g=d.count();d.orderBy().length&&(e=d.orderBy()[0]);q(function(e){var f=e.stats;b(e),d.total(e.total),a.statErrors=f,c.resolve(f)},null,f,g,e)}}),"crashreport"==c.statpageid&&(a.selectedErrors={checked:!1,items:{}},a.$watch("selectedErrors.checked",function(b){angular.forEach(a.statErrors,function(c){angular.isDefined(c.id)&&(a.selectedErrors.items[c.id]=b)})}),a.$watch("selectedErrors.items",function(){if(a.statErrors){var b=0,c=0,d=a.statErrors.length;angular.forEach(a.statErrors,function(d){b+=a.selectedErrors.items[d.id]||0,c+=!a.selectedErrors.items[d.id]||0}),(0==c||0==b)&&(a.selectedErrors.checked=b==d)}},!0)))}function p(b,d){var e=a.tableStartDate||moment(a.startTime).format("YYYYMMDD"),f=a.tableEndDate||moment(a.endTime).format("YYYYMMDD"),g=(a.eventname,{appid:a.appid,start_date:e,end_date:f,stats:b||a.tableEvent});return d&&$.extend(g,d),a.customEventId&&(g.event=a.customEventId),a.funnelId&&(g.funnelid=a.funnelId),a.currentEventParam&&(g.param=a.currentEventParam),a.statchannels&&(g.channel=a.statchannels),a.statversions&&(g.version=a.statversions),g.os=a.statPlat,c.statpageid&&"crashreport"==c.statpageid&&(g.marked=a.statErrorCondition),a.currentTagName&&a.customTag.selected&&(g.tag=a.currentTagName+"_"+a.customTag.selected),a.currentUserGroupName&&(g.group=a.currentUserGroupName),g}function q(c,d,e,f,g,h){if(d||a.tableEvent){var i=p(d,h);i.skip=e,i.limit=f,i.orderby=g;var j=remoteURL+"load_table_data";b.get(j,{params:i}).success(function(a){c(a)})}}function r(b){for(var d=a.pagestat[c.statpageid].chart,e=0;e<d.length;e++)if(d[e].name==b)return!0;return!1}function s(){var c=remoteURL+"load_stats_data",d=angular.copy(a.contrastParams),e=moment(d.end_date,"YYYYMMDD")-moment(d.start_date,"YYYYMMDD"),f=moment(d.start_date,"YYYYMMDD").format("YYYY-MM-DD"),g=moment(f);e=parseInt(e/864e5);var h=moment(a.contrastDate),i=moment(h).subtract("days",e);a.chartDates.push(i),d.start_date=i.format("YYYYMMDD"),d.end_date=h.format("YYYYMMDD"),b.get(c,{params:d}).success(function(b){var c=b.stats[0];c.name=i.format("YYYY-MM-DD")+"至"+h.format("YYYY-MM-DD");var d=[];angular.forEach(a.chartOption.series,function(a){d.push({name:a.name,data:a.data})}),a.chartOption.series=d,a.chartOption.series.push(c),b.label_type&&"day"==b.label_type&&angular.forEach(a.chartOption.series,function(a){a.pointStart=moment.utc(f,"YYYYMMDD").valueOf(),a.pointInterval=864e5}),a.chartOption.tooltip.formatter=function(){var a=(getDaysBetweenDate(g,moment(this.x)),this.x);b.label_type&&"day"==b.label_type&&(a=moment(this.x).format("YYYY-MM-DD"));var c="<b>"+a+"</b>";return $.each(this.points,function(a,d){var e=d.y;b.data_type&&"time"==b.data_type&&(e=secondFormat(d.y)),c+="<br/>"+d.series.name+": "+e}),c},$("#chart-container").highcharts(a.chartOption)})}function t(){$.inArray(a.eventname,["page_visit_rank","page_duration_rank","page_exit_rate","page_avg_duration","os_version","device_model","carrier","access","resolution","location","location_new_user"])>-1?(a.charType="bar",a.contrastDateHide=!0):"funnel"==a.eventname?a.charType="column":(a.charType="areaspline",a.contrastDateHide=!1),$.inArray(c.statpageid,["versiondata","channeldata","channelpromotion"])>-1&&(a.contrastDateHide=!0),a.chartOption=a.getChartOption(),a.charType&&(a.chartOption.chart.type=a.charType),"areaspline"==a.chartOption.chart.type&&$.extend(a.chartOption.tooltip,{shared:!0,crosshairs:!0});var d=a.chartOption,e=moment(a.startTime),f=moment(a.endTime),g=(moment(a.endTime),a.eventname);if(a.chartDates=[moment(a.startTime)],r(g)){var h="";if(a.pagestat[c.statpageid].chart)for(var i=0;i<a.pagestat[c.statpageid].chart.length;i++)if(a.pagestat[c.statpageid].chart[i].name==g){h=a.pagestat[c.statpageid].chart[i].displayTitle||a.pagestat[c.statpageid].chart[i].displayName;break}d.title.text=h,e=moment(e).format("YYYYMMDD"),f=moment(f).format("YYYYMMDD");var j=remoteURL+"load_stats_data",k={appid:a.appid,start_date:e,end_date:f,stats:g};a.customEventId&&(k.event=a.customEventId),a.statchannels&&(k.channel=a.statchannels),a.statversions&&(k.version=a.statversions),a.statPlat&&(k.os=a.statPlat),a.currentTagName&&a.customTag.selected&&(k.tag=a.currentTagName+"_"+a.customTag.selected),a.currentUserGroupName&&(k.group=a.currentUserGroupName),a.funnelId&&(k.funnelid=a.funnelId),"!AV!AppOpen"==g&&(k.stats="event_pv",k.event="!AV!AppOpen"),"!AV!PushOpen"==g&&(k.stats="event_pv",k.event="!AV!PushOpen"),a.contrastParams=k,b.get(j,{params:k}).success(function(b){b.data_type&&"time"==b.data_type?$.extend(d.yAxis,{labels:{formatter:function(){return secondFormat(this.value)},overflow:"justify"}}):b.data_type&&"percentage"==b.data_type&&$.extend(d.yAxis,{labels:{formatter:function(){return this.value+"%"},overflow:"justify"}}),"crash_session"==g&&(d.yAxis.allowDecimals=!0),b.label_type&&"day"==b.label_type?$.extend(d.xAxis,{type:"datetime",labels:{formatter:function(){return moment(this.value).format("YYYY-MM-DD")},overflow:"justify",maxStaggerLines:1}}):(d.xAxis.categories=b.dates,"hour"==b.label_type&&(d.xAxis.labels.step=Math.round(d.xAxis.categories.length/6))),b.stats&&b.stats[0]&&b.stats.length<2&&(b.stats[0].showInLegend=!1),b.stats&&b.stats.length>1?($.extend(d.tooltip,{shared:!0,crosshairs:!0}),b.label_type&&"day"==b.label_type&&(d.tooltip.xDateFormat="%Y-%m-%d")):$.extend(d.tooltip,{formatter:function(){var a=this.x,c=this.y;b.label_type&&"day"==b.label_type&&(a=moment(this.x).format("YYYY-MM-DD")),b.data_type&&"time"==b.data_type&&(c=secondFormat(this.y)),"percentage"==b.data_type&&(c=this.y+"%");var d=a+": "+c;return d}}),d.series=b.stats,d.series&&d.series[0]&&1==d.series.length&&(d.series[0].name=moment(a.startTime).format("YYYY-MM-DD")+"至"+moment(a.endTime).format("YYYY-MM-DD"),a.needChartTip=d.series[0].data.length<1?!0:!1),d.series&&d.series[0]&&(d.yAxis.labels.step=Math.round(d.series[0].data.length/10),b.label_type&&"day"==b.label_type&&angular.forEach(d.series,function(a){a.pointStart=moment.utc(e,"YYYYMMDD").valueOf(),a.pointInterval=864e5}),d.series[0].data.length>30&&(d.plotOptions.areaspline.marker={enabled:!1})),a.chartElem=$("#chart-container").highcharts(d)})}}a.customTag={},a.statpageid=c.statpageid,a.statpageid=c.statpageid,a.hasStatPlatAll=["usepath","crashreport","versiondata","channeldata"].indexOf(a.statpageid)>-1?!1:!0,e.statPlat=e.statSelected?a.hasStatPlatAll||"all"!=e.statSelected?e.statSelected:"ios":a.hasStatPlatAll?"all":"ios",a.setCurrentTag=function(b){a.currentTagName=b,n()},a.setCurrentUserGroup=function(b){a.currentUserGroupName=b&&-1!=b?b:null,n()},a.platSelect=function(b){e.statSelected=b,$.cookie("stat-last-selected",b),e.statPlat=b,a.isVersionPage||a.isChannelPage||n(),"all"!=a.statPlat&&(a.loadChannels(),a.loadVersions(),a.loadUserGroups())},$(function(){$("#stat-channel-select .btn-group").on("click",".btn",function(){setTimeout(function(){var b=[];$("#stat-channel-select .btn.active").each(function(){$(this).attr("channel")&&b.push($(this).attr("channel"))}),a.$apply(function(){a.statchannels=b.join(","),n()})},0)}),$("#stat-version-select .btn-group").on("click",".btn",function(){setTimeout(function(){var b=[];$("#stat-version-select").find(".btn.active").each(function(){$(this).attr("version")&&b.push($(this).attr("version"))}),a.$apply(function(){a.statversions=b.join(","),n()})},0)})}),a.getCrashsByFilter=function(b){a.statErrorCondition=b,o()},a.loadVisitPathByStep=function(b,c){function d(a){for(var b=0;b<a.length;b++){if(!a[b])return"";if(1==a[b].current)return a[b].name}}if(!(b>=4)&&"_other_"!=c&&"_exit_"!=c){for(var e=0;e<a.visitDatas[b].length;e++)a.visitDatas[b][e]&&(a.visitDatas[b][e].current=a.visitDatas[b][e].name==c?!0:!1);for(var f=[],e=0;b+1>e;e++)f.push(d(a.visitDatas[e]));a.loadVisitPath(void 0,void 0,f.join(","))}},a.getVisitStepTitle=function(b){if(0==b)return"首次进入用户分布: "+a.visitCount;for(var c=0,d=0;d<a.visitDatas[b-1].length;d++)a.visitDatas[b-1][d]&&a.visitDatas[b-1][d].current&&(c=a.visitDatas[b-1][d].count);return"第"+b+"次跳转用户分布: "+c},a.getVisitCursor=function(a){return a?"_exit_"==a.name||"_other_"==a.name?"default":"pointer":"default"},a.getVisitStepName=function(a){return"_other_"==a?"其它":"_exit_"==a?"退出":a},a.loadVisitPath=function(c,d,e){a.needChartTip=!1;var f=c||moment(a.startTime).format("YYYYMMDD"),g=d||moment(a.endTime).format("YYYYMMDD"),h=remoteURL+"load_visit_path",i=(a.eventname,{appid:a.appid,start_date:f,end_date:g});e&&(i.path=e),a.statchannels&&(i.channel=a.statchannels),a.statversions&&(i.version=a.statversions),a.currentUserGroupName&&(i.group=a.currentUserGroupName),i.os=a.statPlat,b.get(h,{params:i}).success(function(b){if(e){var c=e.split(","),d=c.length;a.visitDatas.splice(d),a.visitDatas[d]=b}else{if(!b[0]||!b[0][0])return a.visitCount=0,a.needChartTip=!0,void(a.visitDatas=b);a.visitCount=0;for(var f=0;f<b.length-1;f++)b[f][0]&&(b[f][0].current=!0);a.visitDatas=b;for(var f=0;f<b[0].length;f++)a.visitCount+=b[0][f].count}for(var f=0;f<a.visitDatas.length;f++)for(var g=0;g<a.visitDatas[f].length;g++)a.visitDatas[f][g]&&(a.visitDatas[f][g].percent=(100*a.visitDatas[f][g].count/a.visitCount).toFixed(2)+"%");for(var f=0;f<a.visitDatas.length;f++)for(var h=a.visitDatas[f].length,g=h;12>g;g++)a.visitDatas[f][g]=void 0})},a.loadChannels=function(){var c={column:"channel",appid:a.appid,start_date:moment(a.startTime).format("YYYYMMDD"),end_date:moment(a.endTime).format("YYYYMMDD")};c.os=a.statPlat,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.allchannels=b,a.isChannelPage&&(a.statchannels=a.allchannels.join(","),t(),a.queryTable())})},a.loadVersions=function(){var c={column:"app_version",appid:a.appid,start_date:moment(a.startTime).format("YYYYMMDD"),end_date:moment(a.endTime).format("YYYYMMDD")};
c.os=a.statPlat,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.allversions=b,a.isVersionPage&&(a.statversions=a.allversions.join(","),t(),a.queryTable())})},a.loadCustomTags=function(){var c={column:"app_version",appid:a.appid};c.os=a.statPlat,b.get(remoteURL+"load_custom_tags",{params:c}).success(function(b){a.alltags=$.isEmptyObject(b)?null:b})},a.loadUserGroups=function(){var c={column:"groups",appid:a.appid};c.os=a.statPlat,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.usergroups=$.isEmptyObject(b)?null:b})},a.loadEventParams=function(){var c=moment(a.startTime).format("YYYYMMDD"),d=moment(a.endTime).format("YYYYMMDD"),e={start_date:c,end_date:d,appid:a.appid,event:a.customEventId};e.os=a.statPlat,a.statchannels&&(e.channel=a.statchannels),a.statversions&&(e.version=a.statversions),b.get(remoteURL+"load_event_params",{params:e}).success(function(b){a.customEventParams=b})},a.loadChannels(),a.loadVersions(),a.loadUserGroups(),a.queryTable=function(b){var c=function(b){a.tableDatas=b.stats};b=b||c,o(b)},a.exportTableData=function(){var b=p();b.export="csv";var c=remoteURL+"load_table_data",d=[];angular.forEach(b,function(a,b){d.push(b+"="+a)}),a.exportUrl=c+"?"+d.join("&")},a.changeTableOrder=function(b){a.changeTableOrder[b]=a.changeTableOrder[b]||-1,a.changeTableOrder[b]=-a.changeTableOrder[b],a.tableDatas.sort(function(c,d){if(a.changeTableOrder[b]>0){if(c[b]<d[b])return 1;if(d[b]<c[b])return-1}else{if(c[b]<d[b])return-1;if(d[b]<c[b])return 1}return 0})},a.getConditionStr=function(){var b=[];return a.statchannels&&a.statchannels.split(",").length<2&&b.push(a.statchannels),a.statversions&&a.statversions.split(",").length<2&&b.push("v"+a.statversions),b.join(" - ")},a.queryStat=function(b){a.eventname=b||a.eventname;{var c=moment(a.startTime),d=moment(a.endTime);a.eventname}return c.isValid()&&d.isValid()?void t():void showmsg("日期格式非法，需要遵循 YYYY-MM-DD",AVC.Error)},a.selectContrast=function(){a.contrastClicked=!0},a.updateErrorState=function(){var c=[];angular.forEach(a.selectedErrors.items,function(a,b){a&&c.push(b)}),b.post(remoteURL+"apps/"+getParam().appid+"/crash",{error_keys:c.join(","),os:a.statPlat,fix:!a.statErrorCondition}).success(function(){a.tableParams.reload(),a.selectedErrors.items={}})},a.showCrashReportList=function(){$("#stat-table-pagination").show(),$("#stat-error-detail").hide(),$("#stat-error-detail .nav-tabs li").removeClass("active"),$("#stat-error-detail .nav-tabs li:first").addClass("active"),$("#stat-crash-chart").hide(),$(".trace-detail").show()},a.setCurrentCrashDetail=function(b){a.statCurrentError=b,$("#stat-table-pagination").hide(),$("#stat-error-detail").show()},a.getTableSortClass=function(b){if("reason"==b||"version"==b)return"sort-disable";if(a.tableParams){if(a.tableParams.isSortBy(b,"asc"))return"sort-asc";if(a.tableParams.isSortBy(b,"desc"))return"sort-desc"}return"sortable"},a.sortTable=function(b){"reason"!=b&&"version"!=b&&a.tableParams.sorting(b,a.tableParams.isSortBy(b,"asc")?"desc":"asc")},a.queryCrashDetail=function(c,d){if("trace"==c)return $("#stat-crash-chart").hide(),void $(".trace-detail").show();$(".trace-detail").hide(),$("#stat-crash-chart").show();var e={appid:getParam().appid,os:a.statPlat,crashid:a.statCurrentError.id,info:c};b.get(remoteURL+"crash/detail",{params:e}).success(function(a){$("#stat-crash-chart").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},credits:{enabled:!1},title:{text:""},tooltip:{formatter:function(){return this.key+": <b>"+this.y+"</b>"}},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}},series:[{type:"pie",name:d,data:a}]})})},a.showTraceDetail=function(){},l()}]),angular.module("statMod.api",["statMod"]),angular.module("statMod.api").config(["$routeProvider",function(a){a.when("/:statpageid",{templateUrl:"views/app-stat-api.html",controller:"APIQueryCtrl"}).when("/storage/:statpageid",{templateUrl:"views/app-stat-api.html",controller:"APIQueryCtrl"}).otherwise({redirectTo:"/_apiRequest"})}]),function(){"use strict";function a(a){a.apiStatCon={groupBy:"platform",apiChartType:"areaspline"},a.statDate={startTime:moment().subtract("days",6).toDate(),endTime:moment().toDate()}}angular.module("statMod.api").controller("APIQueryWrapperCtrl",["$scope",a])}(),angular.module("statMod.api").controller("APIQueryCtrl",["$scope","$http","$routeParams","$location","App","SchemaLoader","$timeout",function(a,b,c,d,e,f,g){function h(b,c){g(function(){a.statDate.startTime=b,a.statDate.endTime=c,i()},100)}function i(){d.path().indexOf("/storage")>-1?a.fileStat():k()}function j(a){var b={title:{text:"",x:0},xAxis:{type:"datetime",tickPixelInterval:200,labels:{formatter:function(){return moment(this.value).format("YYYY-MM-DD")},overflow:"justify",maxStaggerLines:1},minTickInterval:864e5},yAxis:{title:{text:""},min:0,allowDecimals:!1,gridLineColor:"#f4f1f1",labels:{}},credits:{enabled:!1},series:[{data:[],showInLegend:!1}],plotOptions:{areaspline:{fillOpacity:.4}},chart:{type:"areaspline",reflow:!0}};return b.tooltip={formatter:function(){return moment(this.x).format("YYYY-MM-DD")+":    <b>"+this.y+"</b>"}},a&&(b=$.extend(b,a)),b}function k(){var d=j(),e={from:moment(a.statDate.startTime).format("YYYYMMDD"),to:moment(a.statDate.endTime).format("YYYYMMDD")};"_apiRequest"!=c.statpageid&&(e.event_id=c.statpageid),a.isApiStat&&(d.chart.type=a.apiStatCon.apiChartType,"areaspline"===a.apiStatCon.apiChartType?(d.xAxis.type="datetime",d.series[0].pointInterval=864e5,d.series[0].pointStart=moment.utc(a.statDate.startTime).valueOf(),e.clazz=a.apiStatCon.clazz,e.platform=a.apiStatCon.platform):"pie"===a.apiStatCon.apiChartType&&(d.tooltip={formatter:function(){return this.key+":    <b>"+this.y+"</b>"}},e.group_by=a.apiStatCon.groupBy)),b({url:purl+"statistics/details",headers:getApiRequestHeader(a.currentApp.app_id,a.currentApp.app_key),params:e}).success(function(a){d.series[0].data=a.results,$("#chart-container").highcharts(d)})}new RegExp(["_push","_sms","storage"].join("|")).test(d.path())||(a.isApiStat=!0,f.fetch().then(function(b){a.clas=b})),a.$watch("apiStatCon",function(){a.currentApp&&i()},!0),a.loadByDate=h,a.maxTime=a.statDate.endTime,a.platform="",a.clazz="",a.groupBy="platform",a.pageId=c.statpageid,a.stat=i,a.fileStat=function(){var d={},e=c.statpageid,f=moment(a.statDate.startTime).format("YYYYMMDD"),g=moment(a.statDate.endTime).format("YYYYMMDD");d.item=e,d.from=f,d.to=g,"storageup"==e&&(d.item="apicall",d.type="put"),"storagedown"==e&&(d.item="apicall",d.type="get"),b.get(appurl+"/fileStats",{params:d}).success(function(b){var d,e=[],f=0;angular.forEach(b.results,function(a,b){0==f&&(d=b),f++,e.push(a)});var g=j();["space","transfer"].indexOf(c.statpageid)>-1&&(g.tooltip={formatter:function(){return moment(this.x).format("YYYY-MM-DD")+":    <b>"+bytesToSize(this.y)+"</b>"}},g.yAxis.labels.formatter=function(){return bytesToSize(this.value)}),g.series[0].data=e,g.series[0].pointStart=moment.utc(d,"YYYYMMDD").valueOf(),g.series[0].pointInterval=864e5,a.chartData=g,$("#chart-container").highcharts(a.chartData)})},a.apiStat=k,e.then(function(){i()})}]),angular.module("statMod.other",["appMod","statconfig","ngTable"]),angular.module("statMod.other").controller("EventFunnelCtrl",["$scope","$http","ngTableParams","$rootScope",function(a,b,c,d){function e(){a.tableParams?a.tableParams.reload():a.tableParams=new c({page:1,count:10},{total:0,getData:function(b,c){var d,e=(c.page()-1)*c.count(),f=c.count();c.orderBy().length&&(d=c.orderBy()[0]),a.loadFunnels(b,e,f).then(function(){})}})}a.funnelPlat="all",a.loadEvents=function(){var c={column:"event",appid:getParam().appid};c.os=a.funnelPlat,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.statEvents=b})},a.loadFunnels=function(a,c,e){return b.get(remoteURL+"funnels",{params:{appid:getParam().appid,os:"all",skip:c,limit:e}}).success(function(b){d.funnels=b,a.resolve(b)})},a.addFunnel=function(){b.post(remoteURL+"funnels",{appid:getParam().appid,name:a.statFunnel.name,steps:a.statFunnel.steps.join(",")}).success(function(){e(),$("#stat-add-funnel").modal("hide")})},a.deleteFunnel=function(a){b.delete(remoteURL+"funnels/"+a).success(function(){e()})},a.unvalidFunnelSteps=function(){var b=0;return angular.forEach(a.statFunnel.steps,function(a){a&&b++}),b>1?!1:!0},a.addNewEvent=function(){a.statFunnel.steps.push("")},a.removeEvent=function(b){a.statFunnel.steps.splice(b,1)},a.platSelect=function(a){d.statPlat=a,e()},a.funnelPlatSelect=function(b){a.funnelPlat=b,a.loadEvents()},a.pagestat=statConfig,a.statFunnel={},a.stepsNumMap=["一","二","三","四","五"],a.statFunnel.steps=new Array(2),a.tableDisplayFunc=a.pagestat.funnel_config.tableDisplayFunc||function(a,b){return b||(b="0"),b},a.tableLabels=a.pagestat.funnel_config.table,a.loadEvents(),e()}]),angular.module("statMod.other").factory("UserGroups",["$http","$q","$routeParams","$rootScope",function(a,b,c,d){var e={};return e.load=function(){var c=b.defer();return a.get(remoteURL+"usergroups",{params:{appid:getParam().appid,os:d.platSelect}}).success(function(a){for(var b=0;b<a.length;b++)a[b].defination=JSON.parse(a[b].defination);c.resolve(a)}),c.promise},e}]),angular.module("statMod.other").controller("UserGroupCtrl",["$scope","$http","$rootScope","UserGroups",function(a,b,c,d){d.load().then(function(b){a.userGroups=b}),a.deleteUserGroup=function(c){b.delete(remoteURL+"usergroups/"+c).success(function(){d.load().then(function(b){a.userGroups=b})})}}]),angular.module("statMod.other").controller("UserGroupCreateCtrl",["$scope","$http","ngTableParams","$rootScope","$routeParams","UserGroups",function(a,b,c,d,e,f){function g(){a.eventCondition={},a.userPush={},a.userPush.msgtype="text",a.userPush.pushTime=moment().format("YYYY-MM-DD HH:mm:ss"),a.userPush.expireTime=moment().format("YYYY-MM-DD HH:mm:ss"),"-1"!=e.groupid.trim()?angular.forEach(a.userGroups,function(b){if(b.id==e.groupid){a.currentUserGroup=b,a.currentUserGroup.os=b.platform,a.currentUserGroup.location=b.defination.location;var c=[];b.defination.weekly_active&&(c=Object.keys(b.defination.weekly_active)),a.currentUserGroup.weekyActive={},c.length&&(a.currentUserGroup.weekyActive.op=c[0],a.currentUserGroup.weekyActive.value=b.defination.weekly_active[c[0]]);var d=[];angular.forEach(a.currentUserGroup.defination.events,function(b){if(a.loadEventParam(b.event),b.attributes&&b.attributes.length)for(var c=0;c<b.attributes.length;c++)d.push({event:b.event,attribute:b.attributes[c].name,op:b.attributes[c].op.substring(1),value:b.attributes[c].value});else d.push({event:b.event})}),a.eventCondition[a.currentUserGroup.os]=d,a.queryEventUser()}}):(a.currentUserGroup={os:"ios"},a.eventCondition={ios:[{event:"",attribute:""}]}),a.eventParams={},a.loadEvents(),a.loadUserLocations(),a.$watch("currentUserGroup.os",function(){a.loadEvents()})}function h(){function b(a,b,c){if(a&&""!=a.trim()){var d={name:a};return b&&(d.op="$"+b,d.value=c),d}}var c=[],d=!1;return angular.forEach(a.eventCondition[a.currentUserGroup.os],function(a){if(a.event){for(var e=0;e<c.length;e++)if(c[e].event==a.event){d=!0;break}var f=b(a.attribute,a.op,a.value);d?f&&(c[e].attributes.length?c[e].attributes.push(f):c[e].attributes=[f]):c.push(f?{event:a.event,attributes:[f]}:{event:a.event})}}),c}a.opMap={eq:"等于",gt:"大于",lt:"小于"},a.currentStep=1,a.nextStep=function(){a.currentStep=2},f.load().then(function(b){a.userGroups=b,g()}),a.platSelect=function(b){a.currentUserGroup.os=b,a.eventCondition[b]||(a.eventCondition[b]=[{event:"",attribute:""}]),a.queryEventUser()},a.loadUserLocations=function(){var c={column:"locations",appid:getParam().appid};c.os=a.currentUserGroup.os,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.statUserLocations=b})},a.loadEvents=function(){var c={column:"event",appid:getParam().appid};c.os=a.currentUserGroup.os,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.statEvents=b})},a.loadEventParam=function(c,d){"undefined"!=typeof d&&(a.eventCondition[a.currentUserGroup.os][d].attribute="",a.eventCondition[a.currentUserGroup.os][d].op="",a.eventCondition[a.currentUserGroup.os][d].value="");var e={column:"event_params",event:c,appid:getParam().appid};e.os=a.currentUserGroup.os,b.get(remoteURL+"load_distinct_values",{params:e}).success(function(b){a.eventParams[c]=b})},a.addNewEventCondition=function(){a.eventCondition[a.currentUserGroup.os]?a.eventCondition[a.currentUserGroup.os].push({event:"",attributes:""}):a.eventCondition[a.currentUserGroup.os]=[{event:"",attributes:""}]},a.queryEventUser=function(){var c=h(),d={appid:getParam().appid,query:{events:c},limit:20};a.currentUserGroup.location&&(d.query.location=a.currentUserGroup.location),a.currentUserGroup.weekyActive&&a.currentUserGroup.weekyActive.op&&(d.query.weekly_active={},d.query.weekly_active[a.currentUserGroup.weekyActive.op]=a.currentUserGroup.weekyActive.value),d.query.platform=a.currentUserGroup.os,b.post(remoteURL+"user_search",d).success(function(b){a.eventUsers=b.hits,a.eventUserNum=b.total})},a.removeEvent=function(b){a.eventCondition[a.currentUserGroup.os].splice(b,1),a.queryEventUser()},a.saveUserGroup=function(){var c=remoteURL+"usergroups",d=a.currentUserGroup&&a.currentUserGroup.id,e="post";d&&(c=remoteURL+"usergroups/"+d,e="put");var f={appid:getParam().appid,os:a.currentUserGroup.os,name:a.currentUserGroup.name,defination:{events:h()}};a.currentUserGroup.location&&(f.defination.location=a.currentUserGroup.location),a.currentUserGroup.weekyActive&&a.currentUserGroup.weekyActive.op&&(f.defination.weekly_active={},f.defination.weekly_active[a.currentUserGroup.weekyActive.op]=a.currentUserGroup.weekyActive.value),b[e](c,f).success(function(){window.location.href="#/statconfig/usergroup"})},a.setCurrentUserDeviceId=function(b){a.currentDeviceId=b},a.pushmsg=function(){if(a.msg=$.trim(a.userPush.msg),""!=a.msg){if("json"==a.userPush.msgtype)try{data=JSON.parse(a.msg)}catch(c){return void showmsg("JSON 数据格式错误",AVC.Error)}else data={alert:a.msg};var d={data:data};if(1==a.userPush.pushTimeSelect){if(!moment(a.userPush.pushTime).isValid())return void showmsg("发送时间格式非法",AVC.Error);d.push_time=moment.utc(a.userPush.pushTime)}if(1==a.userPush.expireIntervalSelect){if(!moment(a.userPush.expireTime).isValid())return void showmsg("过期时间格式非法",AVC.Error);d.expiration_time=moment.utc(a.userPush.expireTime)}if(2==a.userPush.expireIntervalSelect){var e=1==a.userPush.expireUnit?60*a.userPush.expireNum*60:60*$scop.userPush.expireNum*60*24;d.expiration_interval=e}var f=h(),g={events:f};a.currentUserGroup.location&&(g.location=a.currentUserGroup.location),a.currentUserGroup.weekyActive&&a.currentUserGroup.weekyActive.op&&(g.weekly_active={},g.weekly_active[a.currentUserGroup.weekyActive.op]=a.currentUserGroup.weekyActive.value),g.platform=a.currentUserGroup.os,d.user_group_query=g,d._ApplicationId=a.currentApp.app_id,d._ApplicationKey=a.currentApp.app_key,d._MasterKey=a.currentApp.master_key,b({method:"POST",headers:{"Content-Type":"text/plain"},url:purl+"stats/push",data:d}).success(function(){showmsg("推送成功")}).error(function(a){showmsg(a.error,AVC.Error)})}}}]),angular.module("statMod.other").controller("StatUserActionCtrl",["$http","$scope",function(a,b){b.loadUserActions=function(c){c&&(b.currentDeviceId=c);var d={page:"浏览页面",event:"触发事件",session:"启动应用"};a.get(remoteURL+"user_action_details",{params:{did:b.currentDeviceId,limit:10,ts:b.userActions?b.userActions[b.userActions.length-1].ts:null,appid:getParam().appid}}).success(function(a){(!a||a.length<1)&&(b.nomoreUserActions=!0);angular.forEach(a,function(a){a.desc=a.name?d[a["action-type"]]+" "+a.name:d[a["action-type"]]}),b.userActions=b.userActions?b.userActions.concat(a):a})},b.loadUserActions()}]),angular.module("loginMod",["dashBoard"]),angular.module("loginMod").config(["$routeProvider",function(a){a.when("/signup",{templateUrl:"/signup.html",controller:"SignUpCtrl"}).when("/signin",{templateUrl:"/signin.html",controller:"SignUpCtrl"}).when("/apply",{templateUrl:"/apply.html",controller:"SignUpCtrl"}).when("/forgotpass",{templateUrl:"/forgotpass.html",controller:"SignUpCtrl"}).otherwise({redirectTo:"/signin"})}]),angular.module("loginMod").controller("SignUpCtrl",["$scope","$http","$route","$location",function(a,b,c,d){/login.html#\/signup/.test(window.location.href)&&window.ga&&ga("send","event","Login","VisitRegistry"),a.$watch("user",function(){a.user&&(/login.html#\/signup/.test(window.location.href)&&window.ga&&ga("send","event","Login","VisitRegistryWithSession"),d.path().indexOf("forgotpass")<0&&(window.location.href=rootpage))}),a.accept=!1,a.captchaurl=purl+"captcha?"+Math.random(),a.inputCoupon=getParam().refcode,a.changeCaptcha=function(){$("#captcha-wrapper").html("<img src='"+purl+"captcha??"+Math.random()+"'>")},a.signup=function(){if(a.accept){var c=$("#signupform input[name=email]").val(),d=$("#signupform input[name=password]").val(),e=$("#signupform input[name=username]").val(),f=$("#inputCoupon").val(),g={email:c,password:d,username:e};f&&(g.coupon=f),b.post(purl+"signup",g).success(function(){location.href=rootpage}).error(function(b){a.signuperror=203==b.code?["该邮箱已经存在，你可以直接 <a href='#/signin'>登录</a>，或 <a href='#/forgotpass'>找回密码</a>"]:[b.error]})}},a.validateCoupon=function(){var c=$("#inputCoupon");c.val()&&b.get(purl+"check-coupon/"+a.inputCoupon).success(function(b){a.couponValidate=b,a.couponValidate.hasVerified=!0}).error(function(){a.couponValidate={},a.couponValidate.hasVerified=!0})},getParam().refcode&&a.validateCoupon(),a.signin=function(){var c=$("#signinform input[name=email]").val(),d=$("#signinform input[name=password]").val();b.post(purl+"signin",{email:c,password:d}).success(function(){location.href=rootpage}).error(function(b){a.signinerror=[b.error]})},a.apply=function(){var c=$("#applyform input[name=email]").val(),d=$("#applyform input[name=company]").val(),e=$("#applyform input[name=title]").val(),f=$("#applyform [name=description]").val();b.post("/admin/1/applications",{email:c,company:d,title:e,description:f}).success(function(){a.applyerror=["申请成功，我们将在审核通过后发邮件到您的邮箱"]}).error(function(b){b.error&&"Email existed!"==b.error&&(a.applyerror=["该邮箱已经存在，你可以直接 <a href='#/signin'>登录</a>，或 <a href='#/forgotpass'>找回密码</a>"])})},a.deleteAlert=function(){a.signinerror=[],a.signuperror=[]},a.sendForgot=function(){var c=$("#forgotform input[name=email]").val(),d=$("#forgotform input[name=captcha]").val();b.post(purl+"resetPasswordForClient",{email:c,code:d}).success(function(){a.forgoterr=["申请成功！我们将发送重置密码邮件到您的邮箱。"]}).error(function(b){a.changeCaptcha(),a.forgoterr=[b.error]})}}]),angular.module("account.accountSer",["dashBoard.storageSer"]).factory("accountSer",["$http","$q","storageSer",function(a,b,c){return{signout:function(){var d=b.defer();return a.post(purl+"signout").success(function(){d.resolve(),c.removeAll()}),d.promise}}}]),angular.module("startMod",["dashBoard","appMod"]),angular.module("startMod").controller("StartCtrl",["$http","$scope","apps",function(a,b,c){b.links={android:{doc:"/docs/android_guide.html",demo:"/docs/sdk_down.html"},ios:{doc:"/docs/ios_os_x_guide.html",demo:"/docs/sdk_down.html"},js:{doc:"/docs/js_guide.html",demo:"/docs/sdk_down.html"},unity:{doc:"/docs/unity_guide.html",demo:"/docs/sdk_down.html"},wp:{doc:"/docs/dotnet_guide.html",demo:"/docs/sdk_down.html"}},b.apps=c,b.selectedPlat="ios",b.$watch("apps.all",function(){b.apps.all.length>0&&(b.SelectedApp=b.apps.all[0])}),b.$watch("SelectedApp",function(){b.SelectedApp&&(b.app_id=b.SelectedApp.app_id,b.app_key=b.SelectedApp.app_key)}),b.createApp=function(){a.post(purl+"clients/self/apps",{name:b.appname}).success(function(a){b.SelectedApp=a}).error(function(){})},b.docloaded=function(){}}]),angular.module("settingMod",["dashBoard","appMod"]),angular.module("settingMod").config(["$routeProvider",function(a){a.when("/setting/info",{templateUrl:"/setting_info.html"}).when("/setting/password",{templateUrl:"/setting_password.html"}).when("/setting/mail",{templateUrl:"/setting_email.html"}).when("/setting/self",{templateUrl:"/setting_self.html"}).when("/setting/team",{templateUrl:"/setting_team.html",controller:"SettingTeamCtrl"}).when("/setting/invite",{templateUrl:"/setting_invite.html",controller:"InviteUserCtrl"}).otherwise({redirectTo:"/setting/info"})}]),angular.module("settingMod").controller("SettingCtrl",["$scope","$http","Team","TeamMember",function(a,b){a.$watch("user.username",function(){a.user&&a.user.username&&(a.invite_url="http://leancloud.cn/login.html?refuser="+encodeURIComponent(a.user.username)+"#/signup")}),a.changePassword=function(){var a=$("#user-reset [name='prepass']").val(),c=$("#user-reset [name='newpass']").val(),d=$("#user-reset [name='newpass1']").val();return c!=d?void showmsg("新密码输入不一致",AVC.Error):void b.post(purl+"clients/self/changePassword",{old_password:a,new_password:c}).success(function(){showmsg("密码重置成功"),$("#user-reset").modal("hide")}).error(function(){})},a.verifyEmail={},a.changeEmail=function(){b.post(purl+"clients/self/changeEmailForClient",{new_email:a.verifyEmail.email,password:a.verifyEmail.password}).success(function(){showmsg("保存成功，我们将发确认邮件到您的新邮箱"),$("#user-reset-email").modal("hide")}).error(function(){})},a.setEmailOption=function(){b.post(purl+"clients/self",{accept_email:a.user.accept_email}).success(function(){$("#user-spec").modal("hide")})}}]),angular.module("settingMod").controller("InviteUserCtrl",["$scope","$http",function(a,b){a.inviteJoin=function(){for(var c=a.inviteEmails.split(/,|，/),d=0;d<c.length;d++)if(c[d]=c[d].trim(),!validateEmail(c[d]))return void showmsg("邮件格式有误",AVC.Error);b.post(purl+"invite",{emails:c.join(",")}).success(function(){showmsg("邀请发送成功")})}}]),angular.module("settingMod").controller("SettingUserDetailCtrl",["$scope","$http",function(a,b){a.getUserDetail=function(){b.get(purl+"clients/self/detail").success(function(b){a.userDetail={client_type:b.client_type,client_name:b.client_name,company:b.company,company_site:b.company_site,phone:b.phone,oicq:b.oicq,address:b.address,invoice_title:b.invoice_title}})},a.updateUserDetail=function(){a.userDetail.client_type&&(a.userDetail.client_type=parseInt(a.userDetail.client_type)),b.post(purl+"clients/self/detail",a.userDetail).success(function(){showmsg("开发者信息更新成功")})},a.getUserDetail()}]),angular.module("settingMod").controller("SettingInfoCtrl",["$scope","$http",function(a){a.getClientDetail=function(){},a.updateClientDetail=function(){}}]),angular.module("settingMod").controller("SettingTeamCtrl",["$scope","$http","Team","TeamMember",function(a,b,c){a.teams=[],a.loadTeams=function(){c.query(function(b){a.teams=b})},a.deleteTeamById=function(b){var d=new c;d.id=b,d.$delete(function(){for(var c=0;c<a.teams.length;c++)if(a.teams[c].id==b){a.teams.splice(c,1);break}})},a.setCurrentTeamId=function(b){a.teamId=b},a.loadTeams(),a.$on("modal.hide",function(){a.loadTeams()})}]),angular.module("settingMod").controller("SettingTeamInstanceCtrl",["$scope","$http","Team","TeamMember","$timeout",function(a,b,c,d,e){a.editteam={},a.currentTeam={},a.$watch("currentTeam.id",function(){a.teamaction="/1/clients/self/teams/"+a.currentTeam.id}),a.loadTeamMembersById=function(b){b=b||a.teamId,b&&-1!=b&&d.get({teamid:b},function(b){a.currentTeam.members=b.results})},a.getCooperatorByName=function(b){var c;return angular.forEach(a.tipTeamUsers,function(a){a.name==b&&(c=a)}),c},a.saveTeamName=function(){var b=new c;a.currentTeam&&(b.id=a.currentTeam.id),b.name=a.editteam.name,b.$save(function(b){b.client_id?(a.teams.push(b),a.currentTeam=b,a.loadTeamMembersById(b.id)):a.currentTeam.name=a.editteam.name}),$(".team-name-placeholder").show(),$(".team-name-update-form").hide()},a.updateTeamNamePlaceholder=function(){$(".team-name-placeholder").hide(),$(".team-name-update-form").show()},a.addTeamMemberPlaceholder=function(){$(".user-name-placeholder").hide(),$(".team-manage-form-add").show()},a.addTeamMember=function(){var b=new d;b.teamid=a.currentTeam.id;for(var c,e=0;e<a.tipTeamUsers.length;e++)if(a.tipTeamUsers[e].name==a.currentTeam.teamMemberName){c=a.tipTeamUsers[e].id;break}c&&(b.member_id=c,b.$save(function(){a.loadTeamMembersById(b.teamid)}),$(".team-manage-form-add").hide(),$(".user-name-placeholder").show())},a.removeTeamMember=function(b,c){var e=new d;e.teamid=b,e.memberid=c,e.$delete(function(){for(var b=0;b<a.currentTeam.members.length;b++)if(a.currentTeam.members[b].client_id==c){a.currentTeam.members.splice(b,1);break}})},a.queryClientsByName=function(c,d){return c&&""!=c.trim()?b.get(purl+"clients/find/like",{params:{type:d,name:c}}).then(function(b){return a.tipTeamUsers=b.data.results,b.data.results}):void 0},a.getTeam=function(){c.get({id:a.teamId},function(b){$.extend(a.currentTeam,b),a.editteam={},a.editteam.name=a.currentTeam.name})},a.uploadLogoCB=function(b,d){if(d&&b.length>0)try{b=JSON.parse(b),b.error?showmsg(b.error,AVC.Error):c.get({id:a.currentTeam.id},function(b){e(function(){$.extend(a.currentTeam,b)})})}catch(f){}},-1!=a.teamId&&(a.loadTeamMembersById(a.teamId),a.getTeam())}]),angular.module("billMod",["dashBoard","appMod"]),angular.module("billMod").config(["$routeProvider",function(a){a.when("/bill",{templateUrl:"/setting_bill.html",controller:"SettingBillCtrl"}).when("/bill/general",{templateUrl:"views/bill_general.html",controller:"BillGeneralCtrl"}).when("/bill/charge",{templateUrl:"views/bill_charge.html",controller:"ChargeCtrl"}).when("/bill/record",{templateUrl:"views/bill_charge_record.html",controller:"BillChargeCtrl"}).when("/bill/coupons",{templateUrl:"views/bill_coupons.html",controller:"ChargeCtrl"}).when("/bill/detail/:billid",{templateUrl:"/setting_bill_detail.html",controller:"SettingBillDetailCtrl"}).when("/bill/invoice",{templateUrl:"/views/bill_invoice.html",controller:"BillInvoiceCtrl"}).otherwise({redirectTo:"/bill"})}]),angular.module("billMod").controller("BillCtrl",["$scope","$http",function(a){a.userpay={selectedPay:"alipay"},a.pays=[{value:"alipay",img:"alipay-v2.png",title:"支付宝"}],a.$watch("userpay.selectedPay",function(){a.userpay.selectedPay&&angular.forEach(a.pays,function(b){b.value==a.userpay.selectedPay&&(a.currentCharge=b)})}),a.getBillNumStr=function(a){return a>=1e9?(a/1e9).toFixed(1).replace(/\.0$/,"")+"b":a>=1e6?(a/1e6).toFixed(1).replace(/\.0$/,"")+"m":a>=1e3?(a/1e3).toFixed(1).replace(/\.0$/,"")+"k":a},a.getBillBytesToSize=function(a){if(0==a)return"0";var b=["字节","KB","MB","GB","TB","PB","EB","ZB","YB"],c=1024,d=parseInt(Math.floor(Math.log(a)/Math.log(c)));return 0==d?a+" "+b[d]:(a/Math.pow(c,d)).toFixed(1)+" "+b[d]},a.getBillBytesToGig=function(a){return a>=1e9?(a/1e9).toFixed(2).replace(/\.0$/,"")+" GB":a>=1e6?(a/1e6).toFixed(2).replace(/\.0$/,"")+" MB":a>=1e3?(a/1e3).toFixed(2).replace(/\.0$/,"")+" KB":a+" 字节"},a.getBillUsage=function(a,b){var c=(b/a*100).toFixed(2);return c>100?100:c}}]),angular.module("billMod").controller("BillGeneralCtrl",["$scope","$http",function(a,b){a.getBillGeneralInfo=function(){b.get(purl+"payment/money-account").success(function(b){a.billGeneral=b})},a.getBillGeneralInfo()}]),angular.module("billMod").controller("ChargeCtrl",["$scope","$http",function(a,b){a.createCharge=function(){a.chargeConfirmForm={},b.post(purl+"payment/prepaid-order",{amount:a.userpay.chargeValue}).success(function(b){a.chargeConfirmForm=b})},a.confirmToPay=function(){$("#charge_modal").modal("hide"),$("#charge_confirm_modal").modal("show")},a.finishPay=function(){$("#charge_confirm_modal").modal("hide"),setTimeout(function(){location.href="/bill.html#/bill/general"},1e3)},a.useCode=function(){b.post(purl+"payment/coupon-charge ",{code:a.chargeCode}).success(function(){a.codeChargeError="",a.codeChargeSuccess='充值成功, <a href="#/bill/general"> 查看账户</a> '}).error(function(b){a.codeChargeSuccess="",a.codeChargeError=b.error})}}]),angular.module("billMod").controller("SmsPayCtrl",["$scope","$http","$timeout","$window",function(a,b){a.smsPay={type:"alipay"},a.createSmsPayForm=function(){a.smsPayForm={},"alipay"==a.smsPay.type&&b.post(purl+"payment/item-order",{quantity:a.smsPay.quantity,item:1}).success(function(b){a.chargeConfirmForm=b})},a.confirmToBuySms=function(){"alipay"===a.smsPay.type?$("#sms_pay_form").submit():"account"==a.smsPay.type&&b.post(purl+"payment/buy-item",{item:1,quantity:a.smsPay.quantity}).success(function(){showmsg('购买短信成功，返回 <a href="/bill.html#/bill/general">财务概况</a> 查看')}),$("#sms_pay_modal").modal("hide"),"alipay"==a.smsPay.type&&$("#charge_confirm_modal").modal("show")},a.finishPay=function(){$("#charge_confirm_modal").modal("hide"),$timeout(function(){$window.location.href="/bill.html#/bill/general"},1e3)}}]),angular.module("billMod").controller("ChargeCallbackCtrl",["$scope","$http",function(a,b){a.getCharge=function(c){c=c||getParam().chargeid,b.get(purl+"payment/prepaid-order/"+c).success(function(b){a.chargeCallbackInfo=b})},a.getCharge()}]),angular.module("billMod").controller("BillChargeCtrl",["$scope","$http",function(a,b){a.getChargeRecords=function(c){c=c||1,b.get(purl+"payment/transactions",{params:{tx_type:c}}).then(function(b){angular.forEach(b.data,function(a){a.created_short=moment(""+a.created,"YYYY-MM-DD").format("YYYY-MM-DD")}),a.billCharges=b.data})},a.getChargeRecords(1),a.getChargeRecordsAll=function(){b.get(purl+"payment/transactions").then(function(b){angular.forEach(b.data,function(a){a.created_short=moment(""+a.created,"YYYY-MM-DD").format("YYYY-MM-DD")}),a.billCharges=b.data})},a.getChargeRecordsAll()}]),angular.module("billMod").controller("SettingBillCtrl",["$scope","$http",function(a,b){a.loadBills=function(){b.get(purl+"clients/self/bills").success(function(b){angular.forEach(b,function(a){a.bfill_date=moment(""+a.bill_date,"YYYYMM").format("YYYY - MM")}),a.bills=b})},a.loadBills()}]),angular.module("billMod").controller("SettingBillDetailCtrl",["$scope","$http","$routeParams",function(a,b,c){b.get(purl+"clients/self/bills/"+c.billid).success(function(b){b.total.bill_date=moment(""+b.total.bill_date,"YYYYMM").format("YYYY-MM"),a.billDetail=b})}]),angular.module("billMod").controller("BillInvoiceCtrl",["$scope","$http","$routeParams",function(a,b){function c(){b.get(purl+"clients/self/invoices/restMoney").success(function(b){a.invoiceTip||(a.invoice.usable=!0),a.invoice.available=b.amount,b.amount<=0&&(a.invoice.usable=!1)}).error(function(){a.invoice.usable=!1})}function d(){b.get(purl+"clients/self/detail").success(function(b){b.address&&b.phone&&b.invoice_title||(a.invoiceTip=!0),a.invoice.address=b.address,a.invoice.phone=b.phone,a.invoice.invoice_title=b.invoice_title}),c()}a.invoice={usable:!1},a.requestInvoice=function(){b.post(purl+"clients/self/invoices",{amount:a.invoice.amount}).success(function(){showmsg("申请发票成功"),c()}).error(function(){})},d()}]),function(){angular.module("devComponentMod",["appMod","devComponent.service","ngTable"]);var a=angular.module("devComponentMod");angular.module("devComponentMod").config(["$routeProvider",function(a){a.when("/component/feedback",{templateUrl:"views/component-feedback.html",controller:"FeedbackCtrl"}).when("/component/custom_param",{templateUrl:"views/app-stat-custom.html",controller:"CustomParamCtrl"}).when("/component/appsearch",{templateUrl:"views/app-search-set.html",controller:"AppSearchURLCtrl"}).when("/component/sns",{templateUrl:"views/sns-set.html",controller:"SnsCtrl"}).otherwise({redirectTo:"/component/feedback"})}]),angular.module("devComponentMod").controller("CustomParamCtrl",["$http","$scope","App",function(a,b,c){b.statCustomParams={},c.then(function(){b.currentApp&&b.currentApp.stats_kvs&&(b.statCustomParams=b.currentApp.stats_kvs)}),b.setCurrentStatParam=function(a,c){b.statParam={name:a,value:c.value,desc:c.desc,prename:a}},b.updateStatCustomParam=function(c,d,e,f){return c=c||b.statParam.prename,d=d||b.statParam.name,f=f||b.statParam.desc,e=e||b.statParam.value,d?e?(b.statCustomParams[d]={value:e,desc:f},c&&c!=d&&delete b.statCustomParams[c],$("#stat-edit-custom-params").modal("hide"),void a.put(purl+"clients/self/apps/"+b.app.app_id,{stats_kvs:JSON.stringify(b.statCustomParams)}).success(function(){})):void showmsg("参数值不能为空",AVC.Error):void showmsg("参数名不能为空",AVC.Error)
},b.deleteStatCustomParam=function(c){delete b.statCustomParams[c],a.put(purl+"clients/self/apps/"+b.app.app_id,{stats_kvs:JSON.stringify(b.statCustomParams)}).success(function(){})},b.addStatCustomParam=function(){b.statParam={name:"",value:"",desc:""}}}]),a.controller("AppSearchURLCtrl",["$scope","$http","App","SchemaLoader",function(a,b,c){a.appSearch={uri_host:"avoscloud"},a.appSearchConfig={},c.then(function(b){a.appSearch.app_name=b.app_name});var d=purl+"data/apps/"+getParam().appid+"/deeplink",e=purl+"data/apps/"+getParam().appid;a.saveSearchURL=function(){b.post(d,a.appSearch).success(function(){showmsg("操作成功")})},a.getSearchURL=function(){b.get(d).success(function(b){angular.forEach(b,function(c,d){c&&(a.appSearch[d]=b[d])})})},a.saveSearchClaConfig=function(c){b.post(e+"/"+c+"/search",{enable:a.appSearchConfig[c]}).success(function(){})},a.getSearchURL()}])}(),function(){var a=angular.module("devComponentMod");a.controller("FeedbackCtrl",["$http","$scope","ngTableParams","App",function(a,b,c,d){var e={};d.then(function(){e.headers={"X-AVOSCloud-Application-Id":b.currentApp.app_id,"X-AVOSCloud-Application-Key":b.currentApp.app_key},b.queryPagination()}),b.queryPagination=function(){b.tableParams?b.tableParams.reload():b.tableParams=new c({page:1,count:10},{total:1,getData:function(a,c){var d=(c.page()-1)*c.count(),e=c.count(),c={};c.skip=d,c.limit=e,c.order="-updatedAt",b.getFeedbackList(c).then(function(b){a.resolve(b.data.results)})}})},b.nextPage=function(){var a=b.tableParams.$params.page;b.tableParams.page(a+1)},b.prePage=function(){var a=b.tableParams.$params.page;b.tableParams.page(a-1)},b.getFeedbackList=function(b){return a({method:"GET",url:purl+"feedback",headers:e.headers,params:b})},b.setCurrentFeedback=function(a){b.feedback=a},b.updateFeedbackStatus=function(c,d){a({method:"PUT",url:purl+"feedback/"+c,headers:{"X-AVOSCloud-Application-Id":b.currentApp.app_id,"X-AVOSCloud-Application-Key":b.currentApp.app_key},data:{status:d}}).success(function(){b.queryPagination()})},b.deleteFeedback=function(c){a({method:"DELETE",url:purl+"feedback/"+c,headers:{"X-AVOSCloud-Application-Id":b.currentApp.app_id,"X-AVOSCloud-Application-Key":b.currentApp.app_key}}).success(function(){b.queryPagination()})}}]),a.controller("FeedbackCommentCtrl",["$http","$scope",function(a,b){function c(c){a({method:"POST",url:purl+"feedback/"+b.feedback.objectId+"/threads",headers:{"X-AVOSCloud-Application-Id":b.currentApp.app_id,"X-AVOSCloud-Application-Key":b.currentApp.app_key},data:c}).success(function(){b.feedbackContent="",$("#feedback-file").val(""),b.getComments()})}b.getComments=function(){return a({method:"GET",url:purl+"feedback/"+b.feedback.objectId+"/threads",headers:{"X-AVOSCloud-Application-Id":b.currentApp.app_id,"X-AVOSCloud-Application-Key":b.currentApp.app_key}}).success(function(a){a.results.unshift({type:"user",content:b.feedback.content,attachment:b.feedback.attachment,updatedAt:b.feedback.updatedAt}),b.feedback.comments=a.results})},b.sendFeedback=function(){var a={type:"dev"};a.content=b.feedbackContent;var d=$("#feedback-file")[0];if(d.files.length>0){var e=d.files[0],f=new AV.File(e.name,e);f.save().then(function(b){a.attachment=b._url,c(a)})}else c(a)},b.getComments()}])}(),function(){var a=angular.module("devComponent.service",[]);a.factory("Feedback",["$resource","$q","$routeParams",function(a){return a(purl+"feedback/:id",{id:"@id"},{})}])}(),function(){"use strict";function a(a,b,c){b.snsplats={qq:{},weixin:{},weibo:{}},b.list=function(){c.query().$promise.then(function(a){angular.forEach(a,function(a){b.snsplats[a.platform]=a})})},b.save=function(a){var d=b.snsplats[a],e=new c({platform:a,platform_key:d.platform_key,platform_secret:d.platform_secret,platform_scope:d.platform_scope,id:d.id});e.id?e.$update(function(){b.list()}):e.$save(function(){b.list()})},b.list()}angular.module("devComponentMod").factory("Sns",["$resource",function(a){var b=purl+"clients/self/apps/:app_id/snsConfigs/:id";return a(b,{app_id:getParam().appid,id:"@id"},{update:{method:"PUT"}})}]),angular.module("devComponentMod").controller("SnsCtrl",["$http","$scope","Sns",a])}(),function(){"use strict";angular.module("statConfigMod",["statConfigMod.channelctrl","statConfigMod.datactrl","statConfigMod.reportctrl"]),angular.module("statConfigMod").config(["$routeProvider",function(a){a.when("/statconfig/report",{templateUrl:"views/app-stat-report.html",controller:"analyticsReportSetting"}).when("/statconfig/channels",{templateUrl:"views/app-stat-channels.html",controller:"analyticsDataSetting"}).when("/statconfig/generate_channel",{templateUrl:"views/stat-channel-generate.html",controller:"analyticsDataSetting"})}])}(),angular.module("statConfigMod.datactrl",[]).controller("analyticsDataSetting",["$scope","$rootScope","$http","$location",function(a,b,c,d){a.statTransConfig="6",a.$watch("app",function(){a.app&&(a.stat_open=a.app.enable_stats),a.app&&a.app.stats_send_policy&&(a.statTransConfig=a.app.stats_send_policy)}),a.saveTransConfig=function(){c.put(purl+"clients/self/apps/"+a.app.app_id,{stats_send_policy:a.statTransConfig}).success(function(){showmsg("保存成功")})},a.saveSDKConfig=function(){c.put(purl+"clients/self/apps/"+a.app.app_id,{enable_stats:a.stat_open}).success(function(){showmsg("保存成功")})},a.saveAppDownURL=function(){c.put(purl+"clients/self/apps/"+a.app.app_id,{stats_download_url:a.app.stats_download_url}).success(function(){showmsg("保存成功")})},a.loadStatCustomChannel=function(){c.get(purl+"stats/apps/"+getParam().appid+"/channels").success(function(b){a.statCustumChannels=b})},a.addStatCustomChannel=function(){c.post(purl+"stats/apps/"+a.app.app_id+"/channels",{name:a.statChannel.name}).success(function(){$("#stat-edit-channels").modal("hide"),a.loadStatCustomChannel()})},a.deleteStatCustomChannel=function(b){var d=window.confirm("删除渠道将无法再看到该渠道相关的统计数据");d&&c.delete(purl+"stats/apps/"+a.app.app_id+"/channels/"+b).success(function(){a.loadStatCustomChannel()})},/\/channels$/.test(d.path())&&a.loadStatCustomChannel()}]),angular.module("statConfigMod.reportctrl",[]).controller("analyticsReportSetting",["$scope","$http",function(a,b){var c=remoteURL+"apps/"+getParam().appid+"/report_subcribers";a.getReportState=function(){b.get(c).success(function(b){a.statReportConfig=b})},a.updateReportState=function(){b.post(c,a.statReportConfig)},a.getReportState()}]),angular.module("statConfigMod.channelctrl",[]).controller("analyticsChannelSetting",["$scope","$http",function(a,b){var c=remoteURL+"apps/"+getParam().appid+"/channel_accounts";a.statPlat="ios",a.setOS=function(b){a.statPlat=b},a.$watch("statPlat",function(){a.getAllChannels(),a.getGeneratedChannels()}),a.getGeneratedChannels=function(){var d={};d.os=a.statPlat,b.get(c,{params:d}).success(function(b){a.allGeneratedChannels=b})},a.getAllChannels=function(){var c={column:"channel",appid:getParam().appid};c.os=a.statPlat,b.get(remoteURL+"load_distinct_values",{params:c}).success(function(b){a.allchannels=b,a.allchannels.length&&(a.generateChannel=a.allchannels[0])})},a.generateChannelFunc=function(d){if(d=d||a.generateChannel){var e={};e.os=a.statPlat,b.post(c+"/"+d,e).success(function(){a.getGeneratedChannels(),$("#stat-generate-channel").modal("hide")})}},a.deleteGeneratedChannel=function(d){var e={};e.os=a.statPlat,b.delete(c+"/"+d,{params:e}).success(function(){a.getGeneratedChannels()})}}]),angular.module("infoCenterMod",["appMod","infoCenterMod.ser","infoCenterMod.ctrl"]).config(["$routeProvider","$httpProvider",function(a){a.when("/index",{templateUrl:"views/info-center/index.html",controller:"infoCenter"}).otherwise({redirectTo:"/index"})}]),angular.module("infoCenterMod.ctrl",[]).controller("infoCenter",["$scope","infoCenterSer","storageSer",function(a,b){function c(b){var c=[];$.each(d,function(a,d){d.category===b&&c.push(d)}),a.infoList=c}var d=[];a.infoList=[];var e=[];b.getNotification().then(function(c){d=c,e=b.getInfoCategory(),a.infoList=d,a.category=[{id:-1,title:"全部",isClicked:!0,count:a.infoList.length},{id:5,title:e[5].title,isClicked:!1,count:e[5].count},{id:1,title:e[1].title,isClicked:!1,count:e[1].count},{id:3,title:e[3].title,isClicked:!1,count:e[3].count},{id:4,title:e[4].title,isClicked:!1,count:e[4].count},{id:2,title:e[2].title,isClicked:!1,count:e[2].count},{id:0,title:e[0].title,isClicked:!1,count:e[0].count}]}),a.switchCategory=function(b){-1===b.id?a.infoList=d:c(b.id)}}]),angular.module("infoCenterMod.ser",[]).factory("infoCenterSer",["$rootScope","$http","$q","configSer",function(a,b,c,d){var e=[],f=function(){e=[{title:"其它",count:0},{title:"财务相关",count:0},{title:"协作",count:0},{title:"网站更新",count:0},{title:"工具提示",count:0},{title:"告警信息",count:0}]};return{getInfoCategory:function(){return e},getNotification:function(){var a=c.defer();return b.get(d.apiUrl+"/sitenotifications",{params:{skip:0,limit:200}}).success(function(b){f(),$.each(b,function(a,b){b.time=new Date(b.created.iso).toISOString().substring(0,10),e[b.category].count++}),a.resolve(b)}),a.promise}}}]);